/*
Copyright(c) 2012 CeRTAE
*/
function verifyMeta(j,b,g){var c=_MetaObjects[b];var f,k,h,d,a;if(!c){return j}if(c.lists&&(_SM.typeOf(c.lists)=="array")){for(a in c.lists){k=c.lists[a];if(typeof(k)!="string"){continue}f=_MetaObjects[k]||{};j[k]=_SM.verifyList(j[k],f.prpDefault);if(g){h={text:k,__ptType:k,__ptConfig:{__ptType:k},children:[]};g.children.push(h)}}}if(c.objects&&(_SM.typeOf(c.objects)=="array")){for(a in c.objects){k=c.objects[a];if(typeof(k)!="string"){continue}d=j[k];if(_SM.typeOf(d)!="object"){d={}}if(g){h=getNodeBase(k,k,{__ptType:k});g.children.push(h);j[k]=verifyMeta(d,k,h)}else{j[k]=verifyMeta(d,k)}}}return j}function clearPhantonProps(c,d){var a=_MetaObjects[d]||{};for(var b in c){if(!a.properties){continue}if(!(b in _SM.objConv(a.properties.concat(["name","__ptValue","__ptList","__ptType"])))){delete c[b]}}return c}_versionMeta="14.0201";_MetaObjects={pcl:{description:"Meta definition",properties:["viewCode","viewEntity","viewIcon","description","shortTitle","localSort","pageSize","sheetSelector","pciStyle","helpPath","idProperty","jsonField","returnField","updateTime","metaVersion","userVersion","protoEntity","protoEntityId","pciType"],objects:["gridConfig","gridSets","formConfig","usrDefProps","custom","businessRules"],lists:["fields","fieldsBase","fieldsAdm","actions","detailsConfig","sheetConfig"],roProperties:["viewEntity","idProperty","updateTime","metaVersion","protoEntity","protoEntityId"]},fields:{description:"Store fields definition",listOf:"field"},fieldsBase:{description:"Base store fields definition",listOf:"field"},fieldsAdm:{description:"Admin store fields definition",listOf:"field"},field:{description:"A store field element",properties:["name","required","prpLength","prpScale","prpDefault","fieldLabel","format","header","sortable","searchable","flex","tooltip","cellLink","wordWrap","primary","crudType","readOnly","hidden","choices","fkId","fkField","cellLink","zoomModel","zoomFilter","zoomMultiple","cpFromField","cpFromZoom","physicalName","type","xtype","vType"],roProperties:[]},formField:{description:"A field element",properties:["name","tooltip","fieldLabel","labelWidth","labelAlign","hideLabel","required","readOnly","hidden","prpDefault","format","prpLength","collapsed","choices","fkId","fkField","zoomModel","zoomFilter","zoomMultiple","cellLink","type","xtype","vType"],roProperties:["type "]},gridConfig:{description:"Grid configuration properties",properties:["hideRowNumbers","gridSelectionMode","exportCsv","hideSheet","denyAutoPrint","filterSetABC","groupCol"],lists:["listDisplay","baseFilter","initialFilter","initialSort","searchFields","sortFields","hiddenFields","readOnlyFields"],objects:[]},colShortcuts:{description:"Column configuration shortcuts",lists:["searchFields","sortFields","hiddenFields","readOnlyFields"]},gridSets:{description:"Additional settings ( filters, sorters, userViews )",lists:["listDisplaySet","filtersSet","sortersSet"]},custom:{description:"custom user configurations",lists:["listDisplay","listDisplaySet","filtersSet","sortersSet"]},baseFilter:{description:'Default defined filter. No user-modifiable, e.g. { "status__exact":"0" } ',listOf:"filterDef",allowAdd:true},customFilter:{description:"Predefined filter ",listOf:"filterDef",allowAdd:true},initialFilter:{description:'Initial filter  Ej: { "status__exact":"0" } ',listOf:"filterDef",allowAdd:true},initialSort:{description:'Default ordering  Ej: [{"direction":"ASC","property":"code"}, ... ] ',listOf:"sorterDef",allowAdd:true},sorterDef:{description:"Sort definition",addPrompt:"Please enter the name of the property for your sorter:",allowDel:true,nodeName:"property",properties:["property","direction"]},sortersSet:{description:"Sorter set",listOf:"sortersSetDef",allowAdd:true},sortersSetDef:{description:"Sorter set definition",addPrompt:"Please enter the name of the sorter:",allowDel:true,properties:["name","description"],lists:["customSort"]},customSort:{description:"User ordering",listOf:"sorterDef",allowAdd:true},filterDef:{description:"Predefined filter definition",addPrompt:"Please enter the name of the property for your filter:",allowDel:true,nodeName:"property",properties:["property","filterStmt"]},filtersSet:{description:"Predefined filter set ( *x*, ><=, !=,  aa:bb ) ",listOf:"filtersSetDef",allowAdd:true},filtersSetDef:{description:"Filter set definition",addPrompt:"Please enter the name of the filterSet:",allowDel:true,properties:["name","menuText"],lists:["customFilter"]},listDisplaySet:{description:"Alternative configuration for the grid ( it appears under the icon 'ViewCols' of the main bar )",listOf:"listDisplayDef",allowAdd:true},listDisplayDef:{description:"Predefined column set (view)",addPrompt:"Please enter the name of the columnSet:",allowDel:true,properties:["name","hideRowNumbers","description"],lists:["listDisplay"]},hiddenFields:{description:"List of hidden fields",__ptStyle:"colList"},listDisplay:{description:"List of fields to display in the grid",addPrompt:"Please enter the name for your alternative listDisplay:",__ptStyle:"colList"},readOnlyFields:{description:"List of fields to marked as ReadOnly ( the property ReadOnly can also be used )",__ptStyle:"colList"},searchFields:{description:"Search-enabled fields",__ptStyle:"colList"},sortFields:{description:"Order-enabled fields",__ptStyle:"colList"},detailsConfig:{description:"Details definition (Master-Detail relationship)",listOf:"detailDef",allowAdd:true},detailDef:{description:"Master-Detail relationship definition",properties:["menuText","conceptDetail","masterField","detailField","detailName","detailTitleLbl","masterTitleField","detailTitleField"],addPrompt:"Please enter the name for your detail:",allowDel:true},usrDefProps:{description:"User defined properties ( Fields created by the user, they do not participe in search and sort)",properties:["udpTable","propertyRef","keyField","propertyPrefix","propertyName","propertyValue"]},sheetConfig:{description:"Information templates in HTML that are fed by data from the database",listOf:"sheetDef",allowAdd:true},sheetDef:{description:"Templates definition ( the name is the selector )",properties:["name","template","title","viewIcon","sheetType","templateFp","templateBb","templateEr","templateAb","templateLp"],lists:["sheetDetails"],addPrompt:"Please enter the name for your sheet:",allowDel:true},sheetDetails:{description:"Lista de detalles por hoja ( sheet )",listOf:"sheetDetail",allowAdd:true},sheetDetail:{description:"Sheet detail configuration",properties:["name","detailName","detailSort","templateBb","templateEr","templateAb"],lists:["sheetDetails"],addPrompt:"Please enter the detailName:",allowDel:true},formConfig:{hideItems:true,description:"Form definition",properties:["title","tooltip","height","maxHeight","minHeight","width","maxWidth","minWidth","viewIcon","helpPath"]},fieldset:{hideItems:true,description:"A Fieldset, containing field elements",properties:["title","fsLayout","autoscroll","border","collapsible","collapsed","labelWidth","labelAlign","hideLabel","height","maxHeight","minHeight"]},htmlset:{hideItems:true,description:"A Fieldset, containing HtmlField elements",properties:["title","collapsible","collapsed","flex","height","maxHeight","minHeight"]},protoGrid:{description:"A detail grid",properties:["viewCode","menuText","height","maxHeight","minHeight","minWidth"]},detailButton:{description:"A button link to detail",properties:["viewCode","text","addDetailForm"]},panel:{hideItems:true,description:"A simple panel with fit layout",properties:["title","height","maxHeight","minHeight"]},tabpanel:{hideItems:true,description:"A Tab Container with many tabs",properties:["layout","activeItem","height","maxHeight","minHeight"]},actions:{description:"Actions list (Actions menu)",listOf:"actionDef",allowAdd:true},actionDef:{description:"Actions definition (backend)",properties:["name","title","actionType","selectionMode","refreshOnComplete"],lists:["actionParams"],addPrompt:"Please enter the name for your action:",allowDel:true},actionParams:{description:"Actions definition parameters",listOf:"actionParam",allowAdd:true},actionParam:{properties:["name","tooltip","fieldLabel","prpDefault","required","readOnly","format","choices","fkId","fkField","zoomModel","zoomFilter","cellLink","type","xtype","vType"],addPrompt:"Action parameter",allowDel:true},businessRules:{properties:["dblClick","afterCellUpdate","afterRowDelete","afterSave","beforeCellEdit","beforeCellUpdate","beforeRowDelete","beforeRowInsert","beforeOpSave","beforeValidate","zoomConfigure","zoomReturn","issRowLoad","reposition","getLinkFilter","validationComplete"]},businessRule:{properties:["name","handler","src","type","field"],addPrompt:"Action parameters",allowDel:true},businessRulesText:{description:"Business rules",properties:["afterCellUpdate","afterRowDelete","BeforeCellEdit","BeforeCellUpdate","BeforeRowDelete","BeforeRowInsert","dblClick","issZoomConfigure","issBeforeVslidateVr","issHelpReturn","issRowLoad","reposition","getLinkFilter","afterOpSave","beforeOpSave","issValidationComplete"]}};function getSimpleProperties(g,c){if(_SM.typeOf(g)=="array"){return[]}var b={},a;if(c){b.__ptType=c}for(var d in g){a=g[d];if(_SM.typeOf(a) in _SM.objConv(["object","array"])){continue}if(d in _SM.objConv(["__ptValue","__ptList"])){try{b=Ext.decode(a)}catch(f){}}else{a=verifyPrpType(d,a);if(a){b[d]=a}}}return b}function verifyPrpType(c,b){var a=_MetaProperties[c+".type"];if(!a){if(typeof(b)=="string"){return b.replace(/~+$/,"")}else{return b}}if(a==typeof(b)){return b}switch(a){case"boolean":if((typeof(b)=="number")){b=b.toString()}if((typeof(b)=="string")){if(b.substr(0,1).toLowerCase() in _SM.objConv(["y","s","1","o","t"])){return true}else{return false}}else{return false}case"number":return parseFloat(b);case"null":return null;default:return b}}_MetaProperties={"metaVersion.help":"Internal meta version","userVersion.help":"Application version","exportCsv.help":"Csv export enabled?","exportCsv.type":"boolean","localSort.help":"local sort?, (n/a for prototypes)",localSorttype:"boolean","pageSize,help":"Page size","pageSize.type":"number","qbeHelp.type":"boolean","qbeHelp.help":"visible trigger for select distinct (interne)","required.type":"boolean","readOnly.type":"boolean","primary.type":"boolean","viewEntity.help":"Backend model (Django)","viewCode.help":"Definicion de view code -  app.model.view","description.help":"Description","viewIcon.help":"iconName  (css name)","shortTitle.help":"Menu and form title","idProperty.help":"Id property (future use)","protoEntity.help":"Default prototype entity ( prototype.protoTable.xxx )  (Internal use with protoEntityId)",pciStyle:"grid","pciStyle.help":"Presentation mode [ form,  grid, tree]","pciStyle.choices":["grid","form","tree"],"gridSelectionMode.choices":["multi","simple","single"],"gridSelectionMode.help":"multi*: multiple selection with check; simple: selection on/off ; single: Last selected","denyAutoPrint.type":"boolean","denyAutoPrint.help":"deny auto print (future use)",masterField:"pk","menuText.help":"Menu title ( toolbar )","detailName.help":"Detail key (for report detail)","conceptDetail.help":"Detail concept ( [App.]Model o [App.]Model.View )","masterField.help":"Master field for MD navigation (normaly Pk)","detailField.help":"Detail field for filter (normaly conceptName)","detailTitleLbl.help":"Detail title for filter","masterTitleField.help":"Master field title (filter name)","detailTitleField.help":"Master field title (copy from master title in detail edition)",propertyPrefix:"udp","propertyPrefix.help":"udp prefix (upd__xxxxx)","propertyName.help":"udp property name","propertyValue.help":"udp property value","propertyRef.help":"udp concept ref","keyField.help":"udp source<br>** Only for non MD udp (internal use)","udpTable.help":"udp concept name , <strong>** if direct link then related_name, normaly udpTable</strong>","sheetSelector.help":"field sheet selecto, null for DEFAULT sheet","template.help":"template definition","templateFp.help":"Templante FirstPage","templateLp.help":"Templante LastPage","templateBb.help":"Templante BeforeBlock","templateAb.help":"Templante AfterBlock",templateBb:"<spam>------------------------------------</spam><br>",templateAb:"<spam>====================================</spam><br>","templateEr.help":"EveryRow",templateFp:'<!DOCTYPE html><html><head><meta content="text/html; charset=UTF-8" http-equiv="Content-Type" /><link href="/static/css/print.css" rel="stylesheet" type="text/css" media="screen,print" /><title>PtReport : {{reportTitle}}</title></head><body>',templateLp:"</body></html>",direction:"sort order","direction.choices":["ASC","DESC"],"physicalName.help":"phisical name or function  @str( f1,f2 )",required:false,"required.help":"Required field","allowDecimals.help":"Dont use!!! : allow decimal (internal use)",autoscroll:true,"autoscroll.help":"t/f","choices.help":"comma separed values for combo selection",collapsed:false,"collapsed.help":"t/f collapsed","collapsed.type":"boolean",zoomMultiple:false,"zoomMultiple.type":"boolean","zoomMultiple.help":"Multiple selection on add",collapsible:false,"collapsible.help":"t/f","collapsible.type":"boolean","cellToolTip.help":"Use this field form line tooltip","cellToolTip.type":"boolean","cellLink.help":"Is a cellLink?","cellLink.type":"boolean","xtype.help":"frontend widget (use vType also)","xtype.choices":["","textfield","combobox","checkbox","numberfield","textarea","datefield"],prpScale:0,"prpScale.help":"Decimal scale ( 0 int, 2 dec )","prpDefault.help":"Default value","fieldLabel.help":"Field label (in form)","format.help":"input mask (automatic for date, time and numbers) (future use)",fsLayout:"1col","fsLayout.choices":["fluid","1col","2col","3col"],"fsLayout.help":"Automatic layout distribution","header.help":"Column header (grid)  default for fieldLabel","height.type":"number","height.help":"The height value in pixels","helpPath.help":"/help/xxxx.html  real: /static/help","hidden.help":"Hiden field (future use)","hidden.type":"boolean","hideLabel.help":"Hide label? (ex: firstName, lastName)","hideSheet.help":"Hide sheet?","hideRowNumbers.help":"Hide row numbers?","hideRowNumbers.type":"boolean","hideCheckSelect.type":"boolean","hideCheckSelect.help":"Hide check select?","filterSetABC.help":"Auto alphabetic filter",labelAlign:"left","labelAlign.choices":["left","top"],"labelAlign.help":"Label align (left, top)","labelWidth.help":"Label width","maxHeight.help":"The max value in pixels","maxWidth.help":"The max value in pixels","maxHeight.type":"number","maxWidth.type":"number","minHeight.help":"The minimum value in pixels","minWidth.help":"The minimum value in pixels","minHeight.type":"number","minWidth.type":"number","height.type":"number","width.type":"number","flex.type":"number","flex.help":"Flex width eqivalence",readOnly:false,"readOnly.help":"ReadOnly field?","title.help":"Title","tooltip.help":"Microhelp","sortable.help":"Sortable?","sortable.type":"boolean","searchable.help":"Searchable?","searchable.type":"boolean","type.help":"Field type","type.choices":["","string","text","bool","int","decimal","combo","date","datetime","time","autofield","html","foreignid","foreigntext"],"vType.help":"Validation type","vType.choices":["","email","ip4","ip6","tel","postalCodeCA","postalCodeUSA"],"width.help":"The width value in pixels","wordWrap.type":"boolean","wordWrap.help":"Auto wordWrap (more than one line)","sheetType.help":"Sheet type (Grid, Report)","sheetType.choices":["","printerOnly","gridOnly"],"detailName.help":"Detail name (used in MD definition)","actionType.help":"Action type (backend function)","actionType.choices":["user","insTrigger","updTrigger","delTrigger","wflow"],"refreshOnComplete.type":"boolean","paramType.help":"Parameter type","paramType.choices":["","string","bool","number"],"cpFromField.help":"Derived by copy","cpFromZoom.help":"Derived form zoom (fk property)? ","crudType.help":"Crud type","crudType.choices":["","editable","screenOnly","storeOnly","insertOnly","updateOnly","linked","copied"],"selectionMode.help":"Grid selection mode for actions","selectionMode.choices":["none","single","multiple","details"],"addDetailForm.help":"Shortcut to the add form","addDetailForm.type":"boolean"};_SM.typeOf=function(b){var a=typeof b;if(a==="object"){if(b){if(Object.prototype.toString.call(b)=="[object Array]"){a="array"}}else{a="null"}}return a};_SM.objConv=function(b){var d={};if(!b){return d}for(var c=0;c<b.length;c++){d[b[c]]=""}return d};_SM.OpenFile=function(a){};_SM.copyProps=function(h,g,f,d,c){if(!f){f=true}var b=_SM.clone(h,0,c);for(var a in g){if(f||!h[a]){if(!d||a in _SM.objConv(d)){b[a]=g[a]}}}return b};_SM.clone=function(g,j,d,c){if(j){j=j+1}else{j=1}if(j>5){return g}if(null==g||"object"!=typeof g){return g}if(g instanceof Date){var h=new Date();h.setTime(g.getTime());return h}else{if(g instanceof Array){var h=[];var b=g.length;for(var f=0;f<b;++f){h[f]=_SM.clone(g[f],j,d,c)}return h}else{if(g.$class){var h={};if(g.hasOwnProperty("initialConfig")){h.initialConfig=_SM.clone(g.initialConfig,j,d,c)}return h}else{if(g instanceof Object){var h={};for(var a in g){if(a in _SM.objConv(["events","renderer"])){continue}if((d)&&(a in _SM.objConv(d))){continue}if((c)&&!(a in _SM.objConv(c))){continue}if(g.hasOwnProperty(a)){h[a]=_SM.clone(g[a],j,d,c)}}return h}else{}}}}};_SM.FormatJSON=function(a,j){var b="&nbsp; &nbsp; ";var d="<br>";if(!j){j=""}else{if(j==" "){b="";d=""}}var f=_SM.typeOf(a);if(f=="array"){if(a.length==0){return"[]"}var c="["}else{var g=0;for(var h in a){g++;break}if(g==0){return"{}"}var c="{"}var g=0;for(var l in a){var k=a[l];if(g>0){c+=","}if(f=="array"){c+=(d+j+b)}else{c+=(d+j+b+'"'+l+'": ')}switch(_SM.typeOf(k)){case"array":case"object":c+=_SM.FormatJSON(k,(j+b));break;case"boolean":if(k){c+="true"}else{c+="false"}break;case"number":c+=k.toString();break;case"null":c+="null";break;case"string":k=k.replace(/'/g,"\\'").replace(/"/g,'\\"');if(j!=" "){k=k.replace(/</g,"&lt;").replace(/>/g,"&gt;")}c+=('"'+k+'"');break;default:c+=("TYPEOF: "+_SM.typeOf(k))}g++}if(f=="array"){c+=(d+j+"]")}else{c+=(d+j+"}")}return c};_SM.VerifyLast=function(a,b){if(!b){b=","}if(a[a.length-1]==b){a=a.substring(0,a.length-1)}return a};_SM.FormatJsonStr=function(a){var d={};if(!a){return d}try{d=Ext.decode(a)}catch(c){}var b=_SM.FormatJSON(d);return b};_SM.charCount=function(a,b){if(a){return a.split(b).length}else{return 0}};_SM.clearProps=function(b){for(var a in b){if(!b[a]&&b[a]!=false){delete b[a]}else{if(_SM.typeOf(b[a])=="string"&&b[a].trim()==""){delete b[a]}}}return b};_SM.errorMessage=function(a,b){_SM.__StBar.showError(b,a)};_SM.updateWinPosition=function(b,a){_SM._winX+=40;_SM._winY+=20;if((_SM._winX+b)>_SM._mainWin.width||(_SM._winY+a)>_SM._mainWin.height){_SM._winX=10;_SM._winY=10}};_SM.savePclCache=function(a,b,c){if(a.substring(0,b.viewEntity.length)!==b.viewEntity){a=b.viewEntity+"."+b.viewCode}b.viewCode=a;_SM.DefineProtoModel(b);_SM._cllPCI[a]=b;if(c){_SM.CloseProtoTab(a);_SM._mainWin.loadPciFromMenu(a)}};_SM.getModelName=function(a){return _SM._PConfig.clsBaseModel+a};_SM.getSafeMeta=function(b){var a={viewCode:b.viewCode,viewEntity:b.viewEntity,localSort:b.localSort||false,protoEntityId:b.protoEntityId,jsonField:b.jsonField||"",idProperty:b.idProperty,gridConfig:{searchFields:_SM.clone(b.gridConfig.searchFields)},fields:_SM.clone(b.fields,0,[],["name","type","zoomModel","fkId","crudType","cpFromField","cpFromZoom","physicalName"]),usrDefProps:_SM.clone(b.usrDefProps)};return Ext.encode(a)};_SM.getGridColumn=function(d,c){for(var a in d.myColumns){var b=d.myColumns[a];if(b.dataIndex==c){return b}}};_SM.showConfig=function(c,b){var a=Ext.create("Ext.window.MessageBox",{minHeight:200,maxHeight:500,defaultMinHeight:200,defaultMaxHeight:500,defaultTextHeight:250,styleHtmlContent:true});var d=_SM.FormatJSON(b," ");a.show({width:800,multiline:true,value:d,title:c})};_SM.getCurrentTime=function(){return Ext.Date.format(new Date(),"Y-m-d H:i:s")};_SM.verifyList=function(b,a){if((!a)||(_SM.typeOf(a)!="array")){a=[]}if(_SM.typeOf(b)!="array"){b=a}else{if(b.length==0){b=a}}return b};_SM.verifyObj=function(b,a){if((!a)||(_SM.typeOf(a)!="object")){a={}}if(_SM.typeOf(b)!="object"){b=a}else{b=Ext.apply(a,b)}return b};_SM.obj2tx=function(c){var a=typeof c;if(a=="string"){a=c}else{try{a=Ext.encode(c)}catch(b){a="[]"}}return a};_SM.ptPrompt=function(b,a){return prompt(a)};_SM.openScript=function(b){var a=document.createElement("script");a.src=b;document.head.appendChild(a)};_SM.fireEvent=function(type,myMeta,eventData,scope,fn){me=scope;var code=myMeta.businessRules[type]||null;eventData.type=type;_SM.eventData=eventData;_SM.eventData.cancel=false;if(code!=null){if(type=="DblClick"||type=="default"){_SM.eventData.HDataField=scope._extGrid.columns[_SM.eventData.cellIndex].dataIndex}eval(code);if(!_SM.eventData.cancel){fn()}}else{fn()}};_SM.GetRowValue=function(c){try{var a=_SM.eventData.record.get(c);return a}catch(b){return null}};_SM.CloseProtoTab=function(a){_SM.__TabContainer.closeProtoTab(a)};_SM.Product=function(g){var h=g[0];var f=g.slice(1);if(h){var b=[];if(f.length>0){var a=_SM.Product(f);for(var d=0;d<a.length;d++){for(var c=0;c<h.length;c++){b.push([h[c]].concat(a[d]))}}}else{for(var c=0;c<h.length;c++){b.push([h[c]])}}return b}else{return[]}};var dbModel={shape:{},locator:{}};var jsonDocument=[];function loadJsFilesSequentially(d,c,a){if(d[c]){if(filesadded.indexOf("["+d[c]+"]")===-1){var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("src",d[c]);b.onload=function(){c=c+1;loadJsFilesSequentially(d,c,a)};document.getElementsByTagName("head")[0].appendChild(b);filesadded+="["+d[c]+"]"}else{c=c+1;loadJsFilesSequentially(d,c,a)}}else{a()}}var scriptLibrary=[];var filesadded="";function displayJSON(a){var b=new draw2d.io.json.Writer();b.marshal(a,function(c){$("#json").text(JSON.stringify(c,null,2))})}function createJSFilesLibrary(){scriptLibrary.push("static/js2db/lib/jquery-1.10.2.min.js");scriptLibrary.push("static/js2db/lib/jquery.autoresize.js");scriptLibrary.push("static/js2db/lib/jquery-touch_punch.js");scriptLibrary.push("static/js2db/lib/jquery.contextmenu.js");scriptLibrary.push("static/js2db/lib/shifty.js");scriptLibrary.push("static/js2db/lib/raphael.js");scriptLibrary.push("static/js2db/lib/rgbcolor.js");scriptLibrary.push("static/js2db/lib/canvg.js");scriptLibrary.push("static/js2db/lib/Class.js");scriptLibrary.push("static/js2db/lib/json2.js");scriptLibrary.push("static/js2db/lib/pathfinding-browser.min.js");scriptLibrary.push("static/js2db/draw2d/src/draw2d-all.js");scriptLibrary.push("static/js2db/lib/jquery.browser.js");scriptLibrary.push("static/js2db/lib/jquery-ui-1.8.23.custom.min.js");scriptLibrary.push("static/js2db/lib/jquery.layout.js");scriptLibrary.push("static/js2db/dbModel/View.js");scriptLibrary.push("static/js2db/dbModel/locator/PortRightLocator.js");scriptLibrary.push("static/js2db/dbModel/locator/PortLeftLocator.js");scriptLibrary.push("static/js2db/dbModel/shape/DBTable.js");scriptLibrary.push("static/js2db/dbModel/shape/ManhattanRightConnectionLocator.js");scriptLibrary.push("static/js2db/dbModel/shape/ManhattanLeftConnectionLocator.js");scriptLibrary.push("static/js2db/dbModel/shape/TableConnection.js");scriptLibrary.push("static/js2db/dbModel/shape/CustomLabel.js")}_SM.getStoreDefinition=function(a){var b=Ext.create("Ext.data.Store",{viewCode:a.viewCode,model:_SM.getModelName(a.viewCode),autoLoad:a.autoLoad,pageSize:a.pageSize,remoteSort:!(a.localSort||false),sorters:a.sorters,defaultSortDirection:"ASC",groupField:a.groupCol||"",sortOnLoad:true,autoSync:true,proxy:_SM.getProxyDefinition(a),storeDefinition:a,myLoadData:function(f,d,c){if(c){this.protoMasterId=c}if(f){this.clearFilter();this.getProxy().extraParams.protoFilter=_SM.obj2tx(f);this.load()}else{if(d){this.sort(d)}}},mySetBaseFilter:function(c){this.clearFilter();this.getProxy().extraParams.protoFilter=_SM.obj2tx([]);this.getProxy().extraParams.baseFilter=_SM.obj2tx(c.concat(this.storeDefinition.baseFilter));this.load()},listeners:{beforeload:function(d,c,f){_SM.__StBar.showBusy(_SM.__language.StatusBar_Message_Loading+d.viewCode,"beforeLoad")},beforesync:function(c,d){_SM.__StBar.showBusy(_SM.__language.StatusBar_Message_Sync+this.viewCode,"beforeSync")},datachanged:function(c,f){_SM.__StBar.clear(c.viewCode,"dataChanged");try{var d=_SM.clone(c.getSorters(),0,[],["property","direction"]);c.proxy.extraParams.sort=Ext.encode(d)}catch(g){}},write:function(g,f,h){var d;for(d in f.records){var k=f.resultSet.records[d],c=f.records[d];if(k){if(f.action=="create"){c.data=k.data}else{if(f.action=="destroy"){if(k.data._ptStatus!==""){g.insert(0,k)}}}}var j=c.get("_ptStatus");if(j){c.dirty=true;if(!c.getId()){c.phantom=true}}}}}});return b};_SM.getProxyDefinition=function(a){return{type:"ajax",batchActions:true,batchOrder:"create,update,destroy",api:{read:"protoLib/protoList/",create:"protoLib/protoAdd/",update:"protoLib/protoUpd/",destroy:"protoLib/protoDel/"},actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},reader:{type:"json",root:"rows",successProperty:"success",totalProperty:"totalCount",messageProperty:"message"},writer:{type:"json",root:"rows",allowSingle:false,writeAllFields:true,encode:true,messageProperty:"message"},extraParams:{viewCode:a.viewCode,protoFilter:_SM.obj2tx(a.protoFilter),baseFilter:_SM.obj2tx(a.baseFilter),protoMeta:_SM.obj2tx(a.sProtoMeta)},listeners:{exception:function(d,c,b){var g,f=b.getError();if(typeof(f)=="string"){g=f}else{g="REMOTE EXCEPTION: ("+f.status+") "+f.statusText}_SM.__StBar.showError(g,"storeException")}}}};_SM.getTreeStoreDefinition=function(a){var b=Ext.create("Ext.data.TreeStore",{viewCode:a.viewCode,model:_SM.getModelName(a.viewCode),autoLoad:a.autoLoad,pageSize:a.pageSize,sorters:a.sorters,proxy:_SM.getProxyDefinition(a),remoteSort:true,autoSync:true,root:{expanded:true}});return b};_SM.getNewRecord=function(b,d){function c(){var g={},f,h;for(f in b.fields){h=b.fields[f];if(!h.prpDefault){continue}g[h.name]=h.prpDefault}return g}var a=new d.model(c());a.store=d;return a};_SM.getRecordByDataIx=function(d,c,b){var a=d.findExact(c,b);if(a===-1){return}return d.getAt(a)};_SM.IsAdmField=function(b,a){if(/_id$/.test(b.name)){return true}if(a.jsonField==b.name){return true}if(a.protoEntityId){if(b.name in _SM.objConv(["smCreatedBy","smModifiedBy","smCreatedOn","smWflowStatus","smRegStatus"])){return true}if(b.name=="id"){return true}if(b.name=="entity"){return true}}return false};_SM.DefineProtoModel=function(g){g=verifyMeta(g,"pcl");var c=[];var f=[],b=[],d={};for(var a in g.fields){var h=g.fields[a];if(_SM.IsAdmField(h,g)){b.push(h)}else{f.push(h)}if(!h.type){h.type="string"}d={name:h.name,type:h.type};if(!h.type in _SM.objConv(["string","text","html","bool","int","decimal","combo","date","datetime","time","protoN2N","autofield","foreignid","foreigntext"])){h.type="string";d.type="string";d.readOnly=true}if(h.name in _SM.objConv(g.gridConfig.hiddenFields)){d.hidden=true;h.hidden=true}if(h.name in _SM.objConv(g.gridConfig.readOnlyFields)){d.readOnly=true;h.readOnly=true}if(h.name in _SM.objConv(g.gridConfig.sortFields)){h.sortable=true}switch(h.type){case"decimal":d.type="number";break;case"jsonfield":d.readOnly=true;d.type="json";break;case"date":d.type="date";d.dateFormat="Y-m-d";break;case"datetime":d.type="string";break;case"time":d.type="string";break}c.push(d)}d={name:"_ptStatus",type:"string"};c.push(d);d={name:"_ptId",type:"string"};c.push(d);Ext.define(_SM.getModelName(g.viewCode),{extend:"Ext.data.Model",fields:c});g.fieldsBase=f;g.fieldsAdm=b};_SM.getFieldDict=function(b){var d={};for(var a in b.fields){var c=b.fields[a];c.idProtoGrid=b.idProtoGrid;d[c.name]=c}return d};_SM.getColDefinition=function(d){if(!d.header){d.header=d.name}var j,l,f;j={dataIndex:d.name,text:d.header};l=["flex","width","minWidth","sortable","hidden","xtype","readOnly","render","align","format","tooltip","idProtoGrid"];j=_SM.copyProps(j,d,true,l);l=["prpDefault","required","readOnly","minLength","minLengthText","maxLength","maxLengthText","step","minValue","minText","maxValue","maxText","disabledDays","disabledDaysText","zoomModel","zoomMultiple","fkId","zoomFilter","cpFromField","cpFromZoom","idProtoGrid"];f=_SM.copyProps({},d,true,l);if(d.required===true){j.allowBlank=false;f.allowBlank=false;j.allowOnlyWhitespace=false;f.allowOnlyWhitespace=false}if(!d.type){d.type="string"}if(d.choices&&d.choices.split(",").length>1){d.type="combo"}switch(d.type){case"string":if(!j.flex){j.flex=1}break;case"text":if(!j.flex){j.flex=2}j.renderer=b;break;case"int":case"secuence":j.xtype="numbercolumn";j.align="right";j.format="0,000";f.xtype="numberfield";f.format=j.format;f.align="right";f.allowDecimals=false;break;case"decimal":case"money":j.xtype="numbercolumn";j.align="right";j.format="0,000.00";f.xtype="numberfield";f.format=j.format;f.align="right";f.allowDecimals=true;f.decimalPrecision=2;break;case"date":j.xtype="datecolumn";j.format="Y/m/d";f.xtype="datefield";f.format=j.format;break;case"datetime":break;case"time":j.xtype="datecolumn";j.format="H:i";f.xtype="timefield";f.format=j.format;break;case"bool":j.xtype="mycheckcolumn";j.editable=false;j.inGrid=true;f.xtype="checkbox";break;case"combo":f.xtype="combobox";f.typeAhead=true;f.triggerAction="all";f.selectOnTab=true;var h=d.choices;if(_SM.typeOf(h)=="string"){h=h.split(",")}else{h=[]}f.store=h;f.lazyRender=true;f.listClass="x-combo-list-small";break;case"foreigntext":if(!j.flex){j.flex=1}d.cellLink=true;f.xtype="protoZoom";f.editable=false;break;case"foreignid":f.xtype="numberfield";f.hidden=true;break;case"autofield":break}if(!j.minWidth){j.minWidth=70}switch(j.xtype){case"mycheckcolumn":case"datecolumn":case"numbercolumn":break;case"checkbox":j.xtype="mycheckcolumn";break;case"datefield":j.xtype="datecolumn";break;case"numberfield":j.xtype="numbercolumn";break;default:delete j.xtype}if(((d.type=="autofield")||d.readOnly)&&(d.type!="bool")){j.renderer=k}else{j.editor=f}if(d.wordWrap===true){j.renderer=b}if(d.cellToolTip){j.renderer=c}if(d.cellLink){j.renderer=g}if(d.vType){if(d.vType=="stopLight"){j.renderer=a}}if(!j.sortable){j.sortable=false}return j;function b(m){return'<div style="white-space:normal; text-align:justify !important";>'+m+"</div>"}function c(r,o,n,s,q,p,m){o.tdAttr='data-qtip="'+r+'"';return r}function k(r,o,n,s,q,p,m){return'<span style="color:grey;">'+r+"</span>"}function g(m){return'<a href="#">'+m+"</a>"}function a(r,m,o,p,t,s,q){var n=Ext.baseCSSPrefix,u=[];if(r>66){u.push(n+"grid-stopligth-green")}else{if(r>33){u.push(n+"grid-stopligth-yellow")}else{if(r>0){u.push(n+"grid-stopligth-red")}}}return'<div class="'+u.join(" ")+'">&#160;'+r+"</div>"}};_SM.getFormFieldDefinition=function(c){var b=_SM.getColDefinition(c),a={readOnly:true};if(b.editor){a=b.editor}a.name=c.name;a.fieldLabel=c.fieldLabel||c.header||c.name;a.fieldLabel=a.fieldLabel.replace("<strong>","").replace("</strong>","");a.fieldLabel=a.fieldLabel.replace("<b>","").replace("</b>","");if(c.required){a.fieldLabel="<strong>"+a.fieldLabel+"</strong>"}if(c.primary){a.afterLabelTextTpl=_SM._requiredField}a.fieldLabel=Ext.util.Format.capitalize(a.fieldLabel);if(c.required&&!c.fkId){a.listeners={render:function(d){}}}switch(c.type){case"text":a.xtype="textarea";a.height=100;a.labelAlign="top";break;case"html":a.xtype="textarea";a.height=100;a.labelAlign="top";break;case"filefield":a.xtype="filefield";a.buttonText="Select file...";break}a.__ptType="formField";if(!a.xtype){a.xtype="textfield"}return a};_SM.loadPci=function(a,c,b){b=b||{};var d=_SM._cllPCI[a];if(d&&Ext.ClassManager.isCreated(_SM.getModelName(a))){d.viewCode=a;return true}else{if(!c){return false}Ext.applyIf(b,{scope:this,success:Ext.emptyFn,failure:Ext.emptyFn});Ext.Ajax.request({method:"POST",url:_SM._PConfig.urlGetPCI,params:{viewCode:a},scope:this,success:function(f,h){var g=Ext.decode(f.responseText);if(g.success){_SM.savePclCache(a,g.protoMeta);_SM._UserInfo.perms[a]=g.permissions;b.success.call(b.scope,f,h)}else{_SM.errorMessage("loadPC",g.message);b.failure.call(b.scope,f,h)}},failure:function(f,g){_SM.errorMessage("loadPC","");b.failure.call(b.scope,f,g)}});return false}};_SM.savePci=function(d,c){if(!d){return}var a=d.viewCode;d.updateTime=_SM.getCurrentTime();if(d.fieldsBase){d=_SM.clone(d);delete d.fieldsBase;delete d.fieldsAdm;delete d.custom}var b=Ext.encode(d);_SM.saveProtoObj(a,b,c)};_SM.saveProtoObj=function(a,b,c){c=c||{};Ext.applyIf(c,{scope:this,success:Ext.emptyFn,failure:Ext.emptyFn});Ext.Ajax.request({method:"POST",url:_SM._PConfig.urlSaveProtoObj,params:{viewCode:a,protoMeta:b},success:function(d,g){var f=Ext.decode(d.responseText);if(f.success){c.success.call(c.scope,d,g)}else{c.failure.call(c.scope,d,g);_SM.errorMessage(_SM.__language.Message_Error_SaveProtoObj,f.message)}},failure:function(d,f){_SM.errorMessage(_SM.__language.Message_Error_SaveProtoObj,d.status+" "+d.statusText);c.failure.call(c.scope,d,f)},scope:this,timeout:30000})};_SM.loadJsonConfig=function(b,a){a=a||{};Ext.applyIf(a,{scope:this,success:Ext.emptyFn,failure:Ext.emptyFn});Ext.Ajax.request({method:"POST",url:"/resources/"+b,scope:a.scope,success:function(c,d){a.success.call(a.scope,c,d)},failure:function(c,d){_SM.errorMessage("LoadJsonConfig",c.status+" "+c.statusText);a.failure.call(a.scope,c,d)}})};_SM.defineProtoPclTreeModel=function(){Ext.define("Proto.PclTreeNode",{extend:"Ext.data.Model",fields:[{name:"__ptType",type:"string"},{name:"text",type:"string"},{name:"id",type:"string"},{name:"__ptConfig"}]})};_SM.getSheeReport=function(a,c,d,b){b=b||{};Ext.applyIf(b,{scope:this,success:Ext.emptyFn,failure:Ext.emptyFn});Ext.Ajax.request({method:"POST",url:_SM._PConfig.urlGetSheetReport,params:{viewCode:a,sheetName:c,selectedKeys:Ext.encode(d)},success:function(f,g){b.success.call(b.scope,f,g)},failure:function(f,g){_SM.errorMessage(_SM.__language.Message_Error_Reporting,f.status+" "+f.statusText);b.failure.call(b.scope,f,g)},scope:this,timeout:60000})};_SM.doProtoActions=function(b,a,g,c,f,h,d){f=f||[];d=d||{};Ext.applyIf(d,{scope:this,success:Ext.emptyFn,failure:Ext.emptyFn});Ext.Ajax.request({method:"POST",url:_SM._PConfig.urlDoAction,params:{viewCode:b,actionName:a,parameters:Ext.encode(f),actionDef:Ext.encode(h),selectedKeys:Ext.encode(g),detKeys:Ext.encode(c)},success:function(j,k){d.success.call(d.scope,j,k)},failure:function(j,k){_SM.errorMessage("ActionReport Failed",j.status+" "+j.statusText);d.failure.call(d.scope,j,k)},scope:this,timeout:60000})};_SM.sortObjByName=function(d,c){var g=d.name.toLowerCase(),f=c.name.toLowerCase();if(g<f){return -1}if(g>f){return 1}return 0};_SM.getDetailDefinition=function(d,a){var b,c;for(b in d.detailsConfig){c=d.detailsConfig[b];if(c.conceptDetail===a){return c}}return{}};_SM.__language={Text_Validate_Login_Button:"se connecter",Text_change_Password_Button:"changer le mot de passe",Text_Forgotten_Password:"mot de passe perdu",Textfield_User_Login:"utilisateur",Textfield_User_Email:"courriel",Textfield_Password_Login:"mot de passe",Textfield_New_Password:"nouveau mot de passe",Textfield_Confirm_Password:"confirmer le mot de passe",Title_Window_Email_Request:"Récupérer le mot de passe perdu",Title_Window_Password_Change:"Changez votre mot de passe",Text_Send_Button:"Envoyer",Message_Enter_Email:"Entrez votre courriel",Message_Success:"Succès",Message_Email_Forgotten_Password:"Un courriel a été envoyé avec les instructions",Message_Email_New_Password:"Un courriel a été envoyé avec votre nouveau mot de passe",Message_Success_Password_Change:"Le mot de passe a été changé avec succès",Message_Error:"Error",Message_Error_Login:"Impossible de se connecter",StatusBar_Message_Loading:"Loading"};Ext.define("ProtoUL.UI.MDLinkController",{extend:"Ext.Base",masterRowData:null,masterId:-1,constructor:function(a){Ext.apply(this,a||{})},setMasterData:function(b){var a=this;a.masterRowData=b;if(!b){a.masterId=-1}else{a.masterId=b.id}},getDetailLink:function(a){var f=this,c,d="",g="",b;a.masterField=a.masterField||"pk";if(a.masterField==="pk"){if(!f.masterId){f.masterId=-1}b=f.masterId}else{b=f.masterRowData[a.masterField]}c=[{property:a.detailField,filterStmt:b}];if(f.masterRowData){g=a.masterTitleField||"__str__";d=f.masterRowData[g]}return{detFilter:c,detTitle:d}},setDetailDefaults:function(a,d){var g=this,f,b,c,h;f=a.detailField.replace(/__pk$/,"_id");b=d[f];if(!b){return}b.prpDefault=g.masterId;f=a.masterTitleField||f.replace(/_id$/,"");c=d[f];if(c){h=a.masterTitleField||"__str__";c.readOnly=true;if(g.masterRowData){c.prpDefault=g.masterRowData[h]}else{c.prpDefault="?"}}}});Ext.define("ProtoUL.UI.ConfigController",{extend:"Ext.Base",myMeta:null,constructor:function(a){Ext.apply(this,a||{});this.getProtoConfigBar()},getProtoConfigBar:function(){var g=this;function d(h){g.configAction(h.prCfgAction)}function b(k,h,j){var l=Ext.create("Ext.Action",{text:h,iconCls:j,prCfgAction:k,scope:g,handler:d});return l}var a=[],f=this.__MasterDetail;this.viewCode=this.myMeta.viewCode;var c=_SM._UserInfo.perms[this.viewCode];if(c.config){a.push(b("Form",_SM.__language.MetaConfig_Form_Config,"icon-configForm"));a.push(b("Fields",_SM.__language.MetaConfig_Add_Fields,"icon-configFields"));a.push(b("Details",_SM.__language.MetaConfig_Add_Details,"icon-configDetails"));a.push(b("Config",_SM.__language.MetaConfig_Base_Config,"icon-configCustom"));a.push(b("Meta",_SM.__language.MetaConfig_Meta_Config,"icon-configMeta"))}else{if(c.custom){a.push(b("Custom",_SM.__language.MetaConfig_Custom_Config,"icon-configCustom"))}}if(a.length>0){f.tbConfigOpts=Ext.create("Ext.toolbar.Toolbar",{dock:"top",hidden:true,enableOverflow:true,items:[{xtype:"tbtext",text:"<strong>"+_SM.__language.Text_Config+":</strong>"}]});f.tbConfigOpts.add(a);f.myConfigOpts=a;f.protoMasterGrid.addDocked(f.tbConfigOpts)}},configAction:function(a){switch(a){case"Meta":this.showMetaConfig();break;case"Custom":this.showCustomConfig(false);break;case"Config":this.showCustomConfig(true);break;case"Form":this.showProtoDesigner();break;case"Fields":this.showFieldTree();break;case"Details":this.showDetailsTree();break}},showMetaConfig:function(){var b=_SM._cllPCI[this.viewCode];if(!b){return}var a=Ext.widget("protoPcl",{myMeta:b,editable:true});this.showConfigWin(a)},showCustomConfig:function(d){var b=_SM._cllPCI[this.viewCode],c;if(!b){return}var a=Ext.widget("protoPcl",{myMeta:b,custom:true,metaConfig:d,editable:true});if(d){c="Base Config"}else{c="Custom Config"}this.showConfigWin(a)},showFieldTree:function(){var a=_SM._cllPCI[this.viewCode];if(!a){return}var b=Ext.create("ProtoUL.proto.ProtoFieldSelector",{viewCode:this.viewCode,myMeta:a});this.showConfigWin(b)},showProtoDesigner:function(){var b=_SM._cllPCI[this.viewCode];if(!b){return}var a=Ext.widget("protoDesigner",{myMeta:b,viewCode:this.viewCode});this.showConfigWin(a)},showDetailsTree:function(){var b=_SM._cllPCI[this.viewCode];if(!b){return}var a=Ext.create("ProtoUL.proto.ProtoDetailSelector",{myMeta:b,viewCode:this.viewCode});this.showConfigWin(a)},showConfigWin:function(c,b){if(!b){b="MetaDefinition"}var a=Ext.widget("window",{constrain:true,title:b+" [ "+this.viewCode+" ]",width:900,height:600,minHeight:400,minWidth:400,layout:"fit",constrainHeader:true,resizable:true,maximizable:true,collapsible:true,items:c});a.show()}});Ext.define("ProtoUL.UI.FormController",{extend:"Ext.Base",myMeta:null,myMetaDict:null,viewCode:null,isReadOnly:false,formLoaded:false,myWidth:620,myHeight:460,newForm:false,constructor:function(a){Ext.apply(this,a||{});this.myMetaDict={}},_loadFormDefinition:function(){function a(k,h){var j={scope:k,success:function(n,l,m){k._waitForDetails(k,h)},failure:function(n,l,m){k._waitForDetails(k,h);_SM.errorMessage("ProtoDefinition Error :",h+": protoDefinition not found")}};if(_SM.loadPci(h,true,j)){k._waitForDetails(k,h)}}Ext.suspendLayouts();this.myMetaDict[this.myMeta.viewCode]=false;var f=this,d=f.myMeta.detailsConfig,g,b,c;for(g in d){b=d[g];this.myMetaDict[b.conceptDetail]=false}f.loaded=false;for(c in f.myMetaDict){if(c in _SM._cllPCI){f.myMetaDict[c]=true}else{a(f,c)}}if(!f.loaded){f._waitForDetails(f)}Ext.resumeLayouts(true)},_waitForDetails:function(b,a){if(a){b.myMetaDict[a]=true}for(a in b.myMetaDict){if(!b.myMetaDict[a]){return}}if(b.loaded){return}b.loaded=true;b.newProtoForm.call(b);b.myForm.setActiveRecord(this.myRecordBase);b.myForm.store=this.myRecordBase.store;if(b.isReadOnly){b.myForm.setFormReadOnly(true)}else{b.myForm.setReadOnlyFields(true,b.myMeta.gridConfig.readOnlyFields)}b.newWindowLoad.call(b,b);b.myWin.show();b.myForm.setDetailsTilte()},newProtoForm:function(){var a=this;if(!a.myFieldDict){a.myFieldDict=_SM.getFieldDict(a.myMeta)}this.defineFormLayout();this.myForm=Ext.widget("protoform",{myMeta:this.myMeta,newForm:this.newForm,myFormController:this,prFormLayout:this.prFormLayout});return this.myForm},newWindow:function(a){a._loadFormDefinition()},newWindowLoad:function(b){_SM.updateWinPosition(b.myWidth,b.myHeight);var a="";if(b.newForm){a=" *"}b.myForm.setZoomEditMode(b.myForm);b.myWin=Ext.widget("window",{title:b.myMeta.viewCode+a,closeAction:"hide",width:b.myWidth,height:b.myHeight,style:"z-index: -1;",x:_SM._winX,y:_SM._winY,minHeight:400,minWidth:400,layout:"fit",constrainHeader:true,maximizable:true,resizable:true,modal:true,items:b.myForm});b.myForm.on({close:function(){b.myWin.close()},hide:function(){b.myWin.hide()},scope:b})},openNewForm:function(b){this.isReadOnly=false;this.newForm=true;this.myStore=b;var a=_SM.getNewRecord(this.myMeta,b);this.openForm(a)},openLinkedForm:function(a,b){this.newForm=false;this.isReadOnly=b;this.openForm(a)},openForm:function(a){if(!a){_SM.errorMessage("Form Error","Undefined input record");return}this.myRecordBase=a;this.newWindow(this)},openProtoForm:function(b,a,c){this.viewCode=b;this.isReadOnly=!c;if(!a){_SM.errorMessage("LinkedForm Error : "+b,"not fkId field definition found");return}this._getFormDefinition(a)},_getFormDefinition:function(a){var b={scope:this,success:function(f,c,d){this._openAndLoad(this.viewCode,a)},failure:function(f,c,d){_SM.errorMessage("ProtoDefinition Error :",this.viewCode+": protoDefinition not found")}};if(_SM.loadPci(this.viewCode,true,b)){this._openAndLoad(this.viewCode,a)}},_openAndLoad:function(b,a){this.myMeta=_SM.clone(_SM._cllPCI[b]);this.formLoaded=true;this._loadFormData(a)},_loadFormData:function(a){var c=this,f,d,g,b;if(!c.formLoaded){return}f=[{property:"pk",filterStmt:a}];d={viewCode:this.viewCode,autoLoad:true,baseFilter:f,sProtoMeta:_SM.getSafeMeta(this.myMeta)};g=_SM.getStoreDefinition(d);if(a!==-1){g.load();g.on({load:function(j,h,l,k){if(this.myWin){return}this.openLinkedForm(h[0],this.isReadOnly)},scope:this})}else{this.newForm=true;c.myFieldDict=_SM.getFieldDict(c.myMeta);if(c.linkController){c.detailLink=c.linkController.getDetailLink(c.detailDefinition);c.linkController.setDetailDefaults(c.detailDefinition,c.myFieldDict);c.baseFilter=c.detailLink.detFilter;c.detailTitle=c.detailLink.detTitle}b=_SM.getNewRecord(this.myMeta,g);this.openForm(b)}},defineFormLayout:function(){function h(m,l){var k=m[l];if(k){m.fieldDefaults[l]=k}}function g(t,w,m,p){var o,s,x,u,q=_SM.typeOf(m);if(q==="object"){if(!m.__ptConfig){m.__ptConfig=getSimpleProperties(m)}if(!m.__ptConfig.name){m.__ptConfig.name=p}u=m.__ptConfig.__ptType||m.__ptType;if(!u){return{}}else{if(u==="formField"){p=m.name||m.__ptConfig.name;o=t.myFieldDict[p];if(o){x=getTemplate(u,true,o);if(o.required&&!o.fkId&&t.newForm){x.__ptConfig.listeners.render=function(y){Ext.Ajax.request({url:_SM._PConfig.urlGetNextIncrement,method:"GET",params:{fieldName:o.name,viewEntity:t.myMeta.viewEntity},success:function(z,B){var A=Ext.decode(z.responseText);if(A.increment){y.setValue(A.increment)}},failure:function(){console.log("failure on get increment")}})}}s=Ext.apply(x.__ptConfig,m.__ptConfig);if(s.xtype==="protoZoom"){s.readOnlyCls="protoLink"}else{if(s.xtype!=="checkbox"){s.readOnlyCls="protofield-readonly"}}}else{s={text:p,xtype:"label",margin:"4",padding:"4",border:1,tooltip:"field definition not found",style:{borderColor:"red",borderStyle:"solid",bodyStyle:";border-right:none;border-left:none;border-top:none;"}}}}else{if(u=="protoGrid"){if(_SM.loadPci(m.viewCode,false)){x=getTemplate(u,true);s=Ext.apply(x.__ptConfig,m.__ptConfig);if((!s.minWidth)||(s.minWidth<100)){s.minWidth=250}s.initialFilter=[{property:"pk",filterStmt:-1}];delete m.__ptConfig.name}else{s={xtype:"label",margin:"4",padding:"4",border:1,text:"ERROR: grid definition not found "+m.viewCode,style:{borderColor:"red",borderStyle:"solid",bodyStyle:";border-right:none;border-left:none;border-top:none;"}};_SM.errorMessage("defineProtoFormItem",m.viewCode+" not found!!")}}else{if(u=="htmlset"){x=getTemplate(u,true);s=Ext.apply(x.__ptConfig,m.__ptConfig);s.htlmFields=m.items;delete m.__ptConfig.name}else{if(u=="detailButton"){x=getTemplate(u,true);s=Ext.apply(x.__ptConfig,m.__ptConfig);s.minWidth=100}else{x=getTemplate(u,true);s=Ext.apply(x.__ptConfig,m.__ptConfig);s.items=[];var k,n,r,v;k=m.items;for(n in k){if(n.indexOf("__pt")==0){continue}r=k[n];v=g(t,m,r,n);if(v){s.items.push(v)}}}}}}}var l,n;l=s.fsLayout;if(l){s.defaultType="textfield";s.layout="column";s.defaults={padding:"2 2"};if(l=="1col"){s.defaults.columnWidth=1}else{if(l=="2col"){s.defaults.columnWidth=0.5}else{if(l=="3col"){s.defaults.columnWidth=0.33}}}delete s.fsLayout;s.fieldDefaults={};h(s,"labelAlign");h(s,"labelWidth");h(s,"hideLabel")}if(s.tooltip){s.listeners={render:function(y){Ext.create("Ext.tip.ToolTip",{target:y.getEl(),trackMouse:true,html:s.tooltip})}}}}else{if(q=="array"){var r,v;s=[];for(n in m){r=m[n];v=g(t,w,r,n);if(v){s.push(v)}}}}return s}var c=this,a,f,d,j,b;a=_SM.clone(this.myMeta.formConfig);f=this.myMeta;c.prFormLayout=[];for(d in a.items){j=a.items[d];b=g(c,{__ptType:"panel"},j);c.prFormLayout.push(b)}}});Ext.define("ProtoUL.UI.GridController",{extend:"Ext.Base",myMeta:null,myGrid:null,store:null,constructor:function(a){Ext.apply(this,a||{})},addNavigationPanel:function(){var f=this,c=this.myGrid,b=["-"],a,d;d=Ext.create("Ext.form.ComboBox",{name:"perpage",width:60,store:Ext.create("Ext.data.ArrayStore",{fields:["id"],data:_SM._ComboPageSize}),mode:"local",value:"50",listWidth:60,triggerAction:"all",displayField:"id",valueField:"id",editable:false,forceSelection:true});d.on("select",function(j,h){c.store.pageSize=parseInt(j.getValue(),10);c.store.load();if(c.store.currentPage!=1){c.store.loadPage(1)}},c);if(c.protoIsDetailGrid){b.push({text:_SM.__language.GridNav_In_New_Tab,iconCls:"icon-promote",scope:f,handler:g})}b.push(d,_SM.__language.GridNav_PageSize);a={xtype:"pagingtoolbar",border:false,dock:"bottom",store:c.store,displayInfo:true,items:b,afterPageText:_SM.__language.GridNav_Total+" {0}",beforePageText:_SM.__language.GridNav_Page,firstText:_SM.__language.GridNav_First_Page,nextText:_SM.__language.GridNav_Next_Page,prevText:_SM.__language.GridNav_Previous_Page,lastText:_SM.__language.GridNav_Last_Page,refreshText:_SM.__language.GridNav_Refresh,displayMsg:_SM.__language.GridNav_Current+" : {0} - {1} "+_SM.__language.GridNav_Total+" {2}"};c.addDocked(a);function g(){_SM.__TabContainer.addTabPanel(c.viewCode,c.mdFilter,c.detailTitle)}},addGridTools:function(c){var b=!c,a;a=[{itemId:"toolFormAdd",tooltip:_SM.__language.GridBtn_Ttip_Add_Form,type:"formAdd",width:20,hidden:b,scope:this,handler:this.onEditAction},{itemId:"toolFormUpd",tooltip:_SM.__language.GridBtn_Ttip_Edit_Form,hidden:b,type:"formUpd",width:20,scope:this,handler:this.onEditAction},{itemId:"toolRowDel",type:"rowDel",tooltip:_SM.__language.GridBtn_Ttip_Del_Record,hidden:b,width:30,scope:this,handler:this.onEditAction},{itemId:"toolFormView",tooltip:_SM.__language.GridBtn_Ttip_Read_Only,type:"formView",width:20,scope:this,handler:this.onEditAction},{itemId:"toolRowCopy",tooltip:_SM.__language.GridBtn_Ttip_Copy_Row,type:"rowCopy",hidden:b,width:20,scope:this,handler:this.onEditAction},{itemId:"toolDiagramEdit",tooltip:_SM.__language.GridBtn_Ttip_Edit_Diagram,type:"diagramEdit",hidden:true,width:20,scope:this,handler:this.onEditAction}];this.myGrid.addTools(a);this.setEditMode(c)},setToolMode:function(a,c){var b=this.myGrid._extGrid;if(c){b.down(a).show()}else{b.down(a).hide()}},setEditMode:function(j){var g=this,d,a,f,b,c;b=_SM._UserInfo.perms[this.myMeta.viewCode]||[];c=g.myGrid._extGrid;this.myGrid.editable=j;if(!(b.add||b.change||b["delete"])){d=false}else{var h=false;if(typeof g.myGrid.selected!=="undefined"){h=g.myGrid.selected}d=j&&h;if(d){a=g.myGrid.selected;f=a.get("_ptStatus");d=!(f&&f===_SM._ROW_ST.REFONLY)}}this.setEditToolBar(j,d,b)},setEditToolBar:function(d,b,a){var c=this;c.setToolMode("#toolRowCopy",d&&a.add);c.setToolMode("#toolFormAdd",d&&a.add);c.setToolMode("#toolFormUpd",b&&a.change);c.setToolMode("#toolRowDel",b&&a["delete"]);if(c.myMeta.viewCode==="prototype.Project"||c.myMeta.viewCode==="prototype.Diagram"){c.setToolMode("#toolDiagramEdit",b&&a.add)}},onEditAction:function(d,h,b,a){function g(j){if(j==="yes"){c.myGrid.deleteCurrentRecord()}}if(!this.formController){this.formController=Ext.create("ProtoUL.UI.FormController",{myMeta:this.myMeta})}this.myGrid.fireStartEdition(a.itemId);switch(a.itemId){case"toolFormAdd":this.formController.openNewForm(this.myGrid.store);break;case"toolFormUpd":if(_SM.validaSelected(this.myGrid)){this.formController.openLinkedForm(this.myGrid.selected)}break;case"toolFormView":if(_SM.validaSelected(this.myGrid)){this.formController.openLinkedForm(this.myGrid.selected,true)}break;case"toolDiagramEdit":if(_SM.validaSelected(this.myGrid)){Ext.getBody().mask("Loading...","loading");scriptLibrary=[];createJSFilesLibrary();var f=this.myGrid.rowData;loadJsFilesSequentially(scriptLibrary,0,function(){var j=Ext.create("ProtoUL.view.diagram.DiagramMainView");if(f.project_id){j.setDiagramID(f.id);j.setProjectID(f.project_id)}else{j.setProjectID(f.id)}j.show();Ext.getBody().unmask();j.maximize()})}break;case"toolRowCopy":this.myGrid.duplicateRecord();break;case"toolRowDel":var c=this;Ext.MessageBox.confirm(_SM.__language.Title_Msg_Confirm_Delete,_SM.__language.Msg_Confirm_Delete_Operation,g);break}}});_SM.validaSelected=function(a){var b=a.selected;if(!b){_SM.errorMessage(_SM.__language.Title_Form_Panel,_SM.__language.GridAction_NoRecord);return false}if(!b.store){b.store=a.store}return true};Ext.define("ProtoUL.UI.GridSheetController",{extend:"Ext.Base",myGrid:null,constructor:function(a){Ext.apply(this,a||{})},getSheetConfig:function(){var c=this.myGrid,d=c.myMeta,a,f;var b=true;for(a in d.sheetConfig){f=d.sheetConfig[a].sheetType;if(f=="gridOnly"){continue}b=false;break}if(b){d.gridConfig.hideSheet=true}if(!(c.initialConfig.hideSheet||d.gridConfig.hideSheet)){c.IdeSheet=Ext.id();this.pSheetsProps={};return{region:"east",id:c.IdeSheet,collapsible:true,collapsed:true,split:true,flex:1,layout:"fit",minSize:50,autoScroll:true,border:false}}},prepareSheet:function(){var m=this.myGrid,b=m.myMeta;if(m.initialConfig.hideSheet||b.gridConfig.hideSheet){return}if(!m.rowData){h("","");return}var d=b.sheetConfig,o=b.sheetSelector||"",k=m.rowData[o],n=undefined,c;for(c in d){if(d[c].sheetType=="printerOnly"){continue}n=d[c];if(n.name==k){break}}if(n===undefined){return}var a=n.template||"";var g=this.pSheetsProps[n.name];if(!g){g=[];for(c in b.fields){var j=b.fields[c].name;if(a.indexOf("{{"+j+"}}")>-1){g.push(j)}}this.pSheetsProps[n.name]=g}for(c in g){var f=g[c];var l="{{"+f+"}}";var p=m.rowData[f];if(f=="metaDefinition"){p=_SM.FormatJsonStr(p)}a=a.split(l).join(p)}h(n.title,a);function h(s,r){var q=Ext.getCmp(m.IdeSheet);q.setTitle(s);q.update(a);m.sheetHtml=a}}});Ext.define("ProtoUL.UI.MDActionsController",{extend:"Ext.Base",myMeta:null,constructor:function(a){Ext.apply(this,a||{});this.getProtoActionsBar()},getProtoActionsBar:function(){var perms=_SM._UserInfo.perms[this.myMeta.viewCode];if(!(perms.add||perms.change||perms["delete"])){return}var me=this,ix,pProtoAction,myProtoActions=[],__MasterDetail=this.__MasterDetail;if(this.myMeta.WFlowActions){for(ix in this.myMeta.WFlowActions){pProtoAction=this.myMeta.WFlowActions[ix];pProtoAction.menuText=pProtoAction.menuText||pProtoAction.name;pProtoAction.actionType="wflow";pProtoAction.selectionMode="multiple";pProtoAction.refreshOnComplete=true;if(pProtoAction.admMessagePropmt){pProtoAction.actionParams=[{name:"admMessage",tooltip:pProtoAction.description,fieldLabel:pProtoAction.admMessagePropmt,type:"string",required:true}]}else{pProtoAction.actionParams=[]}myProtoActions.push(new Ext.Action({text:pProtoAction.menuText,actionName:pProtoAction.name,iconCls:pProtoAction.viewIcon,tooltip:pProtoAction.description,actionDef:pProtoAction,scope:me,handler:onClickDoAction}))}}for(ix in this.myMeta.actions){pProtoAction=this.myMeta.actions[ix];pProtoAction.menuText=pProtoAction.menuText||pProtoAction.name;myProtoActions.push(new Ext.Action({text:pProtoAction.menuText,actionName:pProtoAction.name,iconCls:pProtoAction.viewIcon,tooltip:pProtoAction.description,actionDef:pProtoAction,scope:me,handler:onClickDoAction}))}if(myProtoActions.length>0){__MasterDetail.tbProtoActions=Ext.create("Ext.toolbar.Toolbar",{dock:"top",hidden:true,enableOverflow:true,items:[{xtype:"tbtext",text:"<strong>Actions :</strong>"}]});__MasterDetail.tbProtoActions.add(myProtoActions);__MasterDetail.myProtoActions=myProtoActions;__MasterDetail.protoMasterGrid.addDocked(__MasterDetail.tbProtoActions)}function onClickDoAction(btn){var pGrid=__MasterDetail.protoMasterGrid;var selectedKeys=pGrid.getSelectedIds();var pAction=btn.actionDef;var myOptions,myWin;var detKeys={};if((pAction.selectionMode=="single")&&(selectedKeys.length!=1)){_SM.__StBar.showMessage("TITLE_ACTION_SELECTION_SINLGLE",btn.actionName,3000);return}else{if((pAction.selectionMode=="multiple")&&(selectedKeys.length<1)){_SM.__StBar.showMessage("TITLE_ACTION_SELECTION_MULTI",btn.actionName,3000);return}else{if(pAction.selectionMode=="details"){for(ix in this.__MasterDetail.protoTabs.items.items){pdetGrid=this.__MasterDetail.protoTabs.items.items[ix];detKeys[pdetGrid.detailDefinition.detailName]=pdetGrid.getSelectedIds()}}}}pAction.actionParams=_SM.verifyList(pAction.actionParams);if(pAction.executeJS){eval(pAction.jsCode)}else{if(pAction.actionParams.length==0){this.doAction(me,pGrid.viewCode,btn.actionDef,selectedKeys,[],detKeys)}else{myOptions={scope:me,acceptFn:function(parameters){this.doAction(me,pGrid.viewCode,btn.actionDef,selectedKeys,parameters,detKeys)}};myWin=Ext.create("ProtoUL.ux.parameterWin",{parameters:pAction.actionParams,title:btn.actionName,options:myOptions});myWin.show()}}}},doAction:function(f,a,h,g,d,b){var c={scope:f,success:function(j,l){var k=Ext.decode(j.responseText);_SM.__StBar.showMessage(h.name+" "+k.message,"MDActionsController",3000);if(k.success&&h.refreshOnComplete){this.__MasterDetail.mdGridReload()}if(k.fileName){_SM.getFile(k.fileName,true)}},failure:function(j,k){_SM.__StBar.showError(h.name+" "+j.statusText,"MDActionsController")}};_SM.__StBar.showMessage("executing  "+h.name+"...","MDActionsController");_SM.doProtoActions(a,h.name,g,b,d,h,c)}});Ext.define("ProtoUL.UI.MDDetailsController",{extend:"Ext.Base",myMeta:null,constructor:function(a){Ext.apply(this,a||{});this.getDetailsTBar()},getDetailsTBar:function(){var h=this,l=h.__MasterDetail,a=[],f,k,d;for(k in l.myMeta.detailsConfig){d=l.myMeta.detailsConfig[k];if(d.menuText===undefined){continue}f=new Ext.Action({text:d.menuText,hidden:true,scope:h,handler:b,detailKey:d.conceptDetail,detailDefinition:d});a.push(f);j(f.initialConfig,f)}if(a.length>0){l.tbDetails=Ext.create("Ext.toolbar.Toolbar",{dock:"bottom",border:true,enableOverflow:true,items:[{text:"<strong>"+_SM.__language.Grid_Detail_Title+":</strong>",iconCls:"icon-panelDown",enableToggle:false,scope:l,handler:l.hideDetailPanel}]});l.myDetails=a;l.tbDetails.add(a);l.protoMasterGrid.addDocked(l.tbDetails,0)}function j(n,o){var m={scope:h,success:function(r,p,q){c(n,o)},failure:function(r,p,q){g(n,o)}};if(_SM.loadPci(n.detailDefinition.conceptDetail,true,m)){c(n,o)}}function g(m,n){l.protoTabs.add({html:_SM.__language.Grid_Detail_Error+" :"+m.detailKey,ixDetail:l.protoTabs.items.length})}function c(o,r){function n(u,s,t){r.initialConfig[u]=t;r.callEach(s,[t])}var m=o.detailDefinition,q,p;q=Ext.create("ProtoUL.view.ProtoGrid",{border:false,viewCode:m.conceptDetail,protoIsDetailGrid:true,detailDefinition:m,autoLoad:false,isDetail:true,_MasterDetail:l});q.store.detailDefinition=m;o.ixDetail=l.protoTabs.items.length;l.protoTabs.add(q);q.ixDetail=o.ixDetail;l.cllStoreDet[o.ixDetail]=q.store;p=q.myMeta;n("tooltip","setTooltip",m.menuText);n("iconCls","setIconCls",p.viewIcon);n("width","setWidth",100);r.show()}function b(m){l.ixActiveDetail=m.initialConfig.ixDetail;l.protoTabs.getLayout().setActiveItem(l.ixActiveDetail);l.linkDetail();l.showDetailPanel();if(m.hasOwnProperty("toggle")){m.toggle(true)}}}});Ext.define("ProtoUL.UI.MDPrintOptsController",{extend:"Ext.Base",myMeta:null,constructor:function(a){Ext.apply(this,a||{});this.getPrinterOptsBar()},getPrinterOptsBar:function(){var h=this;var d=[];var l=this.__MasterDetail;if(this.myMeta.gridConfig.exportCsv){d.push(new Ext.Action({text:_SM.__language.Grid_ExportCSV,iconCls:"icon-printGrid",tooltip:_SM.__language.Grid_ExportCSV_Ttip,scope:h,handler:f}))}if(!this.myMeta.gridConfig.denyAutoPrint){d.push(new Ext.Action({text:_SM.__language.Text_Grid,iconCls:"icon-printGrid",scope:h,handler:b}));if(l.protoMasterGrid.IdeSheet!=undefined){d.push(new Ext.Action({text:"Fiche",iconCls:"icon-printSheet",scope:h,handler:j}))}}if(this.myMeta.sheetConfig.length>0){for(var c in this.myMeta.sheetConfig){var a=this.myMeta.sheetConfig[c];if(a.sheetStyle=="gridOnly"){continue}d.push(new Ext.Action({text:a.name,sheetName:a.name,iconCls:a.viewIcon||"icon-printSheet",tooltip:a.title,scope:h,handler:k}))}}if(d.length>0){l.tbPrinterOpts=Ext.create("Ext.toolbar.Toolbar",{dock:"top",hidden:true,enableOverflow:true,items:[{xtype:"tbtext",text:"<strong>"+_SM.__language.Text_Print+":</strong>"}]});l.tbPrinterOpts.add(d);l.myPrinterOpts=d;l.protoMasterGrid.addDocked(l.tbPrinterOpts)}function g(m){}function b(m){var n=ProtoUL.ux.Printer;n.gridPrint(l.protoMasterGrid._extGrid)}function j(n){var o=ProtoUL.ux.Printer,m=l.protoMasterGrid;if((!m)||(!m.sheetHtml)){_SM.__StBar.showWarning(_SM.__language.GridAction_NoRecord,"MdPrintOptsController");return}h.openHtmlWin(m.sheetHtml)}function k(o){var r=ProtoUL.ux.Printer,m=l.protoMasterGrid;var q=window.open("","printgrid");var p=m.getSelectedIds();var n={scope:h,success:function(s,t){r.reportPrint(q,s.responseText)}};_SM.getSheeReport(m.viewCode,o.sheetName,p,n)}function f(n){var m=l.protoMasterGrid;Ext.Ajax.request({method:"POST",url:_SM._PConfig.urlGetProtoCsv,params:m.store.proxy.extraParams,success:function(o,q){var p=Ext.decode(o.responseText);_SM.getFile(p.message,false)},failure:function(o,p){_SM.errorMessage(_SM.__language.Grid_ExportCSV_Err,o.status+" "+o.statusText)},scope:this,timeout:60000})}},openHtmlWin:function(b){var a=window.open("","printgrid");a.document.write(b);if(this.printAutomatically){a.print()}}});_SM.getFile=function(b,a){var c="getFile/"+b;if(a){window.open(c)}else{window.location=c}};Ext.define("ProtoUL.UI.MDSetFiltersController",{extend:"Ext.Base",myMeta:null,constructor:function(a){Ext.apply(this,a||{});this.getCustomOptsBar()},getCustomOptsBar:function(){var d=[],b,h,a,g,f=this.__MasterDetail,c=this.myMeta.gridSets.filtersSet.concat(this.myMeta.custom.filtersSet);if((c.length===0)&&this.myMeta.gridConfig.filterSetABC){for(b in _SM.objConv(["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"])){a={};a.property=this.myMeta.gridConfig.filterSetABC;a.filterStmt="^"+b;c.push({name:b,filter:[a]})}c.push({name:" *",filter:{}})}for(h in c){g=c[h];d.push(new Ext.Action({name:g.name,text:g.menuText||g.name,iconCls:g.icon,maxWidth:100,protoFilter:g.customFilter,scope:this,handler:j}))}if(d.length>0){f.tbFilters=Ext.create("Ext.toolbar.Toolbar",{dock:"top",hidden:true,enableOverflow:true,items:[{xtype:"tbtext",text:"<strong>Filtrer par :</strong>"}]});f.tbFilters.add(d);f.myFilters=d;f.protoMasterGrid.addDocked(f.tbFilters)}function j(k){f.protoMasterGrid.filterTitle=' " '+k.text+' "';f.protoMasterGrid.setGridTitle(f.protoMasterGrid);f.mdGridLoadData(k.protoFilter)}}});Ext.define("ProtoUL.UI.MDSetSortersController",{extend:"Ext.Base",myMeta:null,constructor:function(a){Ext.apply(this,a||{});this.getCustomOptsBar()},getCustomOptsBar:function(){var a=[],c=this.__MasterDetail,b=this.myMeta.gridSets.sortersSet.concat(this.myMeta.custom.sortersSet);if(this.myMeta.gridConfig.initialSort&&(b.length>0)){f([{name:"Initial",icon:"soterIcon",customSort:this.myMeta.gridConfig.initialSort}]);f(b)}if(a.length>0){c.tbSortersSet=Ext.create("Ext.toolbar.Toolbar",{dock:"top",hidden:true,enableOverflow:true,items:[{xtype:"tbtext",text:"<strong>Sorters :</strong>"}]});c.tbSortersSet.add(a);c.mySortersSet=a;c.protoMasterGrid.addDocked(c.tbSortersSet)}function d(g){c.protoMasterStore.sort(g.sorter)}function f(g){var j;for(var h in g){j=g[h];a.push(new Ext.Action({maxWidth:100,text:j.name,iconCls:j.icon,sorter:j.customSort,scope:this,handler:d}))}}}});Ext.define("ProtoUL.UI.MDSetTabsController",{extend:"Ext.Base",myMeta:null,constructor:function(a){Ext.apply(this,a||{});this.getCustomOptsBar()},getCustomOptsBar:function(){var c=[],d=this.__MasterDetail,a=this.myMeta.gridSets.listDisplaySet.concat(this.myMeta.custom.listDisplaySet);if(a.length>0){var g=_SM.defineTabConfig(this.myMeta.gridConfig);f([g]);f(a)}if(c.length>0){d.tbTabs=Ext.create("Ext.toolbar.Toolbar",{dock:"top",hidden:true,enableOverflow:true,items:[{xtype:"tbtext",text:"<strong>Tabs :</strong>"}]});d.tbTabs.add(c);d.myTabs=c;d.protoMasterGrid.addDocked(d.tbTabs)}function b(h){d.protoMasterGrid.configureColumns(h.tabConfig)}function f(j){var h;for(var l in j){h=j[l];var k={name:h.name,listDisplay:h.listDisplay,hideRowNumbers:h.hideRowNumbers||false};c.push(new Ext.Action({text:h.name,iconCls:h.icon,maxWidth:100,tabConfig:k,scope:this,handler:b}))}}}});_SM.defineTabConfig=function(a){return{name:"Default",icon:"colSetIcon",listDisplay:a.listDisplay,hideRowNumbers:a.hideRowNumbers||false}};Ext.define("ProtoUL.UI.MDTbSortByController",{extend:"Ext.Base",myMeta:null,constructor:function(a){Ext.apply(this,a||{});this.getSortersBar()},getSortersBar:function(){var m=this,g=[],o=m.__MasterDetail;m.myFieldDict=o.protoMasterGrid.myFieldDict;for(var f in m.myMeta.gridConfig.sortFields){var b=m.myMeta.gridConfig.sortFields[f];var l=m.myFieldDict[b];if(!l){l={name:b,header:b}}g.push({name:l.name,header:l.header})}if(g.length>0){var a=Ext.create("Ext.ux.BoxReorderer",{listeners:{scope:m,Drop:function(q,s,p){k(p,false)}}});o.tbSorters=Ext.create("Ext.toolbar.Toolbar",{dock:"top",hidden:true,items:[{iconCls:"sort",xtype:"tbtext",text:"<strong>"+_SM.__language.Grid_Sort_Title+":</strong>",reorderable:false}],plugins:[a]});for(var f in g){var l=g[f];var d=m.myFieldDict[b];if(!d){continue}o.tbSorters.add(j({text:l.header,tooltip:l.header,maxWidth:100,sortData:{property:l.name,direction:"ASC"}}))}o.protoMasterGrid.addDocked(o.tbSorters);this.mySortCols=g}function j(c){c=c||{};Ext.applyIf(c,{listeners:{click:function(p,q){k(p,true)}},iconCls:"sort-"+c.sortData.direction.toLowerCase(),reorderable:true,xtype:"button"});return c}function k(r,p){var c=r.sortData,q=r.iconCls;if(c){if(p!==false){r.sortData.direction=Ext.String.toggle(r.sortData.direction,"ASC","DESC");r.setIconCls(Ext.String.toggle(q,"sort-asc","sort-desc"))}n()}}function n(){o.protoMasterStore.myLoadData(null,h())}function h(){var c=[];Ext.each(o.tbSorters.query("button"),function(p){c.push(p.sortData)},m);return c.slice(0,3)}}});Ext.define("ProtoUL.UI.TbMasterDetail",{extend:"Ext.Toolbar",alias:"widget.tbMasterDetail",autoEdit:true,initComponent:function(){var d=this,f=this.protoMeta,c=this.__MasterDetail;this.searchBG=Ext.create("ProtoUL.ux.ProtoSearchBG",{myMeta:f});Ext.apply(this,{dock:"top",defaults:{scope:d},items:[this.searchBG,{iconCls:"icon-edit",itemId:"edit",tooltip:_SM.__language.Grid_Edit_Ttip,text:_SM.__language.Grid_Edit_Title,hidden:true,handler:b},{text:_SM.__language.Text_Clasify_Button,tooltip:_SM.__language.Tooltip_Clasify_Button,iconCls:"icon-order",itemId:"sorters",hidden:true,enableToggle:true,handler:a},{xtype:"splitbutton",text:_SM.__language.Text_Actions_Button,tooltip:_SM.__language.Tooltip_Actions_Button,iconCls:"icon-action",itemId:"protoActions",hidden:true,enableToggle:true,handler:a,menu:Ext.create("Ext.menu.Menu",{})},{xtype:"splitbutton",text:_SM.__language.Grid_Detail_Title,tooltip:_SM.__language.Tooltip_Details_Button,iconCls:"icon-details",itemId:"details",hidden:true,enableToggle:true,handler:a,menu:Ext.create("Ext.menu.Menu",{})},{xtype:"splitbutton",text:_SM.__language.Text_Filters_Button,tooltip:_SM.__language.Tooltip_Filters_Button,iconCls:"icon-filters",itemId:"filterSet",hidden:true,enableToggle:true,handler:a,menu:Ext.create("Ext.menu.Menu",{})},{xtype:"splitbutton",text:_SM.__language.Text_Tabs_Button,tooltip:_SM.__language.Tooltip_Tabs_Button,iconCls:"icon-tabs",itemId:"tabSet",hidden:true,enableToggle:true,handler:a,menu:Ext.create("Ext.menu.Menu",{})},{xtype:"splitbutton",text:_SM.__language.Text_Sorters_Button,tooltip:_SM.__language.Tooltip_Sorters_Button,iconCls:"icon-sorters",itemId:"sorterSet",hidden:true,enableToggle:true,handler:a,menu:Ext.create("Ext.menu.Menu",{})},{xtype:"splitbutton",text:_SM.__language.Text_Print,tooltip:_SM.__language.Tooltip_Printing_Options,iconCls:"icon-print",itemId:"printerOpts",hidden:true,enableToggle:true,handler:a,menu:Ext.create("Ext.menu.Menu",{})},{xtype:"splitbutton",text:_SM.__language.Text_Config,tooltip:_SM.__language.Tooltip_Config_Button,iconCls:"icon-config",itemId:"configOpts",hidden:true,enableToggle:true,handler:a,menu:Ext.create("Ext.menu.Menu",{})},"->",{iconCls:"icon-editoff",itemId:"editOff",text:_SM.__language.Text_Exit_Edit_Mode_Button,tooltip:_SM.__language.Tooltip_Exit_Edit_Mode_Button,hidden:true,handler:b},{xtype:"splitbutton",iconCls:"icon-help",handler:a,itemId:"tbHelp"}]});this.callParent();d.perms=_SM._UserInfo.perms[this.protoMeta.viewCode];this.setEditMode(this.autoEdit);if(!d.autoEdit&&(d.perms.add||d.perms.change||d.perms["delete"])){this.getComponent("edit").setVisible(true)}this.searchBG.on({qbeLoadData:{fn:function(k,h,g,j){c.mdGridLoadData(h,j);c.protoMasterGrid.filterTitle=g;c.protoMasterGrid.setGridTitle(c.protoMasterGrid)},scope:this}});function a(g){if(g.itemId==="sorters"){if(c.tbSorters){c.tbSorters.setVisible(g.pressed)}}else{if(g.itemId==="filterSet"){if(c.tbFilters){c.tbFilters.setVisible(g.pressed)}}else{if(g.itemId==="tabSet"){if(c.tbTabs){c.tbTabs.setVisible(g.pressed)}}else{if(g.itemId==="sorterSet"){if(c.tbSortersSet){c.tbSortersSet.setVisible(g.pressed)}}else{if(g.itemId==="printerOpts"){if(c.tbPrinterOpts){c.tbPrinterOpts.setVisible(g.pressed)}}else{if(g.itemId==="configOpts"){if(c.tbConfigOpts){c.tbConfigOpts.setVisible(g.pressed)}}else{if(g.itemId==="details"){if(c.tbDetails){c.showDetailPanel(!g.pressed)}}else{if(g.itemId==="protoActions"){if(c.tbProtoActions){c.tbProtoActions.setVisible(g.pressed)}}else{if(g.itemId==="tbHelp"){window.open(_SM._HELPpath,"protoHelp","left=50,top=20,width=1000,height=600,resizable=0,scrollbars=yes")}}}}}}}}}}function b(g){if(g.itemId=="edit"){d.setEditMode(true)}else{if(g.itemId=="editOff"){d.setEditMode(false)}}}},setAutoSync:function(a){},setEditMode:function(d){var c=this;if(!(c.perms.add||c.perms.change||c.perms["delete"])){return}Ext.suspendLayouts();if(!this.autoEdit){this.getComponent("edit").setVisible(!d);this.getComponent("editOff").setVisible(d);this.searchBG.setVisible(!d);b(this,"printerOpts",d);b(this,"configOpts",d);b(this,"sorters",d);b(this,"filterSet",d);b(this,"protoActions",d);b(this,"sorterSet",d)}var a=this.__MasterDetail.autoSync;this.__MasterDetail.setEditMode(d);function b(h,g,j){var f=h.getComponent(g);f.setVisible((!j)&&(f.protoEnable))}Ext.resumeLayouts(true)},addActions:function(){if(this.__MasterDetail.myDetails){var a=this.getComponent("details");a.menu.add(this.__MasterDetail.myDetails);a.protoEnable=true;a.show()}if(this.__MasterDetail.myFilters){var a=this.getComponent("filterSet");a.menu.add(this.__MasterDetail.myFilters);a.protoEnable=true;a.show()}if(this.__MasterDetail.myPrinterOpts){var a=this.getComponent("printerOpts");a.menu.add(this.__MasterDetail.myPrinterOpts);a.protoEnable=true;a.show()}if(this.__MasterDetail.myConfigOpts){var a=this.getComponent("configOpts");a.menu.add(this.__MasterDetail.myConfigOpts);a.protoEnable=true;a.show()}if(this.__MasterDetail.myProtoActions){var a=this.getComponent("protoActions");a.menu.add(this.__MasterDetail.myProtoActions);a.protoEnable=true;a.show()}if(this.__MasterDetail.tbSorters){var a=this.getComponent("sorters");a.protoEnable=true;a.show()}if(this.__MasterDetail.myTabs){var a=this.getComponent("tabSet");a.menu.add(this.__MasterDetail.myTabs);a.protoEnable=true;a.show()}if(this.__MasterDetail.mySortersSet){var a=this.getComponent("sorterSet");a.menu.add(this.__MasterDetail.mySortersSet);a.protoEnable=true;a.show()}}});Ext.define("ProtoUL.proto.ProtoDesigner",{extend:"Ext.container.Container",alias:"widget.protoDesigner",myMeta:null,initComponent:function(){var a=this;Ext.apply(this,{layout:"border",defaults:{lauyout:"fit"},items:this.getPanelItems()});a.callParent(arguments);myObj=_SM.DesignerPanels;this.doFormatLayout(myObj);this.updateFormTree()},updateFormTree:function(){var a=Meta2Tree(this.myMeta.formConfig,"formConfig","formConfig");a.expanded=true;this.formTree.getStore().setRootNode(a)},onClickRedraw:function(c){var b,a;this.formPreview.removeAll(true);b=Tree2Meta(this.formTree.store.getRootNode());this.myMeta.formConfig=b;this.formController.myMeta.formConfig=b;a=this.formController.newProtoForm();a.setFormReadOnly(true);this.formPreview.add(a)},doFormatLayout:function(b){var z=this,c,g,k,t;this.toolsPanel=z.down("#toolsPanel");this.toolsTabs=z.down("#toolsTabs");this.formTree=z.down("#formTree");this.formPreview=z.down("#formPreview");this.formController=Ext.create("ProtoUL.UI.FormController",{myMeta:z.myMeta});g=this.formController.newProtoForm();function l(B,A){for(c in B){k=B[c];if(k.text==A){return k}}return{}}g.setFormReadOnly(true);this.formPreview.add(g);this.tBar=this.toolsPanel.addDocked({xtype:"toolbar",dock:"top",items:b.tbar})[0];this.toolsTabs.add(b.toolsTabs);this.toolsTree=this.toolsTabs.down("#toolsTree");var t=Ext.create("ProtoUL.ux.ProtoProperty",{});this.properties=this.toolsTabs.down("#properties");this.properties.add(t);this.properties=t;t.on({edit:function(B,D,A){if(D.value==D.originalValue){return}var E=z.treeRecord.data.__ptConfig,C=D.record.data.name;if(_SM.typeOf(E)=="object"){E[C]=D.value}z.onClickRedraw()},scope:z});_SM.defineProtoPclTreeModel();var y,d,o,j,x;y=_SM.clone(b.toolsTree);d=l(y,"Fields");for(c in this.myMeta.fields){x=this.myMeta.fields[c];j=_SM.getFormFieldDefinition(x);j.name=x.name;o={text:x.name,qtip:x.cellToolTip,__ptType:"formField",leaf:true,__ptConfig:j};d.children.push(o)}d=l(y,"Details");for(c in this.myMeta.detailsConfig){x=this.myMeta.detailsConfig[c];o={text:x.menuText,qtip:x.toolTip,__ptType:"protoGrid",leaf:true,__ptConfig:{menuText:x.menuText,viewCode:x.conceptDetail,xtype:"protoGrid",__ptType:"protoGrid"}};d.children.push(o)}d=l(y,"DetailsButtons");for(c in this.myMeta.detailsConfig){x=this.myMeta.detailsConfig[c];o={text:x.menuText,qtip:x.toolTip,__ptType:"detailButton",leaf:true,__ptConfig:{text:x.menuText,viewCode:x.conceptDetail,xtype:"detailButton",__ptType:"detailButton"}};d.children.push(o)}var s,r,f,m;s=Ext.create("Ext.data.TreeStore",{model:"Proto.PclTreeNode",root:{expanded:true,children:y}});r=Ext.create("Ext.tree.Panel",{layout:"fit",itemId:"baseTree",store:s,rootVisible:false,viewConfig:{plugins:{ptype:"treeviewdragdrop",enableDrop:false}}});this.toolsTree.add(r);this.toolsTree=r;s=Ext.create("Ext.data.TreeStore",{model:"Proto.PclTreeNode",root:{expanded:true,text:_SM.__language.Title_Main_Panel,children:[]}});f=Ext.create("Ext.tree.Panel",{layout:"fit",store:s,autoScroll:true,rootVisible:true,viewConfig:{plugins:{ptype:"treeviewdragdrop"}}});this.formTree.add(f);this.formTree=f;var h,v,w,a,p;m=this.formTree.getView();this.formTreeViewId=m.id;m.on({beforedrop:{fn:function(D,F,E,B,A,C){if(F.view.id!=this.formTreeViewId){h=F.records[0];v=h.get("text");if(v in _SM.objConv(["Fields","Containers","Grids"])){return false}if(v in _SM.objConv(["htmlset","fieldset"])){w=E.store.getById(E.data.parentId);a=E.data.index;if(!w){w=E}if(B=="after"){a+=1}A.cancelDrop();p=getNodeBase(v,v,{__ptType:v});w.insertChild(a,p)}F.copy=true}}},drop:{fn:function(){this.onClickRedraw()}},scope:this});this.formTree.on({select:function(D,A,C,B){z.treeRecord=A;prepareProperties(A,z.myMeta,z.properties)},scope:z});var u=this.tBar.down("#redraw");u.on("click",function(B,C,A){this.onClickRedraw()},z);var q=this.tBar.down("#save");q.on("click",function(B,C,A){var D=Tree2Meta(this.formTree.store.getRootNode());this.myMeta.formConfig=D;_SM.savePclCache(this.myMeta.viewCode,this.myMeta,true);_SM.savePci(this.myMeta)},z);var n=this.tBar.down("#delete");n.on("click",function(B,C,A){z.treeRecord.remove()},z)},getPanelItems:function(){return[{region:"center",layout:"fit",itemId:"formPreview",flex:2,minSize:200},{region:"west",collapsible:true,split:true,flex:1,title:_SM.__language.Title_Form_Panel,itemId:"toolsPanel",layout:"border",defaults:{lauyout:"fit"},items:[{region:"center",layout:"fit",itemId:"formTree",autoScroll:true,minHeight:150},{region:"south",layout:"fit",itemId:"toolsTabs",collapsible:true,split:true,flex:1,title:_SM.__language.Title_Panel_Tools}]}]}});Ext.define("ProtoUL.proto.ProtoDetailSelector",{extend:"Ext.panel.Panel",alias:"widget.detailsSelector",viewCode:null,myMeta:null,initComponent:function(){var g=this;var f=Ext.create("ProtoUL.proto.ProtoToolBar",{dock:"top"});var c=Ext.create("ProtoUL.proto.ProtoDetailTree",{viewCode:g.viewCode,myMeta:g.myMeta});var a=Ext.create("ProtoUL.ux.ProtoList",{checkStyle:false,idTitle:"SelectedDetails"});c.on({loadComplete:function(l,j,m,k){b()},checkModif:function(m,l,k){var j=m.get("id");a.addOrRemove(j,l)},scope:g});f.on({preview:function(){h()},save:function(){h();_SM.savePclCache(g.myMeta.viewCode,g.myMeta,true);_SM.savePci(g.myMeta)},scope:g});var d=getSelectorsPanels(c,a);Ext.apply(this,{layout:"border",items:d,dockedItems:[f]});this.callParent(arguments);function b(){for(var j in g.myMeta.detailsConfig){var k=g.myMeta.detailsConfig[j];a.addDataItem(k.menuText,true)}}function h(){var n=a.getList(),l={},k=[];for(var j in n){l=o(n[j]);if(!l){l=m(n[j])}if(l){k.push(l)}else{}}g.myMeta.detailsConfig=k;function o(q){for(var p in g.myMeta.detailsConfig){var r=g.myMeta.detailsConfig[p];if(r.menuText==q){return r;break}}}function m(p){var q=c.treeStore.getNodeById(p);return{menuText:q.get("id"),conceptDetail:q.get("conceptDetail"),masterField:"pk",detailField:q.get("detailField")}}}}});Ext.define("ProtoUL.proto.ProtoDetailTree",{extend:"Ext.tree.Panel",alias:"widget.detailDefTree",viewCode:null,myMeta:null,initComponent:function(){var d=this;d.addEvents("checkModif","loadComplete");b(d.viewCode,d.myMeta.protoEntityId);this.treeStore=Ext.create("Ext.data.TreeStore",{autoLoad:true,model:"Proto.DetailsTreeModel",root:{text:_SM.__language.Grid_Detail_Title,expanded:true},listeners:{load:function(h,f,j,g){c();d.fireEvent("loadComplete",h,f,j,g)}}});var a=Ext.apply(this,{store:this.treeStore,useArrows:true,rootVisible:false,minWidth:400,columns:[{xtype:"treecolumn",text:_SM.__language.Tree_Concept_Details_Text,flex:2,sortable:true,minWidth:200,dataIndex:"id"},{text:_SM.__language.Tree_Concept_Details_Detail,dataIndex:"conceptDetail"},{flex:2,text:_SM.__language.Tree_Details_Field,dataIndex:"detailField"}]});a.on({checkchange:{fn:function(h,g,f){d.fireEvent("checkModif",h,g,f)}},scope:d});d.callParent(arguments);function c(){d.getRootNode().cascadeBy(function(h){var f={conceptDetail:h.get("conceptDetail"),detailField:h.get("detailField")};if(f.conceptDetail){for(var g in d.myMeta.detailsConfig){var j=d.myMeta.detailsConfig[g];if((j.conceptDetail==f.conceptDetail)&&(j.detailField==f.detailField)){h.set("checked",true);h.set("id",j.menuText);break}}}})}function b(f,g){Ext.define("Proto.DetailsTreeModel",{extend:"Ext.data.Model",proxy:{type:"ajax",url:_SM._PConfig.urlGetDetailsTree,actionMethods:{read:"POST"},extraParams:{viewCode:f,protoEntityId:g}},fields:[{name:"id",type:"string"},{name:"menuText",type:"string"},{name:"masterField",type:"string"},{name:"detailField",type:"string"},{name:"conceptDetail",type:"string"},{name:"checked",type:"boolean"},{name:"leaf",type:"boolean"}]})}}});Ext.define("ProtoUL.proto.ProtoFieldSelector",{extend:"Ext.panel.Panel",alias:"widget.protoFieldSelector",viewCode:null,myMeta:null,initComponent:function(){me=this;var d=Ext.create("ProtoUL.proto.ProtoToolBar",{dock:"top"});d.setButton("add",true,true,"add UDP");var b=Ext.create("ProtoUL.proto.ProtoFieldTree",{viewCode:me.viewCode,myMeta:me.myMeta});var a=Ext.create("ProtoUL.ux.ProtoList",{checkStyle:false,idTitle:"SelectedFields"});b.on({loadComplete:function(k,h,l,j){f()},checkModif:function(l,k,j){var h=l.get("id");a.addOrRemove(h,k)},scope:me});d.on({preview:function(){g()},save:function(){g();_SM.savePclCache(me.myMeta.viewCode,me.myMeta,true);_SM.savePci(me.myMeta)},add:function(){var h=_SM.__language.Msg_Window_New_Folder;Ext.Msg.prompt(_SM.__language.MetaConfig_Add_Fields,h,function(k,j){if(k!="ok"){return}b.addUdpField({name:j,checked:false})},me,false,"udp__")},scope:me});var c=getSelectorsPanels(b,a);Ext.apply(this,{layout:"border",items:c,dockedItems:[d]});this.callParent(arguments);function f(){for(var h in me.myMeta.fields){var k=me.myMeta.fields[h];a.addDataItem(k.name,true);var j=b.treeStore.getNodeById(k.name);if(j){j.set("checked",true)}else{k.checked=true;b.addUdpField(k)}}}function g(){var l=_SM.getFieldDict(me.myMeta),n=a.getList(),m={},h=[];for(var j in n){m=l[n[j]];if(!m){m=k(n[j])}if(m){h.push(_SM.clearProps(m))}}me.myMeta.fields=h;function k(o){var p=b.treeStore.getNodeById(o);return{name:p.get("id"),type:p.get("type"),readOnly:p.get("readOnly"),required:p.get("required"),tooltip:p.get("tooltip"),header:p.get("header"),cpFromZoom:p.get("cpFromZoom"),cpFromField:p.get("cpFromField"),zoomModel:p.get("zoomModel"),fkField:p.get("fkField"),fkId:p.get("fkId"),vType:p.get("vType"),prpDefault:p.get("prpDefault"),choices:p.get("choices")}}}}});Ext.define("ProtoUL.proto.ProtoFieldTree",{extend:"Ext.tree.Panel",alias:"widget.protoFieldTree",viewCode:null,myMeta:null,initComponent:function(){me=this;me.addEvents("checkModif","loadComplete");b(me.viewCode,me.myMeta.protoEntityId);this.treeStore=Ext.create("Ext.data.TreeStore",{autoLoad:true,folderSort:false,sorters:[{property:"text",direction:"ASC"}],model:"Proto.FieldSelectionModel",root:{text:_SM.__language.Protofield_Fields,expanded:true},listeners:{load:function(f,c,g,d){me.fireEvent("loadComplete",f,c,g,d)}}});var a=Ext.apply(this,{store:this.treeStore,useArrows:true,rootVisible:false,minWidth:400,columns:[{xtype:"treecolumn",text:_SM.__language.Protofield_Text,flex:2,sortable:true,minWidth:200,dataIndex:"text"},{xtype:"booleancolumn",trueText:"req",falseText:"",width:50,text:_SM.__language.Protofield_Req,dataIndex:"required"},{xtype:"booleancolumn",trueText:"rOnly",width:50,falseText:"",text:_SM.__language.Protofield_ROnly,dataIndex:"readOnly"},{text:_SM.__language.Protofield_Field_Type,dataIndex:"type"},{text:_SM.__language.Protofield_Zoom_Model,dataIndex:"zoomModel"},{text:_SM.__language.Protofield_fk_Field,dataIndex:"fkField"},{text:_SM.__language.Protofield_fk_Id,dataIndex:"fkId"},{flex:2,text:_SM.__language.Protofield_Ix,dataIndex:"id"},{flex:2,text:"cpFromZoom",dataIndex:"cpFromZoom"},{flex:2,text:"cpFromField",dataIndex:"cpFromField"},{hidden:true,text:_SM.__language.Protofield_Header,dataIndex:"header"},{hidden:true,text:_SM.__language.Protofield_Tooltip,dataIndex:"tooltip"},{hidden:true,text:_SM.__language.Protofield_Default_Value,dataIndex:"prpDefault"},{hidden:true,text:_SM.__language.Protofield_vType,dataIndex:"vType"},{hidden:true,text:_SM.__language.Protofield_choices,dataIndex:"choices"}]});a.on({checkchange:{fn:function(f,d,c){me.fireEvent("checkModif",f,d,c)}},scope:me});me.callParent(arguments);function b(c,d){Ext.define("Proto.FieldSelectionModel",{extend:"Ext.data.Model",proxy:{type:"ajax",url:_SM._PConfig.urlGetFieldTree,actionMethods:{read:"POST"},extraParams:{viewCode:c,protoEntityId:d}},fields:[{name:"id",type:"string"},{name:"text",type:"string"},{name:"type",type:"string"},{name:"readOnly",type:"boolean"},{name:"required",type:"boolean"},{name:"tooltip",type:"string"},{name:"header",type:"string"},{name:"zoomModel",type:"string"},{name:"fkField",type:"string"},{name:"fkId",type:"string"},{name:"vType",type:"string"},{name:"prpDefault",type:"string"},{name:"choices",type:"string"},{name:"cpFromZoom",type:"string"},{name:"cpFromField",type:"string"},{name:"checked",type:"boolean"},{name:"leaf",type:"boolean"}]})}},addUdpField:function(a){tNode={id:a.name,text:a.name,type:"udp",checked:a.checked,required:false,leaf:true};this.getRootNode().appendChild(tNode)}});Ext.define("ProtoUL.proto.ProtoPcl",{extend:"Ext.panel.Panel",alias:"widget.protoPcl",myMeta:null,myFieldDict:null,editable:true,initComponent:function(){var s=this,f,q,r,u,v;if(!this.myMeta){_SM.__StBar.showError("not loaded???","protoPcl.init");return}this.myFieldDict=_SM.getFieldDict(this.myMeta);s.decodeViewName(s);_SM.defineProtoPclTreeModel();f=Ext.create("ProtoUL.proto.ProtoToolBar",{dock:"top"});q=Ext.create("Ext.form.Label",{text:_SM.__language.ProtoPcl_Edition_Tool});r=p(s);u=Ext.create("Ext.data.TreeStore",{model:"Proto.PclTreeNode",root:r});this.treeGridStore=u;v=Ext.create("Ext.tree.Panel",{store:u,sortableColumns:false,useArrows:true,rootVisible:true,multiSelect:false,singleExpand:true,stripeRows:true,rowLines:true,columns:[{xtype:"treecolumn",text:"text",flex:3,dataIndex:"text"},{text:"__ptType",dataIndex:"__ptType"}],listeners:{itemmouseenter:function(y,x,z){Ext.fly(z).set({"data-qtip":n(x.data.text),"data-qtitle":x.data.text})},scope:s}});this.treeGrid=v;var j,w,l,t;j=Ext.create("ProtoUL.ux.ProtoProperty",{source:{name:""}});w=Ext.create("ProtoUL.ux.ProtoList",{idTitle:"SelectedFields"});l=Ext.create("Ext.form.TextArea",{autoScroll:true,labelAlign:"top"});t=[{region:"center",flex:3,layout:"fit",minSize:50,items:v,border:false},{region:"east",collapsible:false,split:true,flex:2,layout:"fit",minSize:200,items:[j,w,l],border:false}];Ext.apply(this,{layout:"border",items:t,dockedItems:[f],bbar:[q]});this.callParent(arguments);w.hide();l.hide();f.on({save:function(){s.save(s)},reload:function(){s.cancelChanges()},cancel:function(){s.cancelChanges()},show1:function(){_SM.showConfig("Meta",s.myMeta)},add:function(x){o(x)},del:function(x){d(x)},scope:this});v.on({select:function(A,x,z,y){h();k();s.treeRecord=x;b(x)},scope:s});j.on({beforeedit:{fn:function(y,z,x){if(s.editable===false){return false}}},edit:{fn:function(y,A,x){if(A.value===A.originalValue){return}var B,z;B=s.treeRecord.data.__ptConfig;z=A.record.data.name;if(_SM.typeOf(B)!="object"){if(!B.__ptConfig){B.__ptConfig={}}B.__ptConfig[z]=A.value}else{B[z]=A.value}}},scope:s});w.on({checked:{fn:function(x,y,z){k()}},reorder:{fn:function(){k()}},scope:s});function p(z){var A={},x,C,y,B;if(z.custom){if(z.metaConfig){B={listDisplay:z.myMeta.gridConfig.listDisplay};B=Ext.apply(B,z.myMeta.gridSets);A=Meta2Tree(B,"custom","custom")}else{A=Meta2Tree(z.myMeta.custom,"custom","custom")}}else{tmpMeta=_SM.clone(z.myMeta,0,["fields"]);tmpMeta.fieldsBase=tmpMeta.fieldsBase.sort(_SM.sortObjByName);tmpMeta.fieldsAdm=tmpMeta.fieldsAdm.sort(_SM.sortObjByName);A=Meta2Tree(tmpMeta,"pcl","pcl");for(x in A.children){C=A.children[x];if(C.text==="fields"){A.children.splice(x,1);break}}}A.expanded=true;z.treeData=_SM.clone(A);return A}function o(A){var x=A.data.__ptType,z,F,E,C,B,D,G,y;if(!x){return}z=A.data.__ptConfig||{};F=_MetaObjects[x];B=_MetaObjects[F.listOf]||{};D=_SM.ptPrompt(F.listOf,B.addPrompt);if(!D){return}E=B.nodeName||"name";C=getNodeBase(D,F.listOf,{__ptType:F.listOf});C.__ptConfig[E]=D;if(B.__ptStyle=="jsonText"){G=B.addTemplate.replace("@name",D);C.__ptConfig.__ptValue=G}else{if(B.__ptStyle=="colList"){}else{y=verifyMeta({},F.listOf,C)}}A.appendChild(C)}function d(y){var A=y.data.__ptType,z,x;z=y.parentNode;y.remove();c();if(z){x=s.treeGrid.getView();x.select(z)}}function n(x){var y=_MetaObjects[x]||{};return y.description||""}function h(){if(l.isVisible()){l.__ptConfig.__ptValue=l.getRawValue()}}function k(){if(w.isVisible()){w.__ptConfig.__ptList=Ext.encode(w.getChecked())}}function c(){l.hide();j.hide();w.hide();g()}function g(){f.setButton("add",bVisible=false,true);f.setButton("del",bVisible=false,true)}function b(y){var D,B,z,A,x;D=y.data;B=D.__ptType;z=D.__ptConfig||{};A=_MetaObjects[B]||{};x=n(y.data.text);if(x){x="<strong>"+y.data.text+"</strong> : "+x}else{x="<strong>"+B+"</strong>  [ "+y.data.text+" ]"}q.setText(x,false);c();if(A.__ptStyle=="jsonText"){l.__ptConfig=z;l.setRawValue(z.__ptValue);l.setFieldLabel(D.text);l.show()}else{if(A.__ptStyle=="colList"){w.show();w.__ptConfig=z;m(D)}else{j.show();prepareProperties(y,s.myMeta,j)}}var C=_MetaObjects[B]||{};if(C.allowAdd){f.setButton("add",true,true,_SM.__language.ProtoPcl_Add_Instance+B,y)}if(C.allowDel){f.setButton("del",true,true,_SM.__language.ProtoPcl_Del_Current+B+" ["+D.text+"]",y)}}var a;function m(B){var x,A;if(!a){a=[];for(x in s.myMeta.fieldsBase){A=s.myMeta.fieldsBase[x];a.push(A.name)}}var z,y,x,A;z=Ext.decode(B.__ptConfig.__ptList);y=[];for(x in z){A=z[x];if(s.myFieldDict[A]){y.push(A)}}w.removeAll();w.addDataSet(y,true);w.addDataSet(a)}},save:function(c){var d,a=false,b;d=Tree2Meta(c.treeGridStore.getRootNode());if(c.custom){if(c.metaConfig){c.myMeta.gridConfig.listDisplay=d.listDisplay;delete d.listDisplay;c.myMeta.gridSets=d}else{c.myMeta.custom=d}}else{d.fields=d.fieldsBase.concat(d.fieldsAdm);c.metaConfig=true;c.myMeta=d}c.encodeViewName(c);b=" [ "+c.myMeta.viewCode+" ]";if(c.myViewCode&&c.myViewCode!==c.myMeta.viewCode){a=true;b=b+"*";_SM.CloseProtoTab(c.myMeta.viewCode);delete (_SM._cllPCI[c.myMeta.viewCode])}else{_SM.savePclCache(c.myMeta.viewCode,c.myMeta,true)}c.up("window").setTitle(b);c.myMeta.metaVersion=_versionMeta;if(c.metaConfig){_SM.savePci(c.myMeta)}else{d={viewCode:"_custom."+c.myMeta.viewCode,metaVersion:_versionMeta,custom:d};_SM.savePci(d)}},cancelChanges:function(){},decodeViewName:function(a){if((!a.myMeta.viewCode)||(a.myMeta.viewCode.length==0)){a.myMeta.viewCode=a.myMeta.viewEntity}if(!a.myViewCode){if(a.myMeta.viewCode.substring(0,a.myMeta.viewEntity.length)==a.myMeta.viewEntity){a.myViewCode=a.myMeta.viewCode.toString()}else{a.myViewCode=a.myMeta.viewEntity+"."+a.myMeta.viewCode}}if(a.myMeta.viewCode.substring(0,a.myMeta.viewEntity.length)==a.myMeta.viewEntity){a.myMeta.viewCode=a.myViewCode.substring(a.myMeta.viewEntity.length+1)}},encodeViewName:function(a){if(!a.myMeta.viewCode){a.myMeta.viewCode=a.myMeta.viewEntity}else{if(a.myMeta.viewCode.substring(0,a.myMeta.viewEntity.length)!==a.myMeta.viewEntity){a.myMeta.viewCode=a.myMeta.viewEntity+"."+a.myMeta.viewCode}}}});function prepareProperties(a,h,c){var d={};var b=_SM.clone(a.data.__ptConfig),g=a.data.__ptType,j=a.data.text,f=_SM.getFieldDict(h);if(g in _SM.objConv(["field","formField"])){d=getTemplate(g,false,f[j]);b.name=j}else{d=getTemplate(g,false)}b=Ext.apply(d.__ptConfig,b);b=clearPhantonProps(b,g);c.setSource(b);c.setCombos(d.__ppChoices);c.setTypes(d.__ppTypes);c.readOnlyProps=["__ptType","name"].concat(d.__roProperties);c.sourceInfo=d.__ptHelp}function getTemplate(d,p,c){var j={},n={},r={},g={};var f,l,k,m,h,q;var a=_MetaObjects[d]||{};for(var b in a.properties){var o=a.properties[b];if(_SM.typeOf(o)=="object"){f=o.name;l=o.value}else{f=o;l=_MetaProperties[f]||null}k=_MetaProperties[f+".help"];m=_MetaProperties[f+".choices"];q=_MetaProperties[f+".type"];if(p){if(l){j[f]=l}}else{j[f]=l||"";n[f]=k;if(m){r[f]=m}if(q){g[f]=q}}}if(c){h=_SM.getFormFieldDefinition(c);j=Ext.apply(j,h)}if(p&&(!j.xtype)){j.xtype=d}if((j.xtype=="formField")&&(d=="formField")){j.xtype="textfield"}return{__ptConfig:j,__ptHelp:n,__ppChoices:r,__ppTypes:g,__roProperties:a.roProperties||[]}}Ext.define("ProtoUL.proto.ProtoToolBar",{extend:"Ext.Toolbar",alias:"widget.protoToolBar",initComponent:function(){var a=this;a.addEvents("save","preview","add","del","help","show1");Ext.apply(this,{items:[{tooltip:_SM.__language.ProtoToolbar_Upd_Def,iconCls:"icon-save",itemId:"save",scope:this,handler:function(){a.fireEvent("save")}}," ",{tooltip:_SM.__language.ProtoToolbar_Add_Node,iconCls:"icon-nodeInsert",hidden:true,itemId:"add",scope:this,handler:function(b){a.fireEvent("add",b.oData)}},{tooltip:_SM.__language.ProtoToolbar_Del_Current_Node,iconCls:"icon-nodeDelete",hidden:true,itemId:"del",scope:this,handler:function(b){a.fireEvent("del",b.oData)}}]});a.callParent(arguments)},setButton:function(d,a,f,b,g){var c=this.getComponent(d);c.setVisible(a);c.setDisabled(!f);c.setTooltip(b);c.oData=g}});function getSelectorsPanels(b,a){return[{region:"center",layout:"fit",minSize:200,items:b,border:false,flex:5},{region:"east",collapsible:true,collapsed:false,split:true,layout:"fit",minSize:200,items:a,border:false,flex:2}]}function Meta2Tree(b,n,g){var o=_MetaObjects[g];if(!o){return}function a(r){r.text=b.name||b.menuText||b.property||b.viewEntity||g;return r}function c(s){var v=[];for(var x in s){var y=s[x],u;var t=getSimpleProperties(y,w);var w=t.__ptType;if(w in _SM.objConv(["htmlset","fieldset","tabpanel","accordeon","panel"])){var r=w;if(w=="fieldset"){r+=" - "+t.title}u=getNodeBase(r,w,t);u.children=c(y.items);v.push(u)}else{if(w in _SM.objConv(["formField","protoGrid","detailButton"])){if(w=="protoGrid"){u=getNodeBase(t.menuText,w,t)}else{if(w=="detailButton"){u=getNodeBase(t.text,w,t)}else{u=getNodeBase(t.name,w,t)}}u.leaf=true;v.push(u)}}}return v}function f(s,t,r){if(s.hideItems){if(r.items){t.children=c(r.items)}else{t.children=c(r)}return true}if(s.__ptStyle=="jsonText"){if(r.name){t.__ptConfig.name=r.name}t.__ptConfig.__ptValue=Ext.encode(r);return true}if(s.__ptStyle=="colList"){t.__ptConfig.__ptList=Ext.encode(r);return true}}function h(x,s,u){var t=_MetaObjects[s];for(var v in x){var w=x[v];var r=Meta2Tree(w,n,s);u.children.push(r)}}function q(t){var s,u;if(t.lists){if(_SM.typeOf(t.lists)!="array"){t.lists=[]}else{for(var s in t.lists){var u=t.lists[s];if(typeof(u)!="string"){delete t.lists[s];continue}var r=_MetaObjects[u];if(r.__ptStyle=="colList"||r.__ptStyle=="jsonText"){continue}if(!r.listOf){continue}}}}if(t.objects){if(_SM.typeOf(t.objects)!="array"){t.lists=[]}else{for(s in t.objects){u=t.objects[s];if(typeof(u)!="string"){continue}}}}}var k=getSimpleProperties(b,g);var m=getNodeBase(g,g,k);if(f(o,m,b)){return a(m)}if(o.listOf){h(b,g,m)}q(o);for(var d in o.lists){var p=o.lists[d];var j=_MetaObjects[p],l;l=getNodeBase(p,p,{__ptType:p});if(!f(j,l,b[p])){h(b[p],j.listOf,l)}m.children.push(l)}for(var d in o.objects){var p=o.objects[d],l=Meta2Tree(b[p],p,p);m.children.push(l)}return a(m)}function Tree2Meta(c){var d,g,f=h(c);if(!f.__ptConfig){return}var j=_MetaObjects[f.__ptType];if(j.listOf){g=[];b(f.tChilds,g,"array")}else{if(j.__ptStyle in _SM.objConv(["colList","jsonText"])){g=getSimpleProperties(f.__ptConfig,f.__ptType)}else{if(j.properties||j.lists||j.objects){g=getSimpleProperties(f.__ptConfig,f.__ptType);if(f.tChilds.length>0){if(j.hideItems){g.items=[];b(f.tChilds,g.items,"array")}else{b(f.tChilds,g,"object")}}}}}return g;function b(m,o,p){var k,l,n;for(k in m){l=m[k];n=Tree2Meta(l);if(p=="object"){o[a(l)]=n}else{o.push(n)}}}function h(k){var l,m={};if(k.data){l=k.data;m.tChilds=k.childNodes}else{l=k;m.tChilds=k.children}m.__ptType=l.__ptType;if(!l.__ptConfig){m.__ptConfig={};return m}m.__ptConfig=clearPhantonProps(l.__ptConfig,m.__ptType);return m}function a(k){if(k.__ptType){return k.__ptType}else{if(k.data&&k.data.__ptType){return k.data.__ptType}}}}function getNodeBase(a,c,b){return{id:Ext.id(),text:a,__ptType:c,__ptConfig:b,children:[]}}Ext.define("ProtoUL.ux.FieldHtmlEditor",{extend:"Ext.form.HtmlEditor",alias:"widget.htmlfield",initComponent:function(){Ext.apply(this,{plugins:a()});this.callParent();function a(){return[new ProtoUL.ux.HtmlEditor.Word(),new ProtoUL.ux.HtmlEditor.Table(),new ProtoUL.ux.HtmlEditor.HR(),new ProtoUL.ux.HtmlEditor.SpecialCharacters(),new ProtoUL.ux.HtmlEditor.MidasFormat()]}},setReadOnly:function(c){var b=this;if(b.initialized&&c!=undefined){var a=b.getToolbar();a.setVisible(!c)}b.superclass.setReadOnly(c)}});Ext.define("ProtoUL.ux.HtmlEditor.HR",{extend:"Ext.util.Observable",langTitle:"Horizontal Rule",langToolTip:"Insert horizontal rule with configurable lenght",langHelp:"Enter the width of the Rule in percentage<br/> followed by the % sign at the end, or to<br/> set a fixed width ommit the % symbol.",langInsert:"Insert",langCancel:"Cancel",langWidth:"Width",defaultHRWidth:"100%",cmd:"hr",init:function(a){this.cmp=a;this.cmp.on("render",this.onRender,this)},onRender:function(){var b=this.cmp.getToolbar().add("-",{iconCls:"x-edit-hr",handler:a,scope:this,tooltip:{title:this.langTitle,text:this.langToolTip},overflowText:this.langTitle});function a(){if(!this.hrWindow){this.hrWindow=Ext.create("Ext.window.Window",{title:this.langTitle,width:250,closeAction:"hide",items:[{xtype:"form",itemId:"insert-hr",border:false,plain:true,bodyStyle:"padding: 10px;",labelWidth:60,labelAlign:"right",items:[{xtype:"label",html:this.langHelp+"<br/>&nbsp;"},{xtype:"textfield",maskRe:/[0-9]|%/,regex:/^[1-9][0-9%]{1,3}/,fieldLabel:this.langWidth,name:"hrwidth",anchor:"-20px;",value:this.defaultHRWidth,listeners:{specialkey:function(c,d){if((d.getKey()==d.ENTER||d.getKey()==d.RETURN)&&c.isValid()){this.doInsertHR()}},scope:this}}]}],buttons:[{text:this.langInsert,handler:function(){var c=this.hrWindow.getComponent("insert-hr").getForm();if(c.isValid()){this.doInsertHR()}else{c.findField("hrwidth").getEl().frame()}},scope:this},{text:this.langCancel,handler:function(){this.hrWindow.hide()},scope:this}],listeners:{render:(Ext.isGecko)?this.focusHRLong:this.focusHR,show:this.focusHR,move:this.focusHR,scope:this}})}this.hrWindow.show()}},focusHRLong:function(a){this.focus(a,600)},focusHR:function(a){this.focus(a,100)},focus:function(b,a){b.getComponent("insert-hr").getForm().findField("hrwidth").focus(true,a)},doInsertHR:function(){var b=this.hrWindow.getComponent("insert-hr").getForm();if(b.isValid()){var a=b.findField("hrwidth").getValue();if(a){this.insertHR(a)}else{this.insertHR(this.defaultHRWidth)}b.reset();this.hrWindow.hide()}},insertHR:function(a){this.cmp.insertAtCursor('<hr width="'+a+'">')}});Ext.define("ProtoUL.ux.HtmlEditor.SpecialCharacters",{extend:"Ext.util.Observable",langTitle:"Insert Special Character",langToolTip:"Insert special languaje character ",langInsert:"Insert",langCancel:"Cancel",specialChars:[153],charRange:[160,256],chars:[],init:function(a){this.cmp=a;this.cmp.on("render",this.onRender,this)},onRender:function(){var a=this.cmp.getToolbar().add({iconCls:"x-edit-char",handler:b,scope:this,tooltip:{title:this.langTitle,text:this.langToolTip},overflowText:this.langTitle});function b(){if(!this.chars.length){if(this.specialChars.length){Ext.each(this.specialChars,function(g,f){this.chars[f]=["&#"+g+";"]},this)}for(var c=this.charRange[0];c<this.charRange[1];c++){this.chars.push(["&#"+c+";"])}}var d=Ext.create("Ext.data.ArrayStore",{fields:["char"],data:this.chars});this.charWindow=Ext.create("Ext.window.Window",{title:this.langTitle,width:436,height:245,layout:"fit",plain:true,items:[{xtype:"dataview",store:d,itemId:"charView",autoHeight:true,multiSelect:true,tpl:new Ext.XTemplate('<tpl for="."><div class="char-item">{char}</div></tpl><div class="x-clear"></div>'),overItemCls:"char-over",itemSelector:"div.char-item",trackOver:true,listeners:{itemdblclick:function(h,g,k,j,l,f){this.insertChar(g.get("char"));this.charWindow.close()},scope:this}}],buttons:[{text:this.langInsert,handler:function(){var f=this.charWindow.down("#charView");Ext.each(f.getSelectedNodes(),function(g){var h=f.getRecord(g).get("char");this.insertChar(h)},this);this.charWindow.close()},scope:this},{text:this.langCancel,handler:function(){this.charWindow.close()},scope:this}]});this.charWindow.show()}},insertChar:function(a){if(a){this.cmp.insertAtCursor(a)}}});Ext.define("ProtoUL.ux.HtmlEditor.Table",{extend:"Ext.util.Observable",langTitle:"Insert Table",langToolTip:"Insert table de NxN with configurable border",langInsert:"Insert",langCancel:"Cancel",langRows:"Rows",langColumns:"Columns",langBorder:"Border",langCellLabel:"Label Cells",cmd:"table",showCellLocationText:true,cellLocationText:"{0}&nbsp;-&nbsp;{1}",tableBorderOptions:[["1px dotted #000","Dotted"],["1px solid #000","Sold Thin"],["2px solid #000","Solid Thick"]],init:function(a){this.cmp=a;this.cmp.on("render",this.onRender,this)},onRender:function(){var b=this.cmp.getToolbar().add("-",{iconCls:"x-edit-table",handler:a,scope:this,tooltip:{title:this.langTitle,text:this.langToolTip},overflowText:this.langTitle});function a(){if(!this.tableWindow){this.tableWindow=Ext.create("Ext.window.Window",{title:this.langTitle,closeAction:"hide",width:300,items:[{itemId:"insert-table",xtype:"form",border:false,plain:true,bodyStyle:"padding: 10px;",labelWidth:65,labelAlign:"right",items:[{xtype:"numberfield",allowBlank:false,allowDecimals:false,fieldLabel:this.langRows,name:"row",width:150,minValue:1,value:1},{xtype:"numberfield",allowBlank:false,allowDecimals:false,fieldLabel:this.langColumns,name:"col",width:150,minValue:1,value:1},{xtype:"combo",fieldLabel:this.langBorder,name:"border",forceSelection:true,mode:"local",store:Ext.create("Ext.data.ArrayStore",{autoDestroy:true,fields:["spec","val"],data:this.tableBorderOptions}),triggerAction:"all",value:"1px dotted #000",displayField:"val",valueField:"spec",anchor:"-15",editable:false}]}],buttons:[{text:this.langInsert,handler:function(){var j=this.tableWindow.getComponent("insert-table").getForm();if(j.isValid()){var f=j.findField("border").getValue();var c=[j.findField("row").getValue(),j.findField("col").getValue()];if(c.length==2&&c[0]>0&&c[1]>0){var l=Math.floor(100/c[1]);var h="<table style='border-collapse: collapse'>";var g="&nbsp;";for(var k=0;k<c[0];k++){h+="<tr>";for(var d=0;d<c[1];d++){h+="<td width='"+l+"%' style='border: "+f+";'>";h+=g;h+="</td>"}h+="</tr>"}h+="</table>";this.cmp.insertAtCursor(h)}this.tableWindow.hide()}else{if(!j.findField("row").isValid()){j.findField("row").getEl().frame()}else{if(!j.findField("col").isValid()){j.findField("col").getEl().frame()}}}},scope:this},{text:this.langCancel,handler:function(){this.tableWindow.hide()},scope:this}]})}this.tableWindow.show()}}});Ext.define("ProtoUL.ux.HtmlEditor.Word",{extend:"Ext.util.Observable",langTitle:"Word Paste",langToolTip:"Cleanse text pasted from Word or other Rich Text applications",wordPasteEnabled:true,curLength:0,lastLength:0,lastValue:"",init:function(a){this.cmp=a;this.cmp.on("render",this.onRender,this);this.cmp.on("initialize",this.onInit,this,{delay:100,single:true})},onInit:function(){Ext.EventManager.on(this.cmp.getDoc(),{keyup:this.checkIfPaste,scope:this});this.lastValue=this.cmp.getValue();this.curLength=this.lastValue.length;this.lastLength=this.lastValue.length},checkIfPaste:function(c){var a=0;this.curLength=this.cmp.getValue().length;if(c.V==c.getKey()&&c.ctrlKey&&this.wordPasteEnabled){this.cmp.suspendEvents();a=this.findValueDiffAt(this.cmp.getValue());var b=[this.cmp.getValue().substr(0,a),this.fixWordPaste(this.cmp.getValue().substr(a,(this.curLength-this.lastLength))),this.cmp.getValue().substr((this.curLength-this.lastLength)+a,this.curLength)];this.cmp.setValue(b.join(""));this.cmp.resumeEvents()}this.lastLength=this.cmp.getValue().length;this.lastValue=this.cmp.getValue()},findValueDiffAt:function(b){for(var a=0;a<this.curLength;a++){if(this.lastValue[a]!=b[a]){return a}}},fixWordPaste:function(a){var b=[/&nbsp;/ig,/[\r\n]/g,/<(xml|style)[^>]*>.*?<\/\1>/ig,/<\/?(meta|object|span)[^>]*>/ig,/<\/?[A-Z0-9]*:[A-Z]*[^>]*>/ig,/(lang|class|type|href|name|title|id|clear)=\"[^\"]*\"/ig,/style=(\'\'|\"\")/ig,/<![\[-].*?-*>/g,/MsoNormal/g,/<\\?\?xml[^>]*>/g,/<\/?o:p[^>]*>/g,/<\/?v:[^>]*>/g,/<\/?o:[^>]*>/g,/<\/?st1:[^>]*>/g,/&nbsp;/g,/<\/?SPAN[^>]*>/g,/<\/?FONT[^>]*>/g,/<\/?STRONG[^>]*>/g,/<\/?H1[^>]*>/g,/<\/?H2[^>]*>/g,/<\/?H3[^>]*>/g,/<\/?H4[^>]*>/g,/<\/?H5[^>]*>/g,/<\/?H6[^>]*>/g,/<\/?P[^>]*><\/P>/g,/<!--(.*)-->/g,/<!--(.*)>/g,/<!(.*)-->/g,/<\\?\?xml[^>]*>/g,/<\/?o:p[^>]*>/g,/<\/?v:[^>]*>/g,/<\/?o:[^>]*>/g,/<\/?st1:[^>]*>/g,/style=\"[^\"]*\"/g,/style=\'[^\"]*\'/g,/lang=\"[^\"]*\"/g,/lang=\'[^\"]*\'/g,/class=\"[^\"]*\"/g,/class=\'[^\"]*\'/g,/type=\"[^\"]*\"/g,/type=\'[^\"]*\'/g,/href=\'#[^\"]*\'/g,/href=\"#[^\"]*\"/g,/name=\"[^\"]*\"/g,/name=\'[^\"]*\'/g,/ clear=\"all\"/g,/id=\"[^\"]*\"/g,/title=\"[^\"]*\"/g,/<span[^>]*>/g,/<\/?span[^>]*>/g,/<title>(.*)<\/title>/g,/class=/g,/<meta[^>]*>/g,/<link[^>]*>/g,/<style>(.*)<\/style>/g,/<w:[^>]*>(.*)<\/w:[^>]*>/g];Ext.each(b,function(c){a=a.replace(c,"")});a=a.replace(/<div[^>]*>/g,"<p>");a=a.replace(/<\/?div[^>]*>/g,"</p>");return a},onRender:function(){this.cmp.getToolbar().add("-",{iconCls:"x-edit-wordpaste",pressed:true,handler:function(a){a.toggle(!a.pressed);this.wordPasteEnabled=!this.wordPasteEnabled},scope:this,tooltip:{text:this.langToolTip,title:this.langTitle},overflowText:this.langTitle})}});Ext.define("ProtoUL.ux.HtmlEditor.MidasCommand",{extend:"Ext.util.Observable",init:function(a){this.cmp=a;this.btns=[];this.cmp.on("render",this.onRender,this);this.cmp.on("initialize",this.onInit,this,{delay:100,single:true})},onInit:function(){Ext.EventManager.on(this.cmp.getDoc(),{mousedown:this.onEditorEvent,dblclick:this.onEditorEvent,click:this.onEditorEvent,keyup:this.onEditorEvent,buffer:100,scope:this})},onRender:function(){var d,a=this.cmp.getToolbar(),c,b;Ext.each(this.midasBtns,function(f){if(Ext.isObject(f)){b=(f.iconCls)?f.iconCls:"x-edit-"+f.cmd;if(f.value){b=b+"-"+f.value.replace(/[<>\/]/g,"")}d={iconCls:b,handler:function(){this.cmp.relayCmd(f.cmd,f.value)},scope:this,tooltip:f.tooltip||{title:f.title},overflowText:f.overflowText||f.title}}else{d=Ext.create("Ext.toolbar.Separator")}c=a.add(d);if(f.enableOnSelection){c.disable()}this.btns.push(c)},this)},onEditorEvent:function(){var a=this.cmp.getDoc();Ext.each(this.btns,function(c,d){if(this.midasBtns[d].enableOnSelection||this.midasBtns[d].disableOnSelection){if(a.getSelection){if((this.midasBtns[d].enableOnSelection&&a.getSelection()!=="")||(this.midasBtns[d].disableOnSelection&&a.getSelection()==="")){c.enable()}else{c.disable()}}else{if(a.selection){if((this.midasBtns[d].enableOnSelection&&a.selection.createRange().text!=="")||(this.midasBtns[d].disableOnSelection&&a.selection.createRange().text==="")){c.enable()}else{c.disable()}}}}if(this.midasBtns[d].monitorCmdState){c.toggle(a.queryCommandState(this.midasBtns[d].cmd))}},this)}});Ext.define("ProtoUL.ux.HtmlEditor.MidasFormat",{extend:"ProtoUL.ux.HtmlEditor.MidasCommand",midasBtns:["|",{enableOnSelection:true,cmd:"removeFormat",tooltip:{text:"Remove Formatting"},overflowText:"Remove Formatting"}]});Ext.define("ProtoUL.ux.CheckColumn",{extend:"Ext.grid.column.Column",alias:"widget.mycheckcolumn",stopSelection:true,tdCls:Ext.baseCSSPrefix+"grid-cell-checkcolumn",constructor:function(){this.addEvents("beforecheckchange","checkchange");this.callParent(arguments)},processEvent:function(g,j,n,b,h,d){var f=this,m=g==="keydown"&&d.getKey(),a=g=="mousedown";if(a||(m==d.ENTER||m==d.SPACE)){if(this.readOnly){return false}if(this.inGrid){if(!this.ownerCt.ownerCt.ownerCt.editable){return false}}var c=j.panel.store.getAt(b),k=f.dataIndex,l=!c.get(k);if(f.fireEvent("beforecheckchange",c,b,l)!==false){c.set(k,l);f.fireEvent("checkchange",c,b,l);if(a){d.stopEvent()}if(!f.stopSelection){j.selModel.selectByPosition({row:b,column:h})}return false}else{return !f.stopSelection}}else{return f.callParent(arguments)}},renderer:function(b){var c=Ext.baseCSSPrefix,a=[c+"grid-checkheader"];if(b){a.push(c+"grid-checkheader-checked")}return'<div class="'+a.join(" ")+'">&#160;</div>'}});Ext.define("ProtoUL.ux.GridHeaderToolTip",{alias:"plugin.headertooltip",init:function(a){var b=a.headerCt;if(!b){return}a.headerCt.on("afterrender",function(c){a.tip=Ext.create("Ext.tip.ToolTip",{target:b.el,delegate:".x-column-header",trackMouse:true,renderTo:Ext.getBody(),listeners:{beforeshow:function(d){var f=b.down("gridcolumn[id="+d.triggerElement.id+"]");if(f&&f.tooltip){d.update(f.tooltip)}else{return false}}}})})}});Ext.define("ProtoUL.ux.protoMenu",{extend:"Ext.menu.Menu",alias:"widget.protoMenu",afterRender:function(){this.superclass.afterRender.apply(this,arguments);var a=this;this.tip=new Ext.ToolTip({target:this.getEl().getAttribute("id"),renderTo:document.body,trackMouse:true,delegate:".x-menu-item",title:"",listeners:{beforeshow:function(b){var d=a.activeItem.initialConfig;if(d&&d.qtip){b.setTitle(d.text);b.update(d.qtip)}else{b.update(d.text)}}}})}});Ext.define("Ext.ux.HelpQbe",{extend:"Ext.form.field.Trigger",alias:"widget.HelpQbe",triggerCls:Ext.baseCSSPrefix+"form-search-trigger",autoWidth:true,isLoaded:false,initComponent:function(){var a=this;a.myMeta=_SM._cllPCI[a.viewCode];a.createHelpWindow(a);this.callParent(arguments);this.on("specialkey",function(b,c){if(c.getKey()==c.ENTER){this.enterKey()}},this)},createHelpWindow:function(c){Ext.define("Model_"+c.fieldLabel,{extend:"Ext.data.Model",fields:[""+c.name]});this.myStore=Ext.create("Ext.data.Store",{model:"Model_"+c.fieldLabel,proxy:{type:"ajax",url:_SM._PConfig.urlHelpQbe,reader:{type:"json",root:"data",totalProperty:"totalCount"},actionMethods:{read:"POST"},extraParams:{query:c.myMeta.sql,field:c.name}},autoLoad:false});var a=Ext.create("Ext.grid.Panel",{region:"center",store:this.myStore,columns:[{text:c.fieldLabel,dataIndex:c.name,flex:1}],height:400,width:400,bbar:Ext.create("Ext.PagingToolbar",{store:this.myStore,displayInfo:true,displayMsg:_SM.__language.HelpQBE_GridNav_DisplayMsg,emptyMsg:_SM.__language.HelpQBE_GridNav_EmptyMsg})});a.on({itemdblclick:{fn:function(h,d,j,f,k,g){c.selectValue()},scope:c}});c.win=Ext.widget("window",{title:_SM.__language.HelpQBE_Window_Title+" : ",closeAction:"hide",modal:true,width:400,minWidth:400,height:400,minHeight:400,resizable:true,layout:{type:"border"},items:[{xtype:"toolbar",items:[{height:25,xtype:"textfield",flex:1,validator:function(d){if(d==""){this.up("toolbar").down("container[name=_TOOLS_]").disable()}else{this.up("toolbar").down("container[name=_TOOLS_]").enable()}return true}},{xtype:"container",name:"_TOOLS_",disabled:true,items:[{xtype:"button",width:25,text:">",tooltip:_SM.__language.HelpQBE_Tooltip_PlusThan_Button,handler:function(){this.up("window").addText(this)}},{xtype:"button",width:25,text:"<",tooltip:_SM.__language.HelpQBE_Tooltip_LessThan_Button,handler:function(){this.up("window").addText(this)}},{xtype:"button",width:25,text:">=",tooltip:_SM.__language.HelpQBE_Tooltip_PlusEqualThan_Button,handler:function(){this.up("window").addText(this)}},{xtype:"button",width:25,text:"<=",tooltip:_SM.__language.HelpQBE_Tooltip_LessEqualThan_Button,handler:function(){this.up("window").addText(this)}},{xtype:"button",width:25,text:"<>",tooltip:_SM.__language.HelpQBE_Tooltip_Different_Button,handler:function(){this.up("window").addText(this)}},{xtype:"button",width:25,text:":",tooltip:_SM.__language.HelpQBE_Tooltip_Between_Button,handler:function(){this.up("window").addText(this)}},{xtype:"button",width:25,text:"*",tooltip:_SM.__language.HelpQBE_Tooltip_Containing_Button,handler:function(){this.up("window").addText(this)}}]}],region:"north"},a],dockedItems:[{xtype:"toolbar",dock:"bottom",ui:"footer",defaults:{minWidth:75},items:[{xtype:"tbtext",text:"",id:c.idStBar},{xtype:"component",flex:1},{xtype:"button",text:_SM.__language.Text_Accept_Button,scope:c,handler:c.doReturn,iconCls:"icon-accept"},{xtype:"button",text:_SM.__language.Text_Cancel_Button,scope:c,handler:b,iconCls:"icon-cancel"}]}],addText:function(f){var h=this.down("textfield").getValue();var g="";for(var d=0;d<h.length;d++){var j=h.substring(d,d+1);if(!(j==">"||j=="<"||j=="="||j=="*")){if(j==":"){break}else{g=g+j}}}switch(f.text){case":":this.down("textfield").setValue(g+""+f.text);break;case"*":this.down("textfield").setValue(f.text+""+g+""+f.text);break;default:this.down("textfield").setValue(f.text+""+g)}}});c.isLoaded=true;function b(){c.win.hide()}},onTriggerClick:function(){this.showHelpForm(this)},showHelpForm:function(a){if(!a.isLoaded){return a.win.show()}a.win.down("textfield").setValue(a.getValue());a.myStore.load()},selectValue:function(){var b=this.win.down("gridpanel").getSelectionModel().getSelection();var a=b[0];var c=this.win.down("textfield").getValue();var d=c.substring(c.length-1,c.length);if(d==":"){this.win.down("textfield").setValue(c+a.data[this.name])}else{this.win.down("textfield").setValue(a.data[this.name])}},doReturn:function(){this.setValue(this.win.down("textfield").getValue());this.win.hide()}});Ext.define("ProtoUL.ux.HtmlSet",{extend:"Ext.panel.Panel",alias:"widget.htmlset",border:false,layout:{type:"vbox",align:"stretch"},htlmFields:[],htmlPanels:{},height:200,flex:1,initComponent:function(){var d=this,g=[],c=this.myConfig;if(this.title){d.setTitle(this.title)}for(var a in this.htlmFields){var f=this.htlmFields[a];var b=Ext.create("Ext.panel.Panel",{__ptConfig:f,layout:{padding:5},autoScroll:true,html:"",title:f.fieldLabel||f.name,tools:[{type:"formUpd",itemId:"edithtml",tooltip:_SM.__language.Tooltip_Open_HtmlEditor,scope:this,handler:function(k,l,h,j){var m=h.ownerCt;openHtmlEditorWin(m)}}],collapsible:true,flex:1,setReadOnly:function(h){var j=this.getHeader();if(j){j=j.child("#edithtml")}if(j){j.setVisible(!h)}}});g.push(b);this.htmlPanels[f.name]=b}Ext.apply(this,{items:g});this.callParent(arguments)}});function openHtmlEditorWin(f){var a=Ext.create("ProtoUL.ux.FieldHtmlEditor",{value:f.rawHtml,border:false});var d=Ext.create("Ext.window.Window",{title:f.title,height:300,width:720,modal:true,layout:"fit",minHeight:200,minWidth:300,resizable:true,items:a,dockedItems:[{xtype:"toolbar",dock:"bottom",ui:"footer",items:["->",{iconCls:"icon-save",itemId:"save",text:_SM.__language.Text_Save_Button,scope:this,handler:b},{iconCls:"icon-reset",text:_SM.__language.Text_Return_Button,scope:this,handler:c}]}]});function b(){var g=a.getValue();f.update(g);f.rawHtml=g;d.close()}function c(){d.close()}d.show()}Ext.define("ProtoUL.ux.Login",{extend:"Ext.form.Panel",alias:"widget.protoLogin",bodyStyle:"padding:10px",labelWidth:120,labelAlign:"right",redirectUrl:false,username:"",defaults:{xtype:"textfield",anchor:"100%",enableKeyEvents:true},initComponent:function(){this.submitButton=new Ext.Button({text:_SM.__language.Text_Validate_Login_Button,iconCls:"st-user-go",scope:this,handler:this.submitLogin});this.resetButton=new Ext.Button({itemId:"resetPWDButton",text:_SM.__language.Text_Forgotten_Password,iconCls:"st-user-who",scope:this,handler:this.resetPassword});this.changeButton=new Ext.Button({text:_SM.__language.Text_change_Password_Button,iconCls:"st-key-go",scope:this,handler:this.changePassword});Ext.apply(this,{items:[{fieldLabel:_SM.__language.Textfield_User_Login,itemId:"loginField",name:"login",value:this.username,listeners:{scope:this,keydown:this.onKeyEnter}},{fieldLabel:_SM.__language.Textfield_Password_Login,inputType:"password",name:"password",listeners:{scope:this,keydown:this.onKeyEnter}}],dockedItems:[{xtype:"toolbar",dock:"bottom",ui:"footer",items:[{xtype:"tbtext",flex:1,itemId:"stLogin"},this.submitButton,this.resetButton,this.changeButton]}]});this.callParent(arguments);this.stLogin=this.dockedItems.items[0].getComponent("stLogin");this.on("afterlayout",function(){if(this.username==""){this.getForm().findField("login").focus()}else{this.getForm().findField("password").focus()}})},onKeyEnter:function(a,b){if(b.getKey()==b.ENTER){this.submitLogin()}},submitLogin:function(a){if(!a){a=this.submitButton}a.disable();var c=this.getForm(),b=this;Ext.applyIf(this.options,{scope:this,success:Ext.emptyFn,failure:Ext.emptyFn});if(c.isValid()){a.setIconCls("st-loading");c.submit({method:"POST",url:_SM._PConfig.urlGetUserRights,scope:b,success:function(d,f){_SM._UserInfo=f.result.userInfo;_SM.__language=f.result.language;_SM._UserInfo.perms={};b.options.success.call(b.options.scope,d,f)},failure:function(d,f){try{b.showFormError(f.result.message)}catch(g){b.showFormError(f.response.responseText)}b.options.failure.call(b.options.scope,d,f)}})}else{a.enable()}},showFormError:function(a){var b=window.Ext.create("Ext.tip.ToolTip",{html:a,autoShow:true,autoScroll:true,focusOnToFront:true,autoHide:true,stateful:false,getTargetXY:function(){var d=Ext.ComponentQuery.query("button[itemId=resetPWDButton]")[0];var c=d.getPosition()[0];var f=d.getPosition()[1];return[c,f]},listeners:{hide:function(){b.destroy();b=null}}});b.show();this.submitButton.enable();this.submitButton.setIconCls("st-user-go");this.getForm().findField("login").focus()},resetPassword:function(a){var b=Ext.create("ProtoUL.view.password.ForgotPasswordForm");b.show()},changePassword:function(a){Ext.create("ProtoUL.view.password.PasswordReset").show()}});Ext.define("ProtoUL.ux.parameterWin",{extend:"Ext.window.Window",alias:"widget.parameterWin",parameters:[],isUpload:false,width:400,minWidth:300,title:"Parameters form",layout:"fit",acceptText:"Accept",cancelText:"Cancel",options:{acceptFn:null,cancelFn:null},initComponent:function(){var b,d,f=this,c=[];for(b in this.parameters){d=_SM.getFormFieldDefinition(this.parameters[b]);c.push(d);if(d.xtype==="filefield"){f.isUpload=true}}Ext.applyIf(this.options,{scope:this,acceptFn:Ext.emptyFn,cancelFn:Ext.emptyFn});var a=Ext.emptyFn;if(f.isUpload){a=f.doUploadAction}else{a=f.accept}var g=[{text:this.cancelText,iconCls:"icon-cancel",scope:this,handler:this.cancel},{text:this.acceptText,iconCls:"icon-accept",scope:this,handler:a,disabled:true,formBind:true}];Ext.apply(this,{items:[{xtype:"form",autoScroll:true,monitorValid:true,items:[{xtype:"fieldset",defaultType:"textfield",layout:"column",defaults:{padding:"2 2",columnWidth:1},fieldDefaults:{labelAlign:"left",labelWidth:150,msgTarget:"side"},items:c}],buttons:g}]});f.callParent(arguments)},accept:function(){var f,b,c,d,a;f=this.down("form").getForm();if(f.isValid()){b=f.getFields().items;d=[];for(a in b){c=b[a];d.push({parameter:c.getName(),value:c.getValue()});if(c.fkId&&c.zoomRecord){d.push({parameter:c.fkId,value:c.zoomRecord.data.id})}}this.options.acceptFn.call(this.options.scope,d);this.close()}},cancel:function(){this.options.cancelFn.call(this.options.scope);this.close()},doUploadAction:function(){var b=this;var a=b.down("form").getForm();if(a.isValid()){a.submit({url:_SM._PConfig.urlLoadFile,method:"POST",waitMsg:"Uploading your file...",success:function(h,d){var c=d.result,g=c.data;b.close()},failure:function(d,c){Ext.Msg.alert("Failure",c.failureType+": error, try again later!")}})}}});Ext.define("ProtoUL.ux.Printer",{requires:"Ext.XTemplate",statics:{gridPrint:function(c){var b=this.getGridColumns(c);var f=this.getGridData(c,b);var h=Ext.create("Ext.XTemplate",this.headerTpl).apply(b);var a=Ext.create("Ext.XTemplate",this.bodyTpl).apply(b);a=Ext.create("Ext.XTemplate",'<tpl for=".">'+a+"</tpl>").apply(f);var d=this.htmlTpl.toString();d=d.replace(/@gridTitle@/g,c.title);d=d.replace(/@siteTitle@/g,_SM._siteTitle);d=d.replace("@headings@",h);d=d.replace("@body@",a);var g=window.open("","printgrid");g.document.write(d);if(this.printAutomatically){g.document.close();g.focus();g.print()}},sheetPrint:function(b,d){var a="<hr>"+d;var c=this.htmlTpl.toString();c=c.replace(/@gridTitle@/g,b.title);c=c.replace(/@siteTitle@/g,_SM._siteTitle);c=c.replace("@headings@","");c=c.replace("@body@",a);var f=window.open("","printgrid");f.document.write(c);if(this.printAutomatically){f.print()}},reportPrint:function(b,a){b.document.write(a);b.document.close();b.focus();b.print()},getGridData:function(b,a){var c=[];b.store.data.each(function(f){var h=[];for(var d in f.data){var g=f.data[d];Ext.each(a,function(j){if(j.dataIndex==d){h[d]=j.renderer?j.renderer(g):g}},this)}c.push(h)});return c},getGridColumns:function(d){var c=[];for(var a in d.columns){var b=d.columns[a];if(b.dataIndex){c.push(b)}}return c},printAutomatically:true,headerTpl:["<tr>",'<tpl for=".">',"<th>{text}</th>","</tpl>","</tr>","</thead>"],bodyTpl:["<tr>",'<tpl for=".">',"<td>{{dataIndex}}</td>","</tpl>","</tr>"],htmlTpl:'<!DOCTYPE html><html><head><meta content="text/html; charset=UTF-8" http-equiv="Content-Type" /><link href="/static/css/print.css" rel="stylesheet" type="text/css" media="screen,print" /><title>@gridTitle@</title></head><body><h1>@siteTitle@</h1><h2>@gridTitle@</h2><table><thead>@headings@</thead><tbody>@body@</tbody></table></body></html>'}});Ext.define("ProtoUL.ux.ProtoList",{extend:"Ext.grid.Panel",alias:"widget.protoList",columnList:["data"],idColumn:"id",dataList:[],dataSelected:[],idTitle:"",checkStyle:true,initComponent:function(){var g=this;g.addEvents("checked","reorder");var c=["__Checked"];for(var b in this.columnList){var h=this.columnList[b];if(_SM.typeOf(h)=="string"){c.push(h)}else{if(h.dataIndex){c.push(h.dataIndex)}}}this.gridStore=Ext.create("Ext.data.Store",{fields:c,idProperty:this.idColumn,data:[]});var a=[];if(g.checkStyle){a=[{xtype:"mycheckcolumn",dataIndex:"__Checked",menuDisabled:true,width:33,listeners:{checkchange:function(j,k,l){g.fireEvent("checked",j,k,l)}},scope:g}]}for(var b in this.columnList){var h=this.columnList[b];if(_SM.typeOf(h)=="string"){var d={menuDisabled:true,flex:1,text:this.idTitle,dataIndex:h}}else{if(h.dataIndex){var d=Ext.apply(h,{menuDisabled:true})}}a.push(d)}var f=Ext.apply(this,{store:this.gridStore,stripeRows:true,columns:a,viewConfig:{plugins:{ptype:"gridviewdragdrop",ddGroup:Ext.id(),dragText:_SM.__language.ProtoList_DD_Text},listeners:{drop:function(l,n,m,j,k){g.fireEvent("reorder")},scope:g}}});this.callParent(arguments);f.on({sortchange:function(k,l,m,j){g.fireEvent("reorder")},scope:g});this.addDataSet(this.dataList,false);this.addDataSet(this.dataSelected,true)},addDataSet:function(b,c){for(var a in b){var d=b[a];this.addDataItem(d,c)}},addDataItem:function(g,d){var c="data",h=g,b={};if(_SM.typeOf(g)=="array"){h=g[0];j=this.columnList[0];if(_SM.typeOf(j)=="string"){c=j}else{if(j.dataIndex){c=j.dataIndex}else{return}}}var f=_SM.getRecordByDataIx(this.gridStore,c,h);if(!f){if(_SM.typeOf(g)=="string"){b={data:g}}else{for(var a in this.columnList){var j=this.columnList[a];if(_SM.typeOf(j)=="string"){b[j]=g[a]}else{if(j.dataIndex){b[j.dataIndex]=g[a]}}}}if(d==true||d==false){b.__Checked=d}this.gridStore.add(b)}else{if(d){f.set("__Checked",d)}}},removeAll:function(){this.gridStore.removeAll()},getList:function(){var a=[];this.gridStore.each(function(b){a.push(b.get("data"))});return a},getChecked:function(){var a=[];this.gridStore.each(function(b){if(b.get("__Checked")){a.push(b.get("data"))}});return a},setChecked:function(c,a){var b=_SM.getRecordByDataIx(this.gridStore,"data",c);if(b){b.set("__Checked",a)}else{this.gridStore.add({data:c,__Checked:a})}},addOrRemove:function(c,a){if(a){this.setChecked(c,true)}else{var b=_SM.getRecordByDataIx(this.gridStore,"data",c);if(b){this.gridStore.remove(b)}}}});Ext.define("ProtoUL.ux.ProtoProperty",{extend:"Ext.grid.property.Grid",alias:"widget.protoProperty",source:{},readOnlyProps:[],editable:true,sourceInfo:{},sourceConfig:{},initComponent:function(){var a=this;Ext.apply(this,{stripeRows:true,clicksToEdit:2,source:this.source,listeners:{beforeedit:function(c,d,b){if((!a.editable)||d.record.data.name in _SM.objConv(a.readOnlyProps)){return false}},itemmouseenter:function(c,b,d){var f=b.get("name"),g=a.sourceInfo[f];if(f&&f in _SM.objConv(a.readOnlyProps)){f+=" [RO]"}if(g){Ext.fly(d).set({"data-qtip":g,"data-qtitle":f})}},scope:a}});this.callParent(arguments)},setCombos:function(c){var h,d,g,b,a="cbValue",f;if(!c){return}for(h in c){d=c[h];f=[];for(i=0;i<d.length;i++){f.push({cbValue:d[i]})}if(this.sourceConfig[h]||_SM.typeOf(d)!=="array"){continue}g=Ext.create("Ext.data.Store",{fields:[a],data:f});b=Ext.create("Ext.form.ComboBox",{store:g,editable:false,queryMode:"local",displayField:a,valueField:a});this.sourceConfig[h]={editor:b}}},setTypes:function(a){var d,b,c;if(!a){return}for(d in a){if(this.sourceConfig[d]){continue}b=a[d];c=this.editors[b];if(c){this.sourceConfig[d]=c}}}});Ext.define("Ext.ux.protoQBE",{extend:"Ext.window.Window",alias:"widget.protoqbe",iconCls:"icon-filter",viewCode:null,defaultType:"textfield",autoHeigth:true,resizable:false,plain:true,modal:true,titulo:"",campos:{},aceptar:function(){},cancelPress:function(){},initComponent:function(){me=this;var a=new Array();if(me.titulo!==""){me.titulo="-"+me.titulo}var d=me.campos;for(i=0;i<d.length;i+=1){var b="";if(d[i].required==true){var c=_SM._requiredField;b="<strong>"+d[i].name+"</strong>"}else{b=d[i].name;var c=""}a.push({fieldLabel:Ext.util.Format.capitalize(b),afterLabelTextTpl:c,name:d[i].name,allowBlank:!d[i].required,width:300,viewCode:me.viewCode,editable:true,xtype:"HelpQbe",hideTrigger:!d[i].qbeHelp,enterKey:this.accept})}Ext.applyIf(me,{title:me.viewCode+me.titulo,items:[{xtype:"form",items:a,autoScroll:true,labelWidth:150,autoHeigth:true,maxHeight:400,width:350,flex:1,monitorValid:true,frame:true,bodyStyle:"padding:5px 10px 0",buttons:[{xtype:"button",width:10,text:_SM.__language.Text_Accept_Button,formBind:true,iconCls:"icon-accept",handler:this.accept},{xtype:"button",text:_SM.__language.Text_Cancel_Button,iconCls:"icon-cancel",width:10,handler:this.cancel}]}]});me.callParent(arguments)},accept:function(){var d=me.down("form").getForm();if(d.isValid()){var a=me.down("form").items.items;arrFilterQbe=new Array();var c="";for(i=0;i<a.length;i++){if(a[i].getValue().trim()!==""){var b={property:a[i].getName(),filterStmt:a[i].getValue()};arrFilterQbe.push(b)}}me.aceptar(arrFilterQbe);me.close()}},cancel:function(){me.cancelPress();me.close()}});Ext.define("ProtoUL.ux.ProtoSearchBG",{extend:"Ext.toolbar.Toolbar",alias:"widget.protoSearch",myMeta:null,initComponent:function(){var f=this;var a=this.myMeta;var d=new Ext.button.Button({tooltip:_SM.__language.Tooltip_Filter_Grid_Button,iconCls:"icon-filter",handler:g});var j=new Ext.button.Button({tooltip:_SM.__language.Text_Toolbar_Remove_Filters,handler:k,iconCls:"icon-filterdelete"});var c=new Ext.form.TextField({emptyText:_SM.__language.Text_Toolbar_Search_Field,enableKeyEvents:true,width:200,listeners:{keydown:function(l,m){if(m.getKey()==m.ENTER){g(d)}}}});f.protoEnable=(f.myMeta.gridConfig.searchFields.length>0);Ext.apply(f,{border:false,disabled:!f.protoEnable,items:[c,d,j]});f.addEvents("qbeLoadData");f.callParent();h();function g(m){var n=c.getValue();var l='" '+c.getValue()+' "';f.fireEvent("qbeLoadData",f,[{property:"_allCols",filterStmt:n}],l)}function k(l){h();f.fireEvent("qbeLoadData",f,[],"",[])}function b(m){data=f.myMeta;resp=data.fields;var l=Ext.create("Ext.ux.protoQBE",{campos:data.fields,viewCode:data.viewCode,titulo:data.shortTitle,aceptar:function(n){console.log("ok");f.fireEvent("qbeLoadData",f,n,"** qbe")}}).show()}function h(){c.setValue("")}}});Ext.define("ProtoUL.ux.protoZoom",{extend:"Ext.form.field.Trigger",alias:"widget.protoZoom",zoomModel:null,zoomGrid:null,zoomRecord:null,zoomRecords:null,zoomMultiple:false,triggerCls:Ext.baseCSSPrefix+"form-search-trigger",isLoaded:false,handleMouseEvents:true,initComponent:function(){var a=this;this.callParent(arguments);this.on("specialkey",function(b,c){if(c.getKey()==c.ENTER){this.onTriggerClick()}},this)},listeners:{render:function(a){a.getEl().on("click",this.onClickLink,this)}},onClickLink:function(a,b){if(!this.readOnly){return}if(b.nodeName=="LABEL"){return}this._loadZoom(this.doClickLink)},_loadZoom:function(b,d){var c=this,a={scope:c,success:function(h,f,g){c.createZoomWindow(c);b.call(c,c,d)},failure:function(h,f,g){return}};if(_SM.loadPci(c.zoomModel,true,a)){c.createZoomWindow(c);b.call(c,c,d)}},doClickLink:function(a){var b=Ext.create("ProtoUL.UI.FormController",{});b.openProtoForm.call(b,a.zoomModel,a.fkIdValue,false)},createZoomWindow:function(f){function d(){f.resetZoom();f.win.hide()}if(f.isLoaded){return}f.myMeta=_SM._cllPCI[f.zoomModel];f.idStBar=Ext.id();var g="single";if(f.zoomMultiple&&f.newForm){g="multi"}this.zoomGrid=Ext.create("ProtoUL.view.ProtoGrid",{gridSelectionMode:g,viewCode:f.zoomModel,initialFilter:[],hideSheet:true,listDisplay:"__str__"});var b=Ext.create("ProtoUL.ux.ProtoSearchBG",{myMeta:f.myMeta});this.zoomGrid.on({selectionChange:{fn:function(j,h,l,k){f.setSelected(l,h,j)},scope:this}});this.zoomGrid.on({rowDblClick:{fn:function(h,j){f.setSelected(j,h);f.doReturn()},scope:f}});b.on({qbeLoadData:{fn:function(j,k,h,l){f.resetZoom();this.zoomGrid.gridLoadData(this.zoomGrid,k,l)},scope:this}});var c=_SM._UserInfo.perms[f.myMeta.viewCode],a=[{xtype:"tbtext",text:"",id:f.idStBar,flex:1,readOnly:true},{xtype:"button",text:_SM.__language.Text_Cancel_Button,scope:f,handler:d},{xtype:"button",text:"Ok",scope:f,handler:f.doReturn}];f.win=Ext.widget("window",{title:"Zoom : "+f.myMeta.shortTitle,constrainHeader:true,iconCls:f.myMeta.viewIcon,closeAction:"hide",layout:"fit",modal:true,width:800,minWidth:400,height:600,minHeight:400,resizable:true,tbar:b,items:this.zoomGrid,dockedItems:[{xtype:"toolbar",dock:"bottom",ui:"footer",defaults:{minWidth:75},items:a}]});f.isLoaded=true;this.zoomGrid.setEditMode(true)},onTriggerClick:function(){this._loadZoom(this.doTriggerClick)},doTriggerClick:function(a){a.showZoomForm(a)},showZoomForm:function(c){if(!c.isLoaded){return}var d=a();if(d){if(d.length>0){this.zoomGrid.store.mySetBaseFilter(d)}}c.win.show();function a(){var h=c.zoomFilter;if(!c.zoomFilter){return h}if(!c.idProtoGrid){return h}var k=c.zoomFilter.match(/\(([^()]+)\)/g);if(k){if(k.length>0){var g=Ext.getCmp(c.idProtoGrid);for(var j in k){var n=k[j].replace("(","").replace(")","").split(",");for(var f in n){var l=n[f],m=b(g,l);h=h.replace("{0}".format(l),"{0}".format(m))}}}}h=h.split(";");for(j=0;j<h.length;j++){var o=h[j].split(":");h[j]={property:o[0].trim(),filterStmt:o[1].trim()}}return h}function b(f,h){var g;try{if(f.rowData){g=f.rowData[h.trim()]}else{g=f.myFieldDict[h.trim()]["prpDefault"]}}catch(j){g="-1"}return g}},setSelected:function(k,c,d){var b=Ext.getCmp(this.idStBar),j=this,a;function l(m){var n;if(!m){return}if(j.myMeta.returnField){n=m.get(j.myMeta.returnField)}else{n=m.get("__str__")||j.myMeta.viewCode+".str?"}return{name:j.name,fkId:j.fkId,recId:m.get("id"),recStr:n}}if(j.zoomMultiple&&j.newForm&&d){j.zoomRecords=[];var f=d.getSelection();for(a in f){j.zoomRecords.push(l(f[a]))}var g="";for(a in j.zoomRecords){g+=j.zoomRecords[a].recStr+";"}b.setText(g);j.retField=g}else{if(c){var h=l(c);j.zoomRecord=c;j.retField=h.recStr;b.setText("["+h.recId.toString()+"]  "+h.recStr)}else{j.zoomRecord=null;j.zoomRecords=null;b.setText("")}}},doReturn:function(){this.setValue(this.retField);this.win.hide()},resetZoom:function(){this.setSelected()}});if(!String.prototype.format){String.prototype.format=function(){var a=arguments;return this.replace(/{(\d+)}/g,function(b,c){return typeof a[c]!="undefined"?a[c]:b})}}Ext.define("ProtoUL.ux.StatusBar",{extend:"Ext.toolbar.Toolbar",alternateClassName:"Ext.ux.StatusBar",alias:"widget.statusbar",requires:["Ext.toolbar.TextItem"],cls:"x-statusbar",busyIconCls:"x-status-busy",busyText:_SM.__language.StatusBar_Message_Loading,autoClear:5000,emptyText:"&#160;",activeThreadId:0,defaultText:"",text:_SM.__language.StatusBar_Message_Ready,iconCls:"ready-icon",busyCount:0,initComponent:function(){var a=this.statusAlign==="right";this.callParent(arguments);this.currIconCls=this.iconCls||this.defaultIconCls;this.statusEl=Ext.create("Ext.toolbar.TextItem",{cls:"x-status-text "+(this.currIconCls||""),text:this.text||this.defaultText||""});if(a){this.cls+=" x-status-right";this.add("->");this.add(this.statusEl)}else{this.insert(0,this.statusEl);this.insert(1,"->")}this.add([{itemId:"btClearCache",xtype:"button",text:_SM.__language.StatusBar_Text_Clean_Button+" cache",tooltip:_SM.__language.StatusBar_Tooltip_Clean_Button,iconCls:"comment_delete",handler:function(){this.tooltip="";this.ownerCt.clearStatus({useDefaults:true});_SM.__TabContainer.closeAllTabs();_SM._cllPCI={}}},{itemId:"openTaskForm",xtype:"button",text:_SM.__language.StatusBar_Text_Task_Button,hidden:true,scope:this,iconCls:"taskManager",handler:this.openTaskForm},"-",{xtype:"splitbutton",text:_SM._UserInfo.fullName||_SM._UserInfo.userName,iconCls:"icon-user",menu:new Ext.menu.Menu({items:[{text:_SM.__language.StatusBar_Text_Close_Session,handler:this.closeSession,iconCls:"icon-logout"}]})}]);this.errBt=this.getComponent("btClearCache")},command:function(){Ext.MessageBox.prompt("Comando","Digite El Comando",function(a,b){if(a=="ok"){}},this,false,ValorPrompt)},closeSession:function(){Ext.Ajax.request({url:_SM._PConfig.urlLogOut,success:function(a){location.reload(true)},failure:function(){location.reload(true)}})},clearErrCount:function(){this.errBt.tooltip="";this.busyCount=0;this.clearStatus({useDefaults:true})},setStatus:function(h){var d=this;h=h||{};var b=d.isLayoutSuspended();Ext.suspendLayouts();if(Ext.isString(h)){h={text:h}}if(h.text!==undefined){d.setText(h.text)}if(h.iconCls!==undefined){d.setIcon(h.iconCls)}if(h.clear){var j=h.clear,g=d.autoClear,f={useDefaults:true,anim:true};if(Ext.isObject(j)){j=Ext.applyIf(j,f);if(j.wait){g=j.wait}}else{if(Ext.isNumber(j)){g=j;j=f}else{if(Ext.isBoolean(j)){j=f}}}j.threadId=this.activeThreadId;Ext.defer(d.clearStatus,g,d,[j])}Ext.resumeLayouts(true);return d},clearStatus:function(f){f=f||{};var c=this,b=c.statusEl;if(f.threadId&&f.threadId!==c.activeThreadId){return c}var d=f.useDefaults?c.defaultText:c.emptyText,a=f.useDefaults?(c.defaultIconCls?c.defaultIconCls:""):"";if(f.anim){b.el.puff({remove:false,useDisplay:true,callback:function(){b.el.show();c.setStatus({text:d,iconCls:a})}})}else{c.setStatus({text:d,iconCls:a})}return c},setText:function(b){var a=this;a.activeThreadId++;a.text=b||"";if(a.rendered){a.statusEl.setText(a.text)}return a},getText:function(){return this.text},setIcon:function(a){var b=this;b.activeThreadId++;a=a||"";if(b.rendered){if(b.currIconCls){b.statusEl.removeCls(b.currIconCls);b.currIconCls=null}if(a.length>0){b.statusEl.addCls(a);b.currIconCls=a}}else{b.currIconCls=a}return b},showBusyI:function(a){if(Ext.isString(a)){a={text:a}}a=Ext.applyIf(a||{},{text:this.busyText,iconCls:this.busyIconCls});return this.setStatus(a)},showBusy:function(c,b,a){this.showBusyI(c);if(a){Ext.defer(function(){this.clearStatus({useDefaults:true})},a,this)}else{this.busyCount++}},showMessage:function(d,b,a){var c={text:b+" "+d,iconCls:this.iconCls};if(a){Ext.defer(function(){this.clearStatus({useDefaults:true})},a,this)}return this.setStatus(c)},showError:function(b,a){this.setStatus({text:"Oops! "+b,iconCls:"x-status-error",clear:true})},showWarning:function(b,a){this.setStatus({text:b,iconCls:"x-status-warning",clear:true})},clear:function(b,a){this.busyCount--;if(this.busyCount<=0){this.busyCount=0;this.clearStatus({useDefaults:true})}},openTaskForm:function(){var a=Ext.create("ProtoUL.protoOrg.tasks.TaskController");a.openTaskForm()}});Ext.define("Ext.ux.TabCloseMenu",{alias:"plugin.tabclosemenu",mixins:{observable:"Ext.util.Observable"},closeTabText:_SM.__language.Text_Close_Tab,showCloseOthers:true,closeOthersTabsText:_SM.__language.Text_Close_Other_Tabs,showCloseAll:true,closeAllTabsText:_SM.__language.Text_Close_All_Tabs,extraItemsHead:null,extraItemsTail:null,constructor:function(a){this.addEvents("aftermenu","beforemenu");this.mixins.observable.constructor.call(this,a)},init:function(a){this.tabPanel=a;this.tabBar=a.down("tabbar");this.mon(this.tabPanel,{scope:this,afterlayout:this.onAfterLayout,single:true})},onAfterLayout:function(){this.mon(this.tabBar.el,{scope:this,contextmenu:this.onContextMenu,delegate:"div.x-tab"})},onBeforeDestroy:function(){Ext.destroy(this.menu);this.callParent(arguments)},onContextMenu:function(d,g){var c=this,h=c.createMenu(),f=true,j=true,b=c.tabBar.getChildByElement(g),a=c.tabBar.items.indexOf(b);c.item=c.tabPanel.getComponent(a);h.child('*[text="'+c.closeTabText+'"]').setDisabled(!c.item.closable);if(c.showCloseAll||c.showCloseOthers){c.tabPanel.items.each(function(k){if(k.closable){f=false;if(k!=c.item){j=false;return false}}return true});if(c.showCloseAll){h.child('*[text="'+c.closeAllTabsText+'"]').setDisabled(f)}if(c.showCloseOthers){h.child('*[text="'+c.closeOthersTabsText+'"]').setDisabled(j)}}d.preventDefault();c.fireEvent("beforemenu",h,c.item,c);h.showAt(d.getXY())},createMenu:function(){var b=this;if(!b.menu){var a=[{text:b.closeTabText,scope:b,handler:b.onClose}];if(b.showCloseAll||b.showCloseOthers){a.push("-")}if(b.showCloseOthers){a.push({text:b.closeOthersTabsText,scope:b,handler:b.onCloseOthers})}if(b.showCloseAll){a.push({text:b.closeAllTabsText,scope:b,handler:b.onCloseAll})}if(b.extraItemsHead){a=b.extraItemsHead.concat(a)}if(b.extraItemsTail){a=a.concat(b.extraItemsTail)}b.menu=Ext.create("Ext.menu.Menu",{items:a,listeners:{hide:b.onHideMenu,scope:b}})}return b.menu},onHideMenu:function(){var a=this;a.item=null;a.fireEvent("aftermenu",a.menu,a)},onClose:function(){this.tabPanel.remove(this.item)},onCloseOthers:function(){this.doClose(true)},onCloseAll:function(){this.doClose(false)},doClose:function(b){var a=[];this.tabPanel.items.each(function(c){if(c.closable){if(!b||c!=this.item){a.push(c)}}},this);Ext.each(a,function(c){this.tabPanel.remove(c)},this)}});Ext.define("Ext.ux.TabScrollerMenu",{alias:"plugin.tabscrollermenu",uses:["Ext.menu.Menu"],pageSize:10,maxText:15,menuPrefixText:"Items",constructor:function(a){a=a||{};Ext.apply(this,a)},init:function(b){var a=this;Ext.apply(b,a.parentOverrides);a.tabPanel=b;b.on({render:function(){a.tabBar=b.tabBar;a.layout=a.tabBar.layout;a.layout.overflowHandler.handleOverflow=Ext.Function.bind(a.showButton,a);a.layout.overflowHandler.clearOverflow=Ext.Function.createSequence(a.layout.overflowHandler.clearOverflow,a.hideButton,a)},single:true})},showButton:function(){var b=this,a=Ext.getClass(b.layout.overflowHandler).prototype.handleOverflow.apply(b.layout.overflowHandler,arguments);if(!b.menuButton){b.menuButton=b.tabBar.body.createChild({cls:Ext.baseCSSPrefix+"tab-tabmenu-right"},b.tabBar.body.child("."+Ext.baseCSSPrefix+"box-scroller-right"));b.menuButton.addClsOnOver(Ext.baseCSSPrefix+"tab-tabmenu-over");b.menuButton.on("click",b.showTabsMenu,b)}b.menuButton.show();a.reservedSpace+=b.menuButton.getWidth();return a},hideButton:function(){var a=this;if(a.menuButton){a.menuButton.hide()}},getPageSize:function(){return this.pageSize},setPageSize:function(a){this.pageSize=a},getMaxText:function(){return this.maxText},setMaxText:function(a){this.maxText=a},getMenuPrefixText:function(){return this.menuPrefixText},setMenuPrefixText:function(a){this.menuPrefixText=a},showTabsMenu:function(d){var a=this;if(a.tabsMenu){a.tabsMenu.removeAll()}else{a.tabsMenu=Ext.create("Ext.menu.Menu");a.tabPanel.on("destroy",a.tabsMenu.destroy,a.tabsMenu)}a.generateTabMenuItems();var c=Ext.get(d.getTarget());var b=c.getXY();b[1]+=24;a.tabsMenu.showAt(b)},generateTabMenuItems:function(){var k=this,h=k.tabPanel,a=h.getActiveTab(),p=h.items.getCount(),l=k.getPageSize(),d=Math.floor(p/l),n=p%l,f,j,b,m,o,c,g;if(p>l){for(f=0;f<d;f++){j=(f+1)*l;b=[];for(m=0;m<l;m++){g=m+j-l;o=h.items.get(g);b.push(k.autoGenMenuItem(o))}k.tabsMenu.add({text:k.getMenuPrefixText()+" "+(j-l+1)+" - "+j,menu:b})}if(n>0){c=d*l;b=[];for(f=c;f<p;f++){o=h.items.get(f);b.push(k.autoGenMenuItem(o))}k.tabsMenu.add({text:k.menuPrefixText+" "+(c+1)+" - "+(c+b.length),menu:b})}}else{h.items.each(function(q){if(q.id!=a.id&&!q.hidden){k.tabsMenu.add(k.autoGenMenuItem(q))}})}},autoGenMenuItem:function(b){var a=this.getMaxText(),c=Ext.util.Format.ellipsis(b.title,a);return{text:c,handler:this.showTabFromMenu,scope:this,disabled:b.disabled,tabToShow:b,iconCls:b.iconCls}},showTabFromMenu:function(a){this.tabPanel.setActiveTab(a.tabToShow)}});Ext.define("Ext.ux.statusbar.ValidationStatus",{extend:"Ext.Component",requires:["Ext.util.MixedCollection"],errorIconCls:"x-status-error",errorListCls:"x-status-error-list",validIconCls:"x-status-valid",showText:_SM.__language.Text_Validation_Form,hideText:_SM.__language.Text_Hide_Errors_Validation_Form,submitText:_SM.__language.Text_Submit_Validation_Form,init:function(a){a.on("render",function(){this.statusBar=a;this.monitor=true;this.errors=Ext.create("Ext.util.MixedCollection");this.listAlign=(a.statusAlign==="right"?"br-tr?":"bl-tl?");if(this.form){this.formPanel=Ext.getCmp(this.form);this.basicForm=this.formPanel.getForm();this.startMonitoring();this.basicForm.on("beforeaction",function(d,c){if(c.type==="submit"){this.monitor=false}},this);var b=function(){this.monitor=true};this.basicForm.on("actioncomplete",b,this);this.basicForm.on("actionfailed",b,this)}},this,{single:true});a.on({scope:this,afterlayout:{single:true,fn:function(){a.statusEl.getEl().on("click",this.onStatusClick,this,{buffer:200})}},beforedestroy:{single:true,fn:this.onDestroy}})},startMonitoring:function(){this.basicForm.getFields().each(function(a){a.on("validitychange",this.onFieldValidation,this)},this)},stopMonitoring:function(){this.basicForm.getFields().each(function(a){a.un("validitychange",this.onFieldValidation,this)},this)},onDestroy:function(){this.stopMonitoring();this.statusBar.statusEl.un("click",this.onStatusClick,this);this.callParent(arguments)},onFieldValidation:function(a,b){if(!this.monitor){return false}var c=a.getErrors()[0];if(c){this.errors.add(a.id,{field:a,msg:c})}else{this.errors.removeAtKey(a.id)}this.updateErrorList();if(this.errors.getCount()>0){if(this.statusBar.getText()!==this.showText){this.statusBar.setStatus({text:this.showText,iconCls:this.errorIconCls})}}else{this.statusBar.clearStatus().setIcon(this.validIconCls)}},updateErrorList:function(){if(this.errors.getCount()>0){var a="<ul>";this.errors.each(function(b){a+=('<li id="x-err-'+b.field.id+'"><a href="#">'+b.msg+"</a></li>")},this);this.getMsgEl().update(a+"</ul>")}else{this.getMsgEl().update("")}this.getMsgEl().setSize("auto","auto")},getMsgEl:function(){if(!this.msgEl){this.msgEl=Ext.DomHelper.append(Ext.getBody(),{cls:this.errorListCls},true);this.msgEl.hide();this.msgEl.on("click",function(b){var a=b.getTarget("li",10,true);if(a){Ext.getCmp(a.id.split("x-err-")[1]).focus();this.hideErrors()}},this,{stopEvent:true})}return this.msgEl},showErrors:function(){this.updateErrorList();this.getMsgEl().alignTo(this.statusBar.getEl(),this.listAlign).slideIn("b",{duration:300,easing:"easeOut"});this.statusBar.setText(this.hideText);this.formPanel.el.on("click",this.hideErrors,this,{single:true})},hideErrors:function(){var a=this.getMsgEl();if(a.isVisible()){a.slideOut("b",{duration:300,easing:"easeIn"});this.statusBar.setText(this.showText)}this.formPanel.el.un("click",this.hideErrors,this)},onStatusClick:function(){if(this.getMsgEl().isVisible()){this.hideErrors()}else{if(this.errors.getCount()>0){this.showErrors()}}}});Ext.define("Ext.ux.BoxReorderer",{mixins:{observable:"Ext.util.Observable"},itemSelector:".x-box-item",animate:100,constructor:function(){this.addEvents("StartDrag","Drag","ChangeIndex","Drop");this.mixins.observable.constructor.apply(this,arguments)},init:function(a){var b=this;b.container=a;b.animatePolicy={};b.animatePolicy[a.getLayout().names.x]=true;b.container.on({scope:b,boxready:b.afterFirstLayout,beforedestroy:b.onContainerDestroy})},onContainerDestroy:function(){var a=this.dd;if(a){a.unreg();this.dd=null}},afterFirstLayout:function(){var c=this,b=c.container.getLayout(),d=b.names,a;a=c.dd=Ext.create("Ext.dd.DD",b.innerCt,c.container.id+"-reorderer");Ext.apply(a,{animate:c.animate,reorderer:c,container:c.container,getDragCmp:this.getDragCmp,clickValidator:Ext.Function.createInterceptor(a.clickValidator,c.clickValidator,c,false),onMouseDown:c.onMouseDown,startDrag:c.startDrag,onDrag:c.onDrag,endDrag:c.endDrag,getNewIndex:c.getNewIndex,doSwap:c.doSwap,findReorderable:c.findReorderable});a.dim=d.width;a.startAttr=d.beforeX;a.endAttr=d.afterX},getDragCmp:function(a){return this.container.getChildByElement(a.getTarget(this.itemSelector,10))},clickValidator:function(b){var a=this.getDragCmp(b);return !!(a&&a.reorderable!==false)},onMouseDown:function(g){var f=this,a=f.container,d,b,c;f.dragCmp=f.getDragCmp(g);if(f.dragCmp){b=f.dragCmp.getEl();f.startIndex=f.curIndex=a.items.indexOf(f.dragCmp);c=b.getBox();f.lastPos=c[this.startAttr];d=a.el.getBox();if(f.dim==="width"){f.minX=d.left;f.maxX=d.right-c.width;f.minY=f.maxY=c.top;f.deltaX=g.getPageX()-c.left}else{f.minY=d.top;f.maxY=d.bottom-c.height;f.minX=f.maxX=c.left;f.deltaY=g.getPageY()-c.top}f.constrainY=f.constrainX=true}},startDrag:function(){var b=this,a=b.dragCmp;if(a){a.setPosition=Ext.emptyFn;a.animate=false;if(b.animate){b.container.getLayout().animatePolicy=b.reorderer.animatePolicy}b.dragElId=a.getEl().id;b.reorderer.fireEvent("StartDrag",b,b.container,a,b.curIndex);a.suspendEvents();a.disabled=true;a.el.setStyle("zIndex",100)}else{b.dragElId=null}},findReorderable:function(c){var d=this,a=d.container.items,b;if(a.getAt(c).reorderable===false){b=a.getAt(c);if(c>d.startIndex){while(b&&b.reorderable===false){c++;b=a.getAt(c)}}else{while(b&&b.reorderable===false){c--;b=a.getAt(c)}}}c=Math.min(Math.max(c,0),a.getCount()-1);if(a.getAt(c).reorderable===false){return -1}return c},doSwap:function(h){var d=this,c=d.container.items,a=d.container,b=d.container._isLayoutRoot,f,g,k,j;h=d.findReorderable(h);if(h===-1){return}d.reorderer.fireEvent("ChangeIndex",d,a,d.dragCmp,d.startIndex,h);f=c.getAt(d.curIndex);g=c.getAt(h);c.remove(f);k=Math.min(Math.max(h,0),c.getCount()-1);c.insert(k,f);c.remove(g);c.insert(d.curIndex,g);a._isLayoutRoot=true;a.updateLayout();a._isLayoutRoot=b;d.curIndex=h},onDrag:function(c){var b=this,a;a=b.getNewIndex(c.getPoint());if((a!==undefined)){b.reorderer.fireEvent("Drag",b,b.container,b.dragCmp,b.startIndex,b.curIndex);b.doSwap(a)}},endDrag:function(d){if(d){d.stopEvent()}var c=this,b=c.container.getLayout(),a;if(c.dragCmp){delete c.dragElId;delete c.dragCmp.setPosition;c.dragCmp.animate=true;c.dragCmp.lastBox[b.names.x]=c.dragCmp.getPosition(true)[b.names.widthIndex];c.container._isLayoutRoot=true;c.container.updateLayout();c.container._isLayoutRoot=undefined;a=Ext.fx.Manager.getFxQueue(c.dragCmp.el.id)[0];if(a){a.on({afteranimate:c.reorderer.afterBoxReflow,scope:c})}else{Ext.Function.defer(c.reorderer.afterBoxReflow,1,c)}if(c.animate){delete b.animatePolicy}c.reorderer.fireEvent("drop",c,c.container,c.dragCmp,c.startIndex,c.curIndex)}},afterBoxReflow:function(){var a=this;a.dragCmp.el.setStyle("zIndex","");a.dragCmp.disabled=false;a.dragCmp.resumeEvents()},getNewIndex:function(j){var h=this,a=h.getDragEl(),b=Ext.fly(a).getBox(),m,g,l,d,c=h.container.items.items,f=c.length,k=h.lastPos;h.lastPos=b[h.startAttr];for(d=0;d<f;d++){m=c[d].getEl();if(m.is(h.reorderer.itemSelector)){g=m.getBox();l=g[h.startAttr]+(g[h.dim]>>1);if(d<h.curIndex){if((b[h.startAttr]<k)&&(b[h.startAttr]<(l-5))){return d}}else{if(d>h.curIndex){if((b[h.startAttr]>k)&&(b[h.endAttr]>(l+5))){return d}}}}}}});Ext.define("Ext.ux.ToolbarDroppable",{constructor:function(a){Ext.apply(this,a)},init:function(a){this.toolbar=a;this.toolbar.on({scope:this,render:this.createDropTarget})},createDropTarget:function(){this.dropTarget=Ext.create("Ext.dd.DropTarget",this.toolbar.getEl(),{notifyOver:Ext.Function.bind(this.notifyOver,this),notifyDrop:Ext.Function.bind(this.notifyDrop,this)})},addDDGroup:function(a){this.dropTarget.addToGroup(a)},calculateEntryIndex:function(g){var j=0,k=this.toolbar,h=k.items.items,f=h.length,b=g.getXY()[0],c,d,a,l;for(index=0;index<f;index++){c=h[index].getEl();d=c.getXY()[0];a=c.getWidth();l=d+a/2;if(b<l){j=index;break}else{j=index+1}}return j},canDrop:function(a){return true},notifyOver:function(a,b,c){return this.canDrop.apply(this,arguments)?this.dropTarget.dropAllowed:this.dropTarget.dropNotAllowed},notifyDrop:function(a,d,f){var c=this.canDrop(a,d,f),g=this.toolbar;if(c){var b=this.calculateEntryIndex(d);g.insert(b,this.createItem(f));g.doLayout();this.afterLayout()}return c},createItem:function(a){Ext.Error.raise("The createItem method must be implemented in the ToolbarDroppable plugin")},afterLayout:Ext.emptyFn});Ext.define("ProtoUL.view.MenuTree",{extend:"Ext.tree.Panel",alias:"widget.menuTree",viewConfig:{plugins:{ptype:"treeviewdragdrop",dragText:"Drag to reorder",ddGroup:"menu"}},rootVisible:false,lines:true,minWidth:200,initComponent:function(){Ext.define("Proto.MenuModel",{extend:"Ext.data.Model",proxy:{type:"ajax",url:_SM._PConfig.urlMenu,extraParams:{forceDefault:0},actionMethods:{read:"POST"}},fields:[{name:"id",type:"string"},{name:"viewCode",type:"string"},{name:"text",type:"string"},{name:"leaf",type:"boolean"}]});this.store=Ext.create("Ext.data.TreeStore",{autoLoad:true,model:"Proto.MenuModel",root:{text:"menu",expanded:true},listeners:{datachanged:function(a,b){this.treeRecord=undefined}}});if(_SM._UserInfo.isStaff){Ext.apply(this,{dockedItems:[{xtype:"toolbar",dock:"bottom",items:[{id:"newFolder",scope:this,handler:this.newFolder,iconCls:"menu_new_folder",tooltip:_SM.__language.Tooltip_New_Folder},{id:"newOption",hidden:true,scope:this,handler:this.newOption,iconCls:"menu_new_option",tooltip:_SM.__language.Tooltip_New_Option},{id:"editNode",scope:this,handler:this.editNode,iconCls:"icon-nodeEdit",tooltip:_SM.__language.Tooltip_Edit_Node},{id:"deleteNode",scope:this,handler:this.deleteNode,iconCls:"icon-nodeDelete",tooltip:_SM.__language.Tooltip_Del_Node},"->",{id:"saveMenu",scope:this,handler:this.saveMenu,iconCls:"menu_save",tooltip:_SM.__language.Tooltip_Save_Menu},{id:"reloadMenu",scope:this,handler:this.reloadMenu,iconCls:"menu_reload",tooltip:_SM.__language.Tooltip_Reload_Menu},{id:"resetMenu",scope:this,handler:this.resetMenu,iconCls:"menu_reset",tooltip:_SM.__language.Tooltip_Reset_Menu}]}]})}this.callParent(arguments);this.addEvents("menuSelect");if(_SM._UserInfo.isSuperUser){Ext.getCmp("newOption").show()}},listeners:{itemclick:function(a,g,f,c,b,d){this.treeRecord=g},itemdblclick:function(b,h,g,d,c,f){this.treeRecord=h;if(h.get("leaf")){var a=h.data.viewCode||h.data.id;this.fireEvent("menuSelect",this,a);this.ownerCt.loadPciFromMenu(a)}}},editNode:function(a){if(this.treeRecord){var b=this,c=_SM.__language.Msg_Window_New_Folder;Ext.Msg.prompt(_SM.__language.Title_Window_New_Folder,c,function(f,d){if((f!="ok")||(!d)||(d.length==0)){return}b.treeRecord.set("text",d)},b,false,b.treeRecord.get("text"))}},deleteNode:function(a){if(this.treeRecord){this.treeRecord.remove();this.treeRecord=undefined}},newFolder:function(a){var b=this,c=_SM.__language.Msg_Window_New_Folder;Ext.Msg.prompt(_SM.__language.Title_Window_New_Folder,c,function(g,f){if(g!="ok"){return}var h={text:f,children:[]},d;if(b.treeRecord&&(!b.treeRecord.get("leaf"))){d=b.treeRecord}else{d=b.store.getRootNode()}d.appendChild(h)},b,false)},newOption:function(a){if(!this.treeRecord||this.treeRecord.get("leaf")){_SM.errorMessage("AddMenuOption",_SM.__language.Msg_Select_Folder);return}var b=Ext.widget("menuOption",{treeRecord:this.treeRecord,title:_SM.__language.Title_Window_Add_Option});b.show()},reloadMenu:function(a){this.store.getProxy().extraParams.forceDefault=0;this.store.load()},resetMenu:function(a){this.store.getProxy().extraParams.forceDefault=1;this.store.load()},saveMenu:function(b){var a=Ext.encode(c(this.store.getRootNode()));_SM.saveProtoObj("__menu",a);function c(g){var h=g.data,f=g.childNodes,j={};if(h.root){j=d(f)}else{j={text:h.text,qtip:h.qtip,qtitle:h.qtitle,iconCls:h.iconCls,id:"protoMenu-"+Ext.id(),index:h.index};if(f.length>0){j.expanded=h.expanded;j.children=d(f);j.leaf=false;j.viewCode=h.viewCode||h.id}else{j.expanded=false;j.children=[];j.leaf=h.leaf;j.viewCode=h.viewCode||h.id}}if(!j.text||j.text.length==0){j.text="null"}return j;function d(m){var n=[];for(var k in m){var l=m[k];var o=c(l);n.push(o)}return n}}}});Ext.define("ProtoUL.view.form.MenuOption",{extend:"Ext.window.Window",alias:"widget.menuOption",constructor:function(b){var a={xtype:"form",frame:true,constrain:true,bodyPadding:"5 5 0",width:400,fieldDefaults:{msgTarget:"side",labelWidth:75},defaults:{anchor:"100%"},items:[{xtype:"fieldset",title:_SM.__language.MenuTree_Title_Fieldset,defaultType:"textfield",layout:"anchor",defaults:{anchor:"100%"},items:[{fieldLabel:"text",afterLabelTextTpl:_SM._requiredField,name:"text",allowBlank:false},{fieldLabel:"option",afterLabelTextTpl:_SM._requiredField,name:"viewCode",allowBlank:false,__ptType:"formField",editable:true,xtype:"protoZoom",zoomModel:"protoLib.ProtoDefinition"}]},{xtype:"fieldset",defaultType:"textfield",layout:"anchor",defaults:{anchor:"100%"},items:[{fieldLabel:"iconCls",name:"iconCls"},{fieldLabel:"qtip",name:"qtip"},{fieldLabel:"qtitle",name:"qtitle"}]}],buttons:[{text:_SM.__language.Text_Cancel_Button,scope:this,handler:this.onCancel},{text:_SM.__language.Text_Save_Button,scope:this,handler:this.onSave}]};this.callParent([Ext.apply({titleTextAdd:_SM.__language.MenuTree_Text_Add_Event,titleTextEdit:_SM.__language.MenuTree_Text_Edit_Event,width:600,autocreate:true,border:true,closeAction:"hide",modal:false,resizable:false,buttonAlign:"left",savingMessage:_SM.__language.Msg_Saved,deletingMessage:_SM.__language.Msg_Deleted_Event,layout:"fit",items:a},b)])},initComponent:function(){this.callParent();this.formPanel=this.items.items[0]},onCancel:function(){this.close()},onSave:function(){if(!this.formPanel.form.isValid()){return}var a=this.formPanel.getForm().getValues();a.leaf=true;this.treeRecord.appendChild(a);this.close()}});Ext.define("ProtoUL.view.ProtoForm",{extend:"Ext.form.Panel",alias:"widget.protoform",requires:["Ext.form.field.Text","Ext.form.*","Ext.data.*","Ext.tip.QuickTipManager"],myMeta:null,newForm:false,formConfig:null,prFormLayout:[],idMaster:-1,masterRecord:null,linkDetails:false,isReadOnly:false,store:null,cllDetGrids:[],htmlPanels:{},zoomReturnDef:null,zoomMultiReturn:[],initComponent:function(){this.addEvents("create","close","hide");var b=this,d=this.myMeta,g=this;this.btSave=Ext.create("Ext.Button",{iconCls:"icon-saveMs",text:_SM.__language.Text_SaveMs_Button,scope:this,handler:this.onSave});this.btSaveDet=Ext.create("Ext.Button",{iconCls:"icon-saveDt",text:_SM.__language.Text_SaveDt_Button,hidden:true,disabled:true,scope:this,handler:this.onSaveDet});this.btCancelFormEdt=Ext.create("Ext.Button",{iconCls:"icon-close",text:_SM.__language.Text_Close_Button,scope:this,handler:this.onReset});this.stMsg=Ext.create("Ext.toolbar.TextItem");Ext.apply(this,{frame:true,autoScroll:true,bodyStyle:"padding:5px 5px",bodyPadding:10,masterRecord:null,items:this.prFormLayout,dockedItems:[{xtype:"toolbar",dock:"bottom",ui:"footer",items:[this.stMsg,"->",this.btSave,this.btSaveDet,this.btCancelFormEdt]}]});this.callParent();this.linkController=Ext.create("ProtoUL.UI.MDLinkController",{});this.getHtmlPanels();this.cllBtDetails=f(b.items.items,b);if(this.cllBtDetails.length>0){this.linkDetails=true;a(b,b.cllBtDetails)}this.cllDetGrids=c(b.items.items,b);if(this.cllDetGrids.length>0){this.linkDetails=true;this.btSaveDet.show();a(b,b.cllDetGrids)}this.doLayout();function c(j,l){var k=[],h,m;for(m in j){h=j[m];if(h.__ptType=="protoGrid"){if(h.myMeta){k.push(h)}}else{if(h.items&&h.items.items){k=k.concat(c(h.items.items,l))}}}return k}function f(h,j){var l=[],k,m;for(k in h){m=h[k];if(m.__ptType==="detailButton"){l.push(m)}else{if(m.items&&m.items.items){l=l.concat(f(m.items.items,j))}}}return l}function a(m,h){var n,l,j,k;for(j in h){n=h[j];n.linkController=m.linkController;n.detailDefinition=_SM.getDetailDefinition(m.myMeta,n.viewCode)}}},setDetailsTilte:function(){var b,a;for(b in this.cllDetGrids){a=this.cllDetGrids[b];a.embededGrid=true;a.setGridTitle(a)}},showProtoForm:function(){_SM.showConfig("Form Config",this.myMeta.formConfig)},showLayoutConfig:function(){_SM.showConfig("LayoutConfig",this.prFormLayout)},updateHtmlPanels:function(b){var d,a,c;for(a in this.htmlPanels){c=this.htmlPanels[a];if(b){d=b.get(a)}else{d=""}c.update(d);c.rawHtml=d}},readHtmlPanels:function(b){var a,c;for(a in this.htmlPanels){c=this.htmlPanels[a];b.set(a,c.rawHtml)}},setText:function(a){this.stMsg.setText(a)},onReset:function(){this.idMaster=null;this.fireEvent("close",this)},updateZoomIds:function(){var c=this,b=c.getForm().getFields().items,a,d;c.zoomMultiReturn=null;for(a in b){d=b[a];if(!d.zoomModel){continue}if(d.zoomMultiple&&c.newForm){if(!c.zoomMultiReturn){c.zoomMultiReturn=[]}c.zoomMultiReturn.push(d.zoomRecords)}else{if(d.zoomRecord){d.fkIdValue=this.masterRecord.get(d.fkId);c.updateFormField(d.fkId,d.zoomRecord.data.id)}}}},updateFormField:function(b,c){var a={};a[b]=c;this.getForm().setValues(a);a=this.masterRecord;a.data[b]=c;if(!a.modified[b]){a.modified[b]=a.data[b]}},onCreate:function(){var a=this.getForm();if(a.isValid()){this.fireEvent("create",this,a.getValues());a.reset()}},setFormReadOnly:function(a){this.isReadOnly=a;this.btSave.setDisabled(a);this.btSaveDet.setDisabled(a);this.btCancelFormEdt.setDisabled(a);this.setReadOnlyFields(a);this.setDetailsReadOnly(a);if(this.linkController){this.linkController.isReadOnly=this.isReadOnly}},setDetailsReadOnly:function(a){var c,b;for(b in this.cllDetGrids){c=this.cllDetGrids[b];c.setEditMode(!a)}},setReadOnlyFields:function(a,g){var c=this.getForm().getFields(),f,b,d;for(b in c.items){f=c.items[b];if(f.readOnly){f.setReadOnly(true)}else{if(!g||(f.name in _SM.objConv(g))){f.setReadOnly(a)}}}for(b in this.htmlPanels){f=this.htmlPanels[b];d=f.__ptConfig;if(d.readOnly){f.setReadOnly(true)}else{if(!g||(d.name in _SM.objConv(g))){f.setReadOnly(a)}}}},getHtmlPanels:function(){a(this.items.items,this);function a(c,d){var f,b;for(b in c){f=c[b];if(f.xtype==="htmlset"){Ext.apply(d.htmlPanels,f.htmlPanels)}else{if(f.xtype==="fieldset"){a(f.items.items,d)}}}}},setActiveRecord:function(a){var b=this;this.masterRecord=a;this.store=a.store;if(a&&!a.phantom){this.idMaster=a.get("id")}if(a){this.getForm().loadRecord(a)}else{this.getForm().reset()}this.linkDetail(a);this.updateHtmlPanels(a);this.store.on({update:function(f,c,d,g){if(c&&this.linkDetails){this.idMaster=c.get("id");this.myFormController.newForm=false;this.linkDetail(c);this.setDetailsReadOnly(false)}},scope:b})},linkDetail:function(b){if(!this.linkDetails){return}var d=this,a,g,f,c;d.linkController.setMasterData(b.data);for(c in d.cllDetGrids){d.linkController.isReadOnly=d.isReadOnly;a=d.cllDetGrids[c];f=d.linkController.getDetailLink(a.detailDefinition);a.store.myLoadData(f.detFilter,null,d.idMaster);if(d.idMaster>=0&&(!d.isReadOnly)){a.setEditMode(!d.isReadOnly);d.linkController.setDetailDefaults(a.detailDefinition,a.myFieldDict)}}if(d.idMaster>=0&&(!d.isReadOnly)){for(c in d.cllBtDetails){g=d.cllBtDetails[c];g.setButtonsReadOnly(false)}}},_doSyncMasterStore:function(){this.store.sync({success:function(a,d){var c=a.operations[0].response,b=Ext.decode(c.responseText);if(b.message){_SM.errorMessage(_SM.__language.Msg_Error_Save_Form,b.message)}},failure:function(a,b){_SM.errorMessage(_SM.__language.Msg_Error_Save_Form,_SM.__language.Msg_Failed_Operation)}})},onSaveDet:function(){this.onSave();this.fireEvent("close",this)},onSave:function(){var h=this,j,b,f,a,d,k,g,c;j=h.store.autoSync;b=h.getForm();h.updateZoomIds();if(!b.isValid()){h.setText(_SM.__language.Msg_Invalid_Form);return}if(!h.masterRecord){return}b.updateRecord(h.masterRecord);h.readHtmlPanels(h.masterRecord);if(h.myFormController.newForm){if(!h.zoomMultiReturn){h.store.add(h.masterRecord)}else{h.store.autoSync=false;f=_SM.Product(h.zoomMultiReturn);for(g in f){a=f[g];d=h.masterRecord.copy();for(c in a){k=a[c];d.data[k.name]=k.recStr;d.data[k.fkId]=k.recId}h.store.add(d)}}}if(h.store.autoSync!==true){h._doSyncMasterStore()}h.store.autoSync=j;if(h.cllDetGrids.length>0){h.btSave.setDisabled(true);h.btSaveDet.setDisabled(false)}else{h.fireEvent("close",h)}},setZoomEditMode:function(c){var b=c.getForm().getFields().items,a;for(a in b){if(b[a].xtype==="protoZoom"){b[a].newForm=c.newForm}}}});Ext.define("ProtoUL.view.ProtoGrid",{extend:"Ext.Panel",alias:"widget.protoGrid",requires:["Ext.grid.*","Ext.data.*","Ext.util.*","Ext.state.*","Ext.form.*","Ext.selection.CheckboxModel","Ext.toolbar.TextItem"],height:200,viewCode:null,myMeta:null,selModel:null,rowData:null,isDetail:false,isPromoted:false,mdFilter:[],initialFilter:null,embededGrid:false,colDictDefinition:{},colSetName:"",colSetDefinition:[],colSetCache:{},autoEdit:true,editable:true,initComponent:function(){var u=this;if(!_SM.loadPci(this.viewCode,false)){Ext.apply(this,{title:this.viewCode+" Not found!"});this.callParent(arguments);_SM.errorMessage("initGrid",this.viewCode+" not found!!");return}var p=_SM.clone(_SM._cllPCI[this.viewCode]);this.myMeta=p;this.myMeta.idProtoGrid=this.id;this.myFieldDict=_SM.getFieldDict(p);var c=[],h=[],f;if(this.isDetail){c=p.gridConfig.baseFilter;h=[{property:this.detailDefinition.detailField,filterStmt:-1}]}else{if(this.isPromoted){c=p.gridConfig.baseFilter;c=c.concat(this.mdFilter)}else{c=p.gridConfig.baseFilter;h=this.initialFilter||p.gridConfig.initialFilter}}f={viewCode:this.viewCode,autoLoad:this.autoLoad||true,pageSize:p.pageSize||_SM._PAGESIZE,localSort:p.localSort,groupCol:p.gridConfig.groupCol,baseFilter:c,protoFilter:h,sorters:p.gridConfig.initialSort,sProtoMeta:_SM.getSafeMeta(p)};if(u.detailDefinition){p.pciStyle="grid";var g=u.detailDefinition.detailField.replace(/__pk$/,"_id");var t=u.myFieldDict[g];var s=g;if(t){s=u.detailDefinition.masterTitleField||t.fkField}}a();var j,o;o=_SM.defineTabConfig(p.gridConfig);if(p.custom.listDisplay.length>0){o.listDisplay=p.custom.listDisplay}j=this.getViewColumns(o);if(!this.gridSelectionMode){this.gridSelectionMode=p.gridConfig.gridSelectionMode||"multi"}var n="last";if(this.gridSelectionMode!="multi"){n=false}this.selModel=Ext.create("Ext.selection.CheckboxModel",{injectCheckbox:n,mode:this.gridSelectionMode});this.editable=this.autoEdit;var l=[],k,m,r;if(p.gridConfig.groupCol){if(this.myFieldDict[p.gridConfig.groupCol]){m="{name}";r=Ext.create("Ext.grid.feature.Grouping",{groupHeaderTpl:m});l.push(r)}}var b;if(p.pciStyle=="tree"){}else{u.store=_SM.getStoreDefinition(f);b=Ext.create("Ext.grid.Panel",{border:false,region:"center",flex:1,layout:"fit",minSize:50,plugins:["headertooltip"],features:l,selModel:this.selModel,columns:j,store:this.store,stripeRows:true,tools:[],viewConfig:{listeners:{cellclick:function(E,F,C,y,G,D,B){var z=(B.target.tagName=="A");var w=E.panel.headerCt.getHeaderAtIndex(C).dataIndex;if(z&&w){var v=u.myFieldDict[w];if(!v){return}if(v.zoomModel&&v.fkId){if((v.zoomModel==u.myMeta.viewEntity)&&(v.fkId=u.myMeta.idProperty)){var x=Ext.create("ProtoUL.UI.FormController",{myMeta:u.myMeta});if(_SM.validaSelected(u)){x.openLinkedForm.call(x,u.selected,!u.editable)}}else{var x=Ext.create("ProtoUL.UI.FormController",{});x.openProtoForm.call(x,v.zoomModel,y.get(v.fkId),false)}}else{if(v.zoomModel=="@cellValue"){var A=y.get(v.name);_SM._mainWin.loadPciFromMenu(A)}else{_SM.errorMessage("LinkedForm definition error : "+w,"zoomModel : "+v.zoomModel+"<br>fkId : "+v.fkId)}}}}},getRowClass:function(v,z,x,w){var y=v.get("_ptStatus");if(y){if(y===_SM._ROW_ST.NEWROW){return y}else{if(y===_SM._ROW_ST.REFONLY){return""}else{return _SM._ROW_ST.ERROR}}}else{return""}}}})}this._extGrid=b;this.setGridTitle(this);if(this.gridController){this.gridController.myGrid=this;this.gridController.store=this.store}else{this.gridController=Ext.create("ProtoUL.UI.GridController",{myMeta:p,myGrid:this,store:this.store})}this.gridController.addGridTools(this.autoEdit);this.sheetCrl=Ext.create("ProtoUL.UI.GridSheetController",{myGrid:this});var d=[b];var q=this.sheetCrl.getSheetConfig();if(q){d.push(q)}Ext.apply(this,{layout:"border",border:false,defaults:{collapsible:false,split:false},items:d});this.addEvents("selectionChange","rowDblClick","promoteDetail","startEdition");this.callParent(arguments);this.gridController.addNavigationPanel();b.on({selectionchange:{fn:function(v,x,w){this.selected=x[0]||null;if(this.selected){u.rowData=this.selected.data;u.currentId=u.selected.get("id");u.fireSelectionChange(v,this.selected,this.selected.index+1,w)}else{u.rowData=null;u.currentId=-1;u.fireSelectionChange(v,null,null,w)}},scope:this},itemmouseenter:{fn:function(w,v,x){var y=v.get("_ptStatus");if(y==_SM._ROW_ST.NEWROW||y==_SM._ROW_ST.REFONLY){y=""}Ext.fly(x).set({"data-qtip":y})},scope:this},celldblclick:{fn:function(B,y,w,v,z,C,A,x){if(u.editable){return}u.fireEvent("rowDblClick",v,C)},scope:u}});function a(){var x,v,w;for(v in p.fields){w=p.fields[v];if(w.crudType=="storeOnly"){continue}x=_SM.getColDefinition(w);if(x.dataIndex in _SM.objConv([g,s])){x.readOnly=true;delete x.editor}u.colDictDefinition[x.dataIndex]=x}x={xtype:"rownumberer",width:37,draggable:false,sortable:false};u.colDictDefinition.___numberCol=x}},fireSelectionChange:function(f,a,d,c){this.fireEvent("selectionChange",f,a,d,c);var b=_SM._UserInfo.perms[this.myMeta.viewCode];if(this.editable&&a&&b.refallow){this.verifyEdition(a,b)}if(this.IdeSheet){this.sheetCrl.prepareSheet()}},verifyEdition:function(b,c){var f=this,d=b.get("_ptStatus"),a=(d&&d===_SM._ROW_ST.REFONLY);f.gridController.setEditToolBar(f.editable,!a,c)},fireStartEdition:function(a){},getSelectedIds:function(){var c=[],b,a;if(!this.selected){return c}if(!this.selModel){return[this.selected.get("id")]}a=this.selModel.getSelection();for(b in a){c.push(a[b].get("id"))}return c},getViewColumns:function(c){if(this.colSetName==c.name){return this.colSetDefinition}this.colSetName=c.name;this.colSetDefinition=[];var d,a,b;if(!c.hideRowNumbers){d=this.colDictDefinition.___numberCol;this.colSetDefinition.push(d)}for(b in c.listDisplay){a=c.listDisplay[b];d=this.colDictDefinition[a];if(d){this.colSetDefinition.push(d)}}return this.colSetDefinition},configureColumns:function(h){if(this.colSetName==h.name){return this.colSetDefinition}var a=this.getViewColumns(h);this._extGrid.view.refresh();var g=this._extGrid.headerCt,d=g.items.items.slice(),c=d.length-1,f,b;this.suspendLayouts();for(b=0;b<c;b++){f=d[b];g.remove(f,true)}g.add(0,a);this.resumeLayouts(true);this._extGrid.view.refresh()},setGridTitle:function(b){var a="";if(b.detailTitle){a='" '+b.detailTitle+' "'}else{if(b.mdFilter!==undefined){a=Ext.encode(b.mdFilter)}}if(b.filterTitle){if(a){a+=" ; "}a+=b.filterTitle}if(a){a="; filtrage par "+a+""}if(b.embededGrid){a=""}a=b.myMeta.shortTitle+a;b._extGrid.setTitle(a)},addNewRecord:function(a){if(!(this.editable||a)){return}this.insertNewRecord(_SM.getNewRecord(this.myMeta,this.store))},duplicateRecord:function(){if((!this._extGrid)||(!this.editable)){return}var a=this.selected;if(a){this.insertNewRecord(a.copy())}},insertNewRecord:function(a){a.data._ptStatus=_SM._ROW_ST.NEWROW;a.data._ptId=a.get("id");a.data.id=undefined;a.phantom=true;this.store.insert(0,a);var b=this._extGrid.getSelectionModel();b.select(0)},getRowIndex:function(){var b=this._extGrid.getSelectionModel(),a=this.store.indexOf(b.getSelection()[0]);if(a<0){a=0}return a},deleteCurrentRecord:function(){if((!this._extGrid)||(!this.editable)){return}var b=this.getRowIndex();var a=this._extGrid.getSelectionModel();this.store.remove(a.getSelection());if(this.store.getCount()<=b){b=0}if(this.store.getCount()>0){a.select(b)}},setEditMode:function(a){this.store.editMode=a;this.gridController.setEditMode(a)},saveChanges:function(a){this.store.sync();if(a!==undefined){this.store.autoSync=a}},reload:function(){this.store.load()},cancelChanges:function(){this.store.load()},gridLoadData:function(a,b,c){a.store.myLoadData(b,c);if(a.store.currentPage!=1){a.store.loadPage(1)}},addTools:function(a){if(typeof a!="undefined"){this._extGrid.addTool(a)}}});Ext.define("ProtoUL.view.ProtoMasterDetail",{extend:"Ext.Panel",alias:"widget.protoMasterDetail",requires:["ProtoUL.view.ProtoGrid","ProtoUL.UI.TbMasterDetail"],editable:false,autoSync:true,autoEdit:true,isPromoted:false,mdFilter:[],initComponent:function(){this.myMeta=_SM._cllPCI[this.viewCode];var b=this,a;if(this.mdFilter){this.isPromoted=true}_SM.__StBar.showBusy("loading "+this.viewCode+"...","prMD.init",2000);this.protoMasterGrid=Ext.create("ProtoUL.view.ProtoGrid",{border:false,viewCode:this.viewCode,mdFilter:this.mdFilter,detailTitle:this.detailTitle,isPromoted:this.isPromoted,region:"center",flex:1,layout:"fit",collapsible:false});this.protoMasterStore=this.protoMasterGrid.store;this.pciStyle=this.protoMasterGrid.myMeta.pciStyle||"grid";a=Ext.create("ProtoUL.UI.TbMasterDetail",{protoMeta:this.myMeta,__MasterDetail:b});this.protoMasterGrid._toolBar=a;this.protoTabs=Ext.create("Ext.panel.Panel",{layout:"card"});this.IDdetailPanel=Ext.id();Ext.apply(this,{layout:"border",border:false,defaults:{collapsible:true,border:false,split:true},tbar:a,items:[this.protoMasterGrid,{id:this.IDdetailPanel,collapseMode:"mini",hideCollapseTool:true,region:"south",header:false,border:false,flex:1,collapsed:true,layout:"fit",minSize:75,defaults:{border:false},items:this.protoTabs}]});this.ixActiveDetail=-1;this.idMasterGrid=-1;this.cllStoreDet=[];this.callParent();Ext.create("ProtoUL.UI.MDDetailsController",{__MasterDetail:b});Ext.create("ProtoUL.UI.MDTbSortByController",{myMeta:this.myMeta,__MasterDetail:b});Ext.create("ProtoUL.UI.MDPrintOptsController",{myMeta:this.myMeta,__MasterDetail:b});Ext.create("ProtoUL.UI.MDActionsController",{myMeta:this.myMeta,__MasterDetail:b});Ext.create("ProtoUL.UI.MDSetFiltersController",{myMeta:this.myMeta,__MasterDetail:b});Ext.create("ProtoUL.UI.MDSetSortersController",{myMeta:this.myMeta,__MasterDetail:b});Ext.create("ProtoUL.UI.MDSetTabsController",{myMeta:this.myMeta,__MasterDetail:b});Ext.create("ProtoUL.UI.ConfigController",{myMeta:this.myMeta,__MasterDetail:b});this.linkController=Ext.create("ProtoUL.UI.MDLinkController",{});a.addActions();this.protoMasterGrid.on({selectionChange:{fn:function(g,d,f,c){this.idMasterGrid=this.protoMasterGrid.currentId;this.linkDetail()},scope:b}})},linkDetail:function(){var c=this,f,b,a,d;if(c.ixActiveDetail<0){return}if(c.protoTabs.items.length===0){return}b=c.cllStoreDet[c.ixActiveDetail];a=b.detailDefinition;if(b.protoMasterId===c.idMasterGrid){return}c.linkController.setMasterData(c.protoMasterGrid.rowData);f=c.linkController.getDetailLink(a);b.myLoadData(f.detFilter,null,c.idMasterGrid);d=c.protoTabs.items.items[c.ixActiveDetail];d.detailTitle=f.detTitle;d.setGridTitle(d);d.mdFilter=f.detFilter;c.linkController.setDetailDefaults(a,d.myFieldDict)},mdGridReload:function(){this.protoMasterGrid.reload()},mdGridLoadData:function(a,b){this.protoMasterGrid.gridLoadData(this.protoMasterGrid,a,b)},showDetailPanel:function(b){var a=Ext.getCmp(this.IDdetailPanel);if(b){this.ixInactiveDetail=this.ixActiveDetail;this.ixActiveDetail=-1;a.collapse()}else{if(a.collapsed){if(this.ixActiveDetail<0){this.ixActiveDetail=this.ixInactiveDetail||0}this.linkDetail();a.expand()}}},hideDetailPanel:function(a){this.showDetailPanel(true)},isDetailCollapsed:function(){var a=Ext.getCmp(this.IDdetailPanel);if(!a){return true}return(a.collapsed)},setEditMode:function(g){var c=this,b=null,h,a;if(!c.autoEdit){d(c.tbFilters);d(c.tbPrinterOpts);d(c.tbConfigOpts);d(c.tbSorters);d(c.tbSortersSet);d(c.tbProtoActions)}else{g=c.autoEdit}c.protoMasterGrid.setEditMode(g);try{b=c.protoTabs.items.items}catch(f){}if(b){for(a in b){h=b[a];if(!h.detailDefinition){continue}h.setEditMode(g)}}function d(k,j){if(j===undefined){j=g}if(k){k.setDisabled(j)}}},setAutoSync:function(a){this.autoSync=a},saveChanges:function(b){var d=this,a,c,f;if(this.isDetailCollapsed()){d.protoMasterGrid.saveChanges(b)}else{c=d.protoTabs.items.items;for(a in c){f=c[a];f.saveChanges(b)}}},cancelChanges:function(){var c=this,b,a,d;if(this.isDetailCollapsed()){c.protoMasterGrid.cancelChanges()}else{b=c.protoTabs.items.items;for(a in b){d=b[a];d.cancelChanges()}}}});Ext.define("ProtoUL.view.ProtoTabContainer",{extend:"Ext.tab.Panel",alias:"widget.protoTabContainer",border:false,initComponent:function(){_SM.__TabContainer=this;this.callParent()},addTabPanel:function(b,c,a){var f=_SM._cllPCI[b];var g=f.shortTitle;if(c){g="*"+g}var d=this.add({title:g,viewCode:b,border:false,tabConfig:{tooltip:g,width:120},iconCls:f.viewIcon,closable:true,layout:"fit",items:[this.createProtoMasterDetail(b,c,a)]});this.setActiveTab(d);Ext.resumeLayouts(true)},createProtoMasterDetail:function(b,c,a){var d=Ext.create("widget.protoMasterDetail",{viewCode:b,mdFilter:c,detailTitle:a});return d},closeProtoTab:function(b){for(var a=this.items.items.length;a--;){var c=this.items.items[a];if(c.viewCode==b){this.remove(c,true)}}},closeAllTabs:function(){for(var a=this.items.items.length;a--;){var b=this.items.items[a];this.remove(b,true)}Ext.destroy(Ext.ComponentQuery.query("protoZoom"));Ext.destroy(Ext.ComponentQuery.query("protoForm"));Ext.destroy(Ext.ComponentQuery.query("protoGrid"));Ext.destroy(Ext.ComponentQuery.query("protoMasterDetail"));Ext.destroy(Ext.ComponentQuery.query("protoLogin"));Ext.destroy(Ext.ComponentQuery.query("protoSearch"))}});_SM.closeTabListener=function(){var a="TODO:  liberar la memoria"};Ext.define("ProtoUL.view.Viewport",{extend:"Ext.Viewport",layout:"fit",initComponent:function(){Ext.apply(this,{layout:"border",autoRender:true,padding:5,defaults:{split:true},items:[this.createHeaderPanel(),this.createMenuPanel(),this.createProtoTabContainer(),this.createFooterPanel()]});this.callParent(arguments)},createFooterPanel:function(){_SM.__StBar=Ext.create("Ext.ux.StatusBar",{region:"south",split:false,collapsible:false});if(_SM.showFooterExtraContent){var b=Ext.create("Ext.panel.Panel",{html:_SM.footerExtraContent,margins:"0 0 0 0",border:false,align:"middle",collapsible:true,split:true});var a=Ext.create("Ext.panel.Panel",{region:"south",header:false,layout:{type:"vbox",align:"stretch"},defaults:{bodyStyle:"padding:15px",split:true},items:[_SM.__StBar,b]});return a}else{return _SM.__StBar}},afterRender:function(){this.callParent(arguments);_SM.__StBar.showBusy("loading ... ","vPort",3000);for(var a in _SM._AUTOLOAD_PCI){this.loadPciFromMenu(_SM._AUTOLOAD_PCI[a])}_SM._mainWin=this},createHeaderPanel:function(){var a=Ext.create("Ext.panel.Panel",{html:_SM._siteTitle,margins:"0 0 0 0",border:false,align:"middle",split:true});var b=Ext.create("Ext.panel.Panel",{region:"north",header:false,collapsible:true,collapseMode:"mini",collapsed:_SM._siteTitleCollapsed,height:90,layout:{type:"vbox",align:"stretch"},defaults:{bodyStyle:"padding:5px",split:true},items:[a]});return b},createMenuPanel:function(){if(_SM._MENU_COLLAPSED==undefined){_SM._MENU_COLLAPSED=false}this.menuPanel={region:"west",width:300,title:_SM.__language.Title_Main_Menu,collapsible:true,collapsed:_SM._MENU_COLLAPSED,xtype:"menuTree"};return this.menuPanel},loadPciFromMenu:function(b){var a=b;var d=this;var c={scope:this,success:function(h,f,g){d.openProtoOption(a)},failure:function(h,f,g){return}};if(_SM.loadPci(a,true,c)){d.openProtoOption(a)}},openProtoOption:function(a){var b=this;var c=_SM._cllPCI[a];if(c.pciStyle=="form"){var d=Ext.create("ProtoUL.UI.FormController",{});d.openProtoForm.call(d,a,-1,true)}else{b.protoTabContainer.addTabPanel(a)}},createProtoTabContainer:function(){this.protoTabContainer=Ext.create("widget.protoTabContainer",{region:"center",border:false,minWidth:300});return this.protoTabContainer}});Ext.define("ProtoUL.view.ComboBoxPrompt",{extend:"Ext.window.Window",alias:"widget.comboboxprompt",requires:["Ext.toolbar.Toolbar","Ext.form.field.Display","Ext.form.field.ComboBox","Ext.button.Button","Ext.layout.container.Anchor","Ext.layout.container.HBox","Ext.ProgressBar"],OK:1,YES:2,NO:4,CANCEL:8,OKCANCEL:9,QUESTION:Ext.baseCSSPrefix+"message-box-question",hideMode:"offsets",closeAction:"hide",resizable:false,title:"&#160;",defaultMinWidth:250,defaultMaxWidth:600,defaultMinHeight:110,defaultMaxHeight:500,minWidth:null,maxWidth:null,minHeight:null,maxHeight:null,constrain:true,cls:[Ext.baseCSSPrefix+"message-box",Ext.baseCSSPrefix+"hide-offsets"],layout:{type:"vbox",align:"stretch"},shrinkWrapDock:true,minProgressWidth:250,minPromptWidth:250,buttonText:{ok:"OK",yes:"Yes",no:"No",cancel:"Cancel"},buttonIds:["ok","yes","no","cancel"],titleText:{confirm:"Confirm",prompt:"Prompt",wait:"Loading...",alert:"Attention"},iconHeight:35,iconWidth:50,ariaRole:"alertdialog",makeButton:function(a){var b=this.buttonIds[a];return new Ext.button.Button({handler:this.btnCallback,itemId:b,scope:this,text:this.buttonText[b],minWidth:75})},btnCallback:function(a){var b=this,c,d;d=b.comboBox;c=d.getValue();d.reset();b.hide();b.userCallback(a.itemId,c,b.cfg)},hide:function(){var b=this,a=b.cfg.cls;b.progressBar.reset();if(a){b.removeCls(a)}b.callParent(arguments)},constructor:function(a){var b=this;b.callParent(arguments);b.minWidth=b.defaultMinWidth=(b.minWidth||b.defaultMinWidth);b.maxWidth=b.defaultMaxWidth=(b.maxWidth||b.defaultMaxWidth);b.minHeight=b.defaultMinHeight=(b.minHeight||b.defaultMinHeight);b.maxHeight=b.defaultMaxHeight=(b.maxHeight||b.defaultMaxHeight)},initComponent:function(a){var f=this,b=f.id,d,c;f.title="&#160;";f.topContainer=new Ext.container.Container({layout:"hbox",padding:5,style:{overflow:"hidden"},items:[f.iconComponent=new Ext.Component({width:f.iconWidth,height:f.iconHeight}),f.promptContainer=new Ext.container.Container({flex:1,layout:"anchor",items:[f.msg=new Ext.form.field.Display({id:b+"-displayfield",cls:f.baseCls+"-text"}),f.comboBox=new Ext.form.field.ComboBox({id:b+"-combo",anchor:"100%",enableKeyEvents:true,displayField:"description",valueField:"id",queryMode:"local",selectOnFocus:true,triggerAction:"all",allowBlank:false,listeners:{keydown:f.onPromptKey,scope:f}})]})]});f.progressBar=new Ext.ProgressBar({id:b+"-progressbar",margin:"0 10 10 10"});f.items=[f.topContainer,f.progressBar];f.msgButtons=[];for(d=0;d<4;d++){c=f.makeButton(d);f.msgButtons[c.itemId]=c;f.msgButtons.push(c)}f.bottomTb=new Ext.toolbar.Toolbar({id:b+"-toolbar",ui:"footer",dock:"bottom",layout:{pack:"center"},items:[f.msgButtons[0],f.msgButtons[1],f.msgButtons[2],f.msgButtons[3]]});f.dockedItems=[f.bottomTb];f.on("close",f.onClose,f);f.callParent()},onClose:function(){var a=this.header.child("[type=close]");a.itemId="cancel";this.btnCallback(a);delete a.itemId},onPromptKey:function(a,c){var b=this;if(c.keyCode===c.RETURN||c.keyCode===10){if(b.msgButtons.ok.isVisible()){b.msgButtons.ok.handler.call(b,b.msgButtons.ok)}else{if(b.msgButtons.yes.isVisible()){b.msgButtons.yes.handler.call(b,b.msgButtons.yes)}}}},reconfigure:function(l){var m=this,n=0,j=true,a=m.buttonText,p=m.resizer,b,c,q,h,o,g,f,k,d;m.updateButtonText();l=l||{};m.cfg=l;if(l.width){c=l.width}if(l.height){q=l.height}m.minWidth=l.minWidth||m.defaultMinWidth;m.maxWidth=l.maxWidth||m.defaultMaxWidth;m.minHeight=l.minHeight||m.defaultMinHeight;m.maxHeight=l.maxHeight||m.defaultMaxHeight;if(p){b=p.resizeTracker;p.minWidth=b.minWidth=m.minWidth;p.maxWidth=b.maxWidth=m.maxWidth;p.minHeight=b.minHeight=m.minHeight;p.maxHeight=b.maxHeight=m.maxHeight}delete m.defaultFocus;if(l.defaultFocus){m.defaultFocus=l.defaultFocus}m.animateTarget=l.animateTarget||undefined;m.modal=l.modal!==false;m.setTitle(l.title||"");m.setIconCls(l.iconCls||"");if(Ext.isObject(l.buttons)){m.buttonText=l.buttons;n=0}else{m.buttonText=l.buttonText||m.buttonText;n=Ext.isNumber(l.buttons)?l.buttons:0}n=n|m.updateButtonText();m.buttonText=a;Ext.suspendLayouts();delete m.width;delete m.height;if(c||q){if(c){m.setWidth(c)}if(q){m.setHeight(q)}}m.hidden=false;if(!m.rendered){m.render(Ext.getBody())}m.closable=l.closable!==false&&!l.wait;m.header.child("[type=close]").setVisible(m.closable);if(!l.title&&!m.closable&&!l.iconCls){m.header.hide()}else{m.header.show()}m.liveDrag=!l.proxyDrag;m.userCallback=Ext.Function.bind(l.callback||l.fn||Ext.emptyFn,l.scope||Ext.global);m.setIcon(l.icon,l.iconWidth,l.iconHeight);f=m.msg;if(l.msg){f.setValue(l.msg);f.show()}else{f.hide()}o=m.comboBox;o.bindStore(l.store);o.setValue(l.store.getAt("0").get("id"));o.show();m.defaultFocus=o;k=m.progressBar;if(l.progress||l.wait){k.show();m.updateProgress(0,l.progressText);if(l.wait===true){k.wait(l.waitConfig)}}else{k.hide()}d=m.msgButtons;for(h=0;h<4;h++){if(n&Math.pow(2,h)){if(!m.defaultFocus){m.defaultFocus=d[h]}d[h].show();j=false}else{d[h].hide()}}if(j){m.bottomTb.hide()}else{m.bottomTb.show()}Ext.resumeLayouts(true)},updateButtonText:function(){var d=this,c=d.buttonText,b=0,f,a;for(f in c){if(c.hasOwnProperty(f)){a=d.msgButtons[f];if(a){if(d.cfg&&d.cfg.buttonText){b=b|Math.pow(2,Ext.Array.indexOf(d.buttonIds,f))}if(a.text!=c[f]){a.setText(c[f])}}}}return b},show:function(a){var c=this,b;if(Ext.AbstractComponent.layoutSuspendCount){Ext.on({resumelayouts:function(){c.show(a)},single:true});return c}c.reconfigure(a);if(a.cls){c.addCls(a.cls)}b=c.query("combo:not([hidden]),button:not([hidden])");c.preventFocusOnActivate=!b.length;c.hidden=true;c.callParent();return c},onShow:function(){this.callParent(arguments);this.center()},updateText:function(a){this.msg.setValue(a)},setIcon:function(d,c,a){var f=this,g=f.iconComponent,b=f.messageIconCls;if(b){g.removeCls(b)}if(d){g.show();g.setSize(c||f.iconWidth,a||f.iconHeight);g.addCls(Ext.baseCSSPrefix+"dlg-icon");g.addCls(f.messageIconCls=d)}else{g.removeCls(Ext.baseCSSPrefix+"dlg-icon");g.hide()}return f},updateProgress:function(b,a,c){this.progressBar.updateProgress(b,a);if(c){this.updateText(c)}return this},onEsc:function(){if(this.closable!==false){this.callParent(arguments)}},prompt:function(a,b,d,c,f){if(Ext.isString(a)){a={prompt:true,title:a,minWidth:this.minPromptWidth,msg:b.label,buttons:this.OKCANCEL,callback:d,scope:c,store:b.store,value:f,userData:b.userData}}return this.show(a)},progress:function(a,c,b){if(Ext.isString(a)){a={title:a,msg:c,progress:true,progressText:b}}return this.show(a)}},function(){_SM.ComboBoxPrompt=_SM.ComboPrompt=new this()});Ext.define("ProtoUL.view.password.ForgotPasswordForm",{extend:"Ext.window.Window",alias:"widget.forgotPasswordForm",requires:["Ext.form.Panel","Ext.form.field.Text"],title:_SM.__language.Title_Window_Email_Request,height:160,width:400,layout:"fit",closable:true,initComponent:function(){this.items=[{xtype:"form",bodyPadding:25,centered:true,fieldDefaults:{anchor:"100%",labelAlign:"left",allowBlank:false,combineErrors:true,msgTarget:"side",labelWidth:80},items:[{xtype:"textfield",fieldLabel:_SM.__language.Textfield_User_Login,name:"login",allowBlank:false,flex:1,listeners:{afterrender:function(a){a.focus(false,500)},blur:function(){this.setValue(Ext.String.trim(this.getValue()))}}},{xtype:"textfield",fieldLabel:_SM.__language.Textfield_User_Email,name:"email",vtype:"email",allowBlank:false,flex:1,listeners:{specialkey:function(b,c){if(c.getKey()==c.ENTER){var a=Ext.ComponentQuery.query("button[itemId=btForgotPWDForm]")[0];a.fireEvent("click",a)}}}}]}];this.dockedItems=[{xtype:"toolbar",dock:"bottom",ui:"footer",items:["->",{text:_SM.__language.Text_Send_Button,itemId:"btForgotPWDForm",iconCls:"st-key-go",action:"forgotpassword",}]}];this.callParent(arguments)}});Ext.define("ProtoUL.view.password.PasswordReset",{extend:"Ext.form.Panel",alias:"widget.passwordForm",title:_SM.__language.Title_Window_Password_Change,floating:true,centered:true,closable:true,modal:true,width:400,height:200,bodyPadding:5,labelWidth:140,layout:"anchor",defaults:{anchor:"100%",enableKeyEvents:true},username:"",defaultType:"textfield",items:[{fieldLabel:_SM.__language.Textfield_User_Login,name:"login",value:this.username,listeners:{afterrender:function(a){a.focus(false,500)}}},{xtype:"textfield",fieldLabel:_SM.__language.Textfield_Password_Login,inputType:"password",name:"current",width:120},{fieldLabel:_SM.__language.Textfield_New_Password,name:"newPassword1",inputType:"password",allowBlank:false},{fieldLabel:_SM.__language.Textfield_Confirm_Password,name:"newPassword2",inputType:"password",allowBlank:false,listeners:{specialkey:function(b,c){if(c.getKey()==c.ENTER){var a=Ext.ComponentQuery.query("button[itemId=btChangePWD]")[0];a.fireEvent("click",a)}}}}],buttons:[{text:_SM.__language.Text_change_Password_Button,itemId:"btChangePWD",iconCls:"st-key-go",formBind:true,disabled:true,action:"changepassword"}],listeners:{afterlayout:function(){if(window.isPasswordReseted==="True"){setTimeout(function(){Ext.Msg.show({title:_SM.__language.Message_Success,msg:_SM.__language.Message_Email_New_Password,buttons:Ext.Msg.OK,icon:Ext.MessageBox.INFO})},1000)}}},renderTo:Ext.getBody()});Ext.define("ProtoUL.model.EntityAttributesModel",{extend:"Ext.data.Model",requires:["Ext.data.Field"],fields:[{name:"text"},{name:"id"},{name:"inputPort"},{name:"datatype"},{name:"pk"},{name:"fk"},{name:"isRequired"},{name:"isNullable"}]});Ext.define("ProtoUL.model.Diagram",{extend:"Ext.data.Model",fields:["projectID","id","code","smUUID"]});Ext.define("ProtoUL.store.EntityAttributeStore",{extend:"Ext.data.Store",requires:["ProtoUL.model.EntityAttributesModel","Ext.data.proxy.Memory","Ext.data.reader.Json"],constructor:function(a){var b=this;a=a||{};b.callParent([Ext.apply({model:"ProtoUL.model.EntityAttributesModel",storeId:"EntityAttributeStore",proxy:{type:"memory",reader:{type:"json"}}},a)])}});Ext.define("ProtoUL.store.DBTypesStore",{extend:"Ext.data.Store",requires:["Ext.data.proxy.Memory","Ext.data.reader.Json"],data:[{typeID:"string",typeName:"string"},{typeID:"text",typeName:"text"},{typeID:"bool",typeName:"bool"},{typeID:"int",typeName:"int"},{typeID:"decimal",typeName:"decimal"},{typeID:"sequence",typeName:"sequence"},{typeID:"money",typeName:"money"},{typeID:"combo",typeName:"combo"},{typeID:"date",typeName:"date"},{typeID:"datetime",typeName:"datetime"},{typeID:"time",typeName:"time"}],constructor:function(a){var b=this;a=a||{};b.callParent([Ext.apply({model:Ext.define("DBTypes",{extend:"Ext.data.Model",fields:[{name:"typeID",type:"string"},{name:"typeName",type:"string"}]}),storeId:"storeDBTypes",proxy:{type:"memory",reader:{type:"json"}}},a)])}});Ext.define("ProtoUL.store.DiagramModelStore",{extend:"Ext.data.JsonStore",storeId:"diagramModelStore",fields:[{name:"id",mapping:"id"},{name:"tableName"}]});Ext.define("ProtoUL.store.Diagrams",{extend:"Ext.data.Store",model:"ProtoUL.model.Diagram",autoLoad:false,proxy:{type:"ajax",api:{create:_SM._PConfig.createDiagram,read:_SM._PConfig.listDiagrams,update:_SM._PConfig.updateDiagram,destroy:_SM._PConfig.deleteDiagram,},reader:{type:"json",root:"diagrams",successProperty:"success"},writer:{type:"json",writeAllFields:true,encode:true,root:"diagrams"},pageParam:false,startParam:false,limitParam:false}});Ext.define("ProtoUL.store.PortPositions",{extend:"Ext.data.Store",fields:["id","description"],data:[{id:"left",description:"Gauche"},{id:"right",description:"Droite"},{id:"top",description:"Haut"},{id:"bottom",description:"Bas"}]});Ext.define("ProtoUL.view.diagram.DiagramMenu",{extend:"Ext.panel.Panel",alias:"widget.diagramMenu",requires:["Ext.menu.Menu","Ext.menu.Item","Ext.button.Button"],itemId:"menuPanel",width:190,layout:"accordion",collapseDirection:"left",collapsible:true,title:"Menu",initComponent:function(){var a=this;Ext.applyIf(a,{items:[{xtype:"panel",collapsible:true,title:"Toolbox",html:'<div data-shape="dbModel.shape.DBTable" class="palette_node_element draw2d_droppable table_div">Table</div>',items:[{xtype:"menu",floating:false,itemId:"DatabaseMenu",items:[{xtype:"menuitem",itemId:"getAllTables",iconCls:"find-table",text:_SM.__language.Menu_Search_Table,}]}]},{xtype:"panel",title:_SM.__language.Menu_Database_Title,items:[{xtype:"databasemenu"}]}]});a.callParent(arguments)}});var countFigure=0;Ext.define("ProtoUL.view.diagram.DiagramToolbar",{extend:"Ext.toolbar.Toolbar",alias:"widget.diagramtoolbar",requires:["Ext.button.Button","Ext.container.ButtonGroup"],itemId:"diagramtoolbar",initComponent:function(){var a=this;Ext.applyIf(a,{items:[{xtype:"button",itemId:"btUndo",border:1,disabled:true,text:_SM.__language.Text_Undo_Button},{xtype:"button",itemId:"btRedo",disabled:true,text:_SM.__language.Text_Redo_Button},{xtype:"tbspacer",width:10},{xtype:"button",itemId:"btDelete",disabled:true,text:_SM.__language.Text_Delete_Button},{xtype:"tbspacer"},{xtype:"buttongroup",itemId:"zoomGroup",header:false,columns:3,items:[{xtype:"button",itemId:"btZoomIn",text:_SM.__language.Text_ZoomIn_Button},{xtype:"button",itemId:"btZoomNormal",text:"1:1"},{xtype:"button",itemId:"btZoomOut",text:_SM.__language.Text_ZoomOut_Button}]},{xtype:"tbspacer"},{xtype:"button",iconCls:"save-diagram",itemId:"btSaveDiagram",text:_SM.__language.Text_Save_Diagram_Button},{xtype:"button",iconCls:"send-to-DB",itemId:"btSyncToDB",disabled:true,text:_SM.__language.Text_Commit_Changes_Button},{xtype:"button",iconCls:"icon-print",itemId:"btExportDiagram",text:_SM.__language.Text_Export_Image}]});a.callParent(arguments)},onSelectionChanged:function(a){var b=this.getComponent("btDelete");if(a!==null&&countFigure===0){countFigure+=1;b.setDisabled(false)}else{if(a!==null&&countFigure>0){b.setDisabled(false)}else{if(a===null&&countFigure>0){countFigure-=1}else{if(a===null&&countFigure===0){b.setDisabled(true)}}}}},stackChanged:function(a){var b=this.getComponent("btUndo");var c=this.getComponent("btRedo");var d=this.getComponent("btSaveDiagram");if(a.getStack().canUndo()){b.setDisabled(false);d.setDisabled(false);c.setDisabled(true)}if(a.getStack().canRedo()){c.setDisabled(false)}}});(function(){var a=Ext.menu.Menu.prototype.hide;Ext.override(Ext.menu.Menu,{hide:function(){a.apply(this,arguments)}})})();Ext.define("ProtoUL.view.diagram.DiagramCanvas",{extend:"Ext.panel.Panel",alias:"widget.canvas",requires:["ProtoUL.view.diagram.DiagramToolbar","Ext.toolbar.Toolbar"],itemId:"contentPanel",autoScroll:true,header:false,listeners:{afterrender:function(){this.view=new dbModel.View("canvas");this.reload()}},initComponent:function(){var a=this;Ext.applyIf(a,{items:[{xtype:"panel",baseCls:"container",bodyCls:"canvas",html:'<div id="canvas" class="" style="width:1500px; height:1500px;-webkit-tap-highlight-color: rgba(0,0,0,0); "></div>'}],dockedItems:[{xtype:"diagramtoolbar",dock:"top"}]});a.callParent(arguments)},reload:function(){var d=this;d.view.clear();var a=new draw2d.io.json.Reader();a.unmarshal(d.getView(),jsonDocument);var c=d.getComponent("diagramtoolbar");d.view.addSelectionListener(c);d.view.getCommandStack().addEventListener(c);var b=ProtoUL.app.getController("DiagramController");d.view.addSelectionListener(b);d.view.figures.each(function(g,f){f.addContextMenuListener(d);f.addOnDropConnectionListener(b)})},getView:function(){return this.view},onContextMenu:function(b,a,f){var d=this;if(typeof b.sourcePort==="undefined"){var c=Ext.create("ProtoUL.view.diagram.TableContextMenu",{figure:b});if(typeof window.event!=="undefined"){c.showAt(window.event.clientX,window.event.clientY)}else{c.showAt(a,f)}}else{console.log("Connection")}}});Ext.define("ProtoUL.view.diagram.EntityAttributes",{extend:"Ext.grid.Panel",alias:"widget.entityattributes",requires:["Ext.grid.column.CheckColumn","Ext.grid.column.Boolean","Ext.grid.View"],itemId:"entityattributes",title:_SM.__language.Title_Attributes,store:"EntityAttributeStore",initComponent:function(){var b=this;b.rowEditing=Ext.create("Ext.grid.plugin.RowEditing",{clicksToMoveEditor:1,autoCancel:false});b.plugins=[b.rowEditing];var a=Ext.create("ProtoUL.store.DBTypesStore");Ext.applyIf(b,{columns:[{xtype:"gridcolumn",dataIndex:"text",text:_SM.__language.GridColumn_Name,editor:{allowBlank:false}},{xtype:"gridcolumn",dataIndex:"datatype",text:_SM.__language.GridColumn_Datatype,width:90,editor:{xtype:"combo",store:a,displayField:"typeName",valueField:"typeID",queryMode:"local",selectOnFocus:true,triggerAction:"all",allowBlank:false}},{xtype:"checkcolumn",width:30,dataIndex:"pk",text:"PK",editor:{xtype:"checkbox",cls:"x-grid-checkheader-editor"},listeners:{checkchange:function(d,c,f){this.up("grid").checkChanged(d,c,f)}}},{xtype:"checkcolumn",width:30,dataIndex:"fk",text:"FK",editor:{xtype:"checkbox",cls:"x-grid-checkheader-editor"},listeners:{checkchange:function(d,c,f){this.up("grid").checkChanged(d,c,f)}}},{xtype:"checkcolumn",width:50,dataIndex:"isRequired",text:_SM.__language.GridColumn_Required,editor:{xtype:"checkbox",cls:"x-grid-checkheader-editor"},listeners:{checkchange:function(d,c,f){this.up("grid").checkChanged(d,c,f)}}},{xtype:"checkcolumn",width:35,dataIndex:"isNullable",text:"Null",editor:{xtype:"checkbox",cls:"x-grid-checkheader-editor"},listeners:{checkchange:function(d,c,f){this.up("grid").checkChanged(d,c,f)}}}]});b.dockedItems=[{xtype:"toolbar",items:[{iconCls:"icon-tableAdd",itemId:"btAddAttribute",text:_SM.__language.Text_Add_Button,action:"addattribute"},{iconCls:"icon-tableDelete",itemId:"btDeleteAttribute",text:_SM.__language.Text_Delete_Button,action:"deleteattribute"},"->",{iconCls:"icon-panelDown",itemId:"btMoveDown",handler:function(d,f){var c=d.up("grid");c.moveSelectedRow(c,-1)},disabled:true},{iconCls:"icon-panelUp",itemId:"btMoveUp",handler:function(d,f){var c=d.up("grid");c.moveSelectedRow(c,1)},disabled:true}]}];b.callParent(arguments);b.on("edit",function(d,g){g.record.commit();var f=this.ownerCt;var c=f.getDockedItems('toolbar[dock="top"]')[0].getComponent("btSaveTable");c.fireEvent("click")})},listeners:{select:{fn:function(){var a=this.down("button[itemId=btMoveDown]");a.setDisabled(false);var b=this.down("button[itemId=btMoveUp]");b.setDisabled(false)}}},moveSelectedRow:function(f,g){var a=f.getSelectionModel().getSelection();if(!a){return}var c=f.getStore();var d=f.getStore().indexOfId(a[0].internalId);if(g>0){d--;if(d<0){return}}else{d++;if(d>=f.getStore().getCount()){return}}f.getStore().remove(a);f.getStore().insert(d,a);f.getSelectionModel().select(a);var b=f.ownerCt.getDockedItems('toolbar[dock="top"]')[0].getComponent("btSaveTable");b.fireEvent("click")},checkChanged:function(c,a,d){var b=this;b.getSelectionModel().select(a);e={grid:b,record:b.getSelectionModel().getSelection()[0],field:"visible",value:d,rowIdx:a,colIdx:c.getIndex()};b.rowEditing.fireEvent("edit",this,e)}});Ext.define("ProtoUL.view.diagram.EntityEditor",{extend:"Ext.form.Panel",alias:"widget.entityeditor",requires:["ProtoUL.view.diagram.EntityAttributes","Ext.form.FieldSet","Ext.form.field.Text","Ext.grid.Panel"],itemId:"entityeditor",width:370,bodyPadding:10,title:"Detail",autoScroll:true,initComponent:function(){var a=this;if(!a.fieldPicker){a.fieldPicker=Ext.create("Ext.form.field.Picker",{id:"colorpicker",createPicker:function(){return Ext.create("Ext.picker.Color",{resizable:true,floating:true,select:function(b){var c=Ext.getCmp("colorpicker");c.setValue("#"+b);c.setFieldStyle("background-color:"+c.getValue()+" ;background-image: none;");c.collapse()}})},listeners:{focus:function(d,c,b){d.setFieldStyle("background-color:"+d.getValue()+" ;background-image: none;")}}})}Ext.applyIf(a,{items:[{xtype:"propertygrid",itemId:"protoProperty",sourceConfig:{tableName:{displayName:"<strong>"+_SM.__language.Label_Table_Name+"</strong>"},isPrimary:{displayName:_SM.__language.Label_Dependency},name:{displayName:"<strong>"+_SM.__language.Label_Connector_Name+"</strong>"},color:{displayName:"Couleur",editor:a.fieldPicker},alpha:{displayName:"Transparence"}},listeners:{propertychange:function(j,f,h,c,d){var g=this.up("form");var b=g.getDockedItems('toolbar[dock="top"]')[0].getComponent("btSaveTable");b.fireEvent("click")}}},{xtype:"fieldset"},{xtype:"entityattributes",title:_SM.__language.Title_Attributes,height:280}]});this.dockedItems=[{xtype:"toolbar",hidden:true,items:[{iconCls:"menu_reload",itemId:"btSaveTable",text:_SM.__language.Text_UpdateDiagram_Button,action:"savetable"}]}];a.callParent(arguments)}});Ext.define("ProtoUL.view.diagram.TableContextMenu",{extend:"Ext.menu.Menu",alias:"widget.tablecontextmenu",figure:null,itemId:"tablecontextmenu",initComponent:function(){var a=this;Ext.applyIf(a,{items:[{text:_SM.__language.Menu_Add_Recursive_Association,iconCls:"table-relationship",itemId:"btAddConnectorRecursive"},{text:_SM.__language.Menu_Add_Input_Port,iconCls:"icon-nodeInput",itemId:"btAddInputPort"},{text:_SM.__language.Menu_Add_Output_Port,iconCls:"icon-nodeInsert",itemId:"btAddOutputPort"},{text:_SM.__language.Menu_Remove_Unused_Ports,iconCls:"icon-nodeDelete",itemId:"btRemoveUnusedPorts"}]});a.callParent(arguments)},getFigure:function(){return this.figure}});Ext.define("ProtoUL.view.diagram.DatabaseMenu",{extend:"Ext.menu.Menu",alias:"widget.databasemenu",requires:["Ext.menu.Item"],floating:false,itemId:"DatabaseMenu",initComponent:function(){var a=this;Ext.applyIf(a,{items:[{xtype:"menuitem",itemId:"syncDiagramFromDB",iconCls:"get-from-DB",text:_SM.__language.Menu_Update_Diagram,},{xtype:"menuseparator"},{xtype:"menuitem",itemId:"menuManageDiagram",iconCls:"icon-model",text:_SM.__language.Menu_Manage_Diagrams,}]});a.callParent(arguments)}});Ext.define("ProtoUL.view.diagram.DiagramMainView",{extend:"Ext.window.Window",alias:"widget.diagramMainView",requires:["ProtoUL.view.diagram.DiagramMenu","ProtoUL.view.diagram.DiagramCanvas","ProtoUL.view.diagram.EntityEditor","Ext.panel.Panel"],itemId:"diagramMainView",layout:"border",maximizable:true,modal:true,height:600,width:1200,projectID:null,diagramID:null,initComponent:function(){var a=this;Ext.applyIf(a,{items:[{xtype:"diagramMenu",region:"west",split:true,collapsible:true},{xtype:"canvas",flex:1,region:"center"},{xtype:"entityeditor",region:"east",split:true,collapsed:true,collapsible:true}]});a.addEvents("opendiagram");a.on("beforeshow",function(){this.fireEvent("opendiagram")});a.callParent(arguments)},setProjectID:function(a){this.projectID=a},getProjectID:function(){return this.projectID},setDiagramID:function(a){this.diagramID=a},getDiagramID:function(){return this.diagramID}});Ext.define("ProtoUL.view.diagram.base.Grid",{extend:"Ext.grid.Panel",alias:"widget.diagramgrid",requires:["Ext.toolbar.Paging"],iconCls:"icon-grid",itemId:"diagramgrid",store:"Diagrams",header:false,columns:[{header:"ID",width:20,dataIndex:"id"},{header:_SM.__language.GridColumn_Name,flex:1,dataIndex:"code"}],listeners:{select:{fn:function(){var a=this.down("button[itemId=btOpenDiagram]");a.setDisabled(false)}}},initComponent:function(){this.dockedItems=[{xtype:"toolbar",items:[{iconCls:"icon-save",text:_SM.__language.Text_Add_Button,action:"add"},{iconCls:"icon-delete",text:_SM.__language.Text_Delete_Button,action:"delete"},{iconCls:"open-file",text:_SM.__language.Text_OpenDiagram_Button,action:"openselecteddiagram",itemId:"btOpenDiagram",disabled:true}]},{xtype:"pagingtoolbar",dock:"top",store:"Diagrams",displayInfo:true,displayMsg:"Showing Diagrams {0} - {1} of {2}",emptyMsg:"No diagram found.",listeners:{afterrender:function(){this.child("#refresh").hide()}}}];this.callParent(arguments)}});Ext.define("ProtoUL.view.diagram.base.Form",{extend:"Ext.window.Window",alias:"widget.diagramform",requires:["Ext.form.Panel","Ext.form.field.Text"],title:"Edit/Create Diagram",layout:"fit",autoShow:true,width:280,itemId:"diagramform",iconCls:"icon-pclDetails",initComponent:function(){this.items=[{xtype:"form",padding:"5 5 0 5",border:false,style:"background-color: #fff;",fieldDefaults:{anchor:"100%",labelAlign:"left",combineErrors:true,msgTarget:"side"},items:[{xtype:"textfield",name:"id",fieldLabel:"id",hidden:true},{xtype:"textfield",name:"projectID",fieldLabel:"projectID",hidden:true},{xtype:"textfield",name:"code",allowBlank:false,fieldLabel:_SM.__language.GridColumn_Name,validator:function(a){if(!Ext.isEmpty(Ext.String.trim(a))){return true}else{return"Value cannot be empty"}}},{xtype:"textfield",name:"smUUID",readOnly:true,fieldLabel:"UUID",hidden:true}]}];this.dockedItems=[{xtype:"toolbar",dock:"bottom",id:"buttons",ui:"footer",items:["->",{iconCls:"icon-save",text:_SM.__language.Text_Save_Button,action:"save"},{iconCls:"icon-reset",text:_SM.__language.Text_Cancel_Button,scope:this,handler:this.close}]}];this.callParent(arguments)}});Ext.define("ProtoUL.view.searchmodel.LiveSearchGridPanel",{extend:"Ext.grid.Panel",alias:"widget.livesearchgrid",requires:["Ext.toolbar.TextItem","Ext.form.field.Checkbox","Ext.form.field.Text"],itemId:"livesearchgrid",searchValue:null,indexes:[],currentIndex:null,searchRegExp:null,caseSensitive:false,regExpMode:false,matchCls:"x-livesearch-match",defaultStatusText:"Nothing Found",initComponent:function(){var a=this;a.tbar=["Search",{xtype:"textfield",name:"searchField",hideLabel:true,width:200,listeners:{change:{fn:a.onTextFieldChange,scope:this,buffer:100}}},{xtype:"button",text:"<",tooltip:"Find Previous Row",handler:a.onPreviousClick,scope:a},{xtype:"button",text:">",tooltip:"Find Next Row",handler:a.onNextClick,scope:a},"-",{xtype:"checkbox",hideLabel:true,margin:"0 0 0 4px",handler:a.regExpToggle,scope:a},"Regular expression",{xtype:"checkbox",hideLabel:true,margin:"0 0 0 4px",handler:a.caseSensitiveToggle,scope:a},"Case sensitive"];a.bbar={xtype:"searchgridbbar"};a.callParent(arguments)},afterRender:function(){var a=this;a.callParent(arguments);a.textField=a.down("textfield[name=searchField]");a.statusBar=Ext.ComponentQuery.query("#bbarDefaultText")[0];a.statusBar.setText(a.defaultStatusText)},tagsRe:/<[^>]*>/gm,tagsProtect:"\x0f",regExpProtect:/\\|\/|\+|\\|\.|\[|\]|\{|\}|\?|\$|\*|\^|\|/gm,getSearchValue:function(){var f=this,h=f.textField.getValue();if(h===""){return null}if(!f.regExpMode){h=h.replace(f.regExpProtect,function(c){return"\\"+c})}else{try{new RegExp(h)}catch(a){f.statusBar.setText(a.message);return null}if(h==="^"||h==="$"){return null}}var d=h.length,g=[f.tagsProtect+"*"],b=0,j;for(;b<d;b++){j=h.charAt(b);g.push(j);if(j!=="\\"){g.push(f.tagsProtect+"*")}}return g.join("")},onTextFieldChange:function(){var b=this,a=0;b.view.refresh();b.statusBar.setText(b.defaultStatusText);b.searchValue=b.getSearchValue();b.indexes=[];b.currentIndex=null;if(b.searchValue!==null){b.searchRegExp=new RegExp(b.searchValue,"g"+(b.caseSensitive?"":"i"));b.store.each(function(f,d){var j=Ext.fly(b.view.getNode(d)).down("td"),c,h,g;while(j){c=j.down(".x-grid-cell-inner");h=c.dom.innerHTML.match(b.tagsRe);g=c.dom.innerHTML.replace(b.tagsRe,b.tagsProtect);g=g.replace(b.searchRegExp,function(k){a+=1;if(Ext.Array.indexOf(b.indexes,d)===-1){b.indexes.push(d)}if(b.currentIndex===null){b.currentIndex=d}return'<span class="'+b.matchCls+'">'+k+"</span>"});Ext.each(h,function(k){g=g.replace(b.tagsProtect,k)});c.dom.innerHTML=g;j=j.next()}},b);if(b.currentIndex!==null){b.getSelectionModel().select(b.currentIndex);b.statusBar.setText(a+" matche(s) found.")}}if(b.currentIndex===null){b.getSelectionModel().deselectAll()}b.textField.focus()},onPreviousClick:function(){var b=this,a;if((a=Ext.Array.indexOf(b.indexes,b.currentIndex))!==-1){b.currentIndex=b.indexes[a-1]||b.indexes[b.indexes.length-1];b.getSelectionModel().select(b.currentIndex)}},onNextClick:function(){var b=this,a;if((a=Ext.Array.indexOf(b.indexes,b.currentIndex))!==-1){b.currentIndex=b.indexes[a+1]||b.indexes[0];b.getSelectionModel().select(b.currentIndex)}},caseSensitiveToggle:function(b,a){this.caseSensitive=a;this.onTextFieldChange()},regExpToggle:function(b,a){this.regExpMode=a;this.onTextFieldChange()}});Ext.define("ProtoUL.view.searchmodel.SearchBottomBar",{extend:"Ext.toolbar.Toolbar",alias:"widget.searchgridbbar",items:[{xtype:"tbtext",text:"",itemId:"bbarDefaultText"},"->",{xtype:"button",text:"Add",itemId:"btAddTableFromSearchBar",iconCls:"icon-add"},{xtype:"button",text:"Cancel",itemId:"btCancelSearchBar",iconCls:"icon-close"}]});Ext.define("ProtoUL.controller.PasswordManager",{extend:"Ext.app.Controller",views:["password.PasswordReset","password.ForgotPasswordForm"],init:function(){this.control({"passwordForm button[action=changepassword]":{click:this.changepassword},"forgotPasswordForm button[action=forgotpassword]":{click:this.forgotpassword},})},changepassword:function(a){var b=a.up("form").getForm();if(b.isValid()){a.setIconCls("st-loading");b.submit({url:_SM._PConfig.urlSubmitChangePassword,method:"POST",scope:this,success:function(c,d){Ext.Msg.alert("Success",_SM.__language.Message_Success_Password_Change,function(f){if(f=="ok"){Ext.destroy(Ext.ComponentQuery.query("passwordForm"));Ext.Ajax.request({url:"protoExt",success:function(){window.location="protoExt"}})}})},failure:function(c,d){Ext.Msg.alert("Failed",d.result.message);a.setIconCls("st-key-go")}})}},forgotpassword:function(a){var c=a.up("window"),b=c.down("form").getForm();if(b.isValid()){a.setIconCls("st-loading");b.submit({url:_SM._PConfig.urlGetPasswordRecovery,method:"POST",scope:this,success:function(d,f){Ext.Msg.alert(_SM.__language.Message_Success,_SM.__language.Message_Email_Forgotten_Password,function(g){if(g=="ok"){Ext.destroy(Ext.ComponentQuery.query("forgotPasswordForm"))}});a.setIconCls("st-key-go")},failure:function(d,f){Ext.Msg.show({title:_SM.__language.Message_Error,msg:f.response.statusText,buttons:Ext.Msg.OK,icon:Ext.MessageBox.WARNING});a.setIconCls("st-key-go")}})}}});Ext.define("ProtoUL.controller.DiagramController",{extend:"Ext.app.Controller",stores:["PortPositions"],refs:[{ref:"diagramCanvas",selector:"#contentPanel"},{ref:"diagramToolbar",selector:"#diagramtoolbar"},{ref:"entityAttributes",selector:"#entityattributes"},{ref:"entityEditor",selector:"#entityeditor"},{ref:"diagramMainView",selector:"#diagramMainView"},{ref:"tableContextMenu",selector:"#tablecontextmenu"}],showProgressBar:function(b,a){Ext.MessageBox.show({msg:b,progressText:a,width:300,wait:true,waitConfig:{interval:200}})},updateJsonDocument:function(){var a=new draw2d.io.json.Writer();a.marshal(this.getDiagramCanvas().getView(),function(b){jsonDocument=b})},undoAction:function(b,c,a){this.getDiagramCanvas().getView().getCommandStack().undo()},redoAction:function(b,c,a){this.getDiagramCanvas().getView().getCommandStack().redo()},getAttributeFromTagetTable:function(a){var b=null;a.targetPort.getParent().getChildren().each(function(d,c){if(a.id===c.id){b=c}});return b},deleteObject:function(f,g,h){var b=this.getDiagramCanvas().getView().getCurrentSelection();if(b.targetPort){var a=this.getAttributeFromTagetTable(b);b.targetPort.getParent().removeFigure(a);this.getDiagramCanvas().getView().removeFigure(b)}else{var d=new draw2d.command.CommandDelete(b);this.getDiagramCanvas().getView().getCommandStack().execute(d)}var j=this.getEntityAttributes();var c=this.getEntityEditor();var k=c.getComponent("protoProperty");j.hide();k.setSource(null)},zoomIn:function(b,c,a){this.getDiagramCanvas().getView().setZoom(this.getDiagramCanvas().getView().getZoom()*0.7,true)},zoomNormal:function(b,c,a){this.getDiagramCanvas().getView().setZoom(1,true)},zoomOut:function(b,c,a){this.getDiagramCanvas().getView().setZoom(this.getDiagramCanvas().getView().getZoom()*1.3,true)},enableToolbarButton:function(b){var a=this.getDiagramToolbar().getComponent(b);a.setDisabled(false)},createEntityAttribute:function(d,f,b,c,a){return Ext.create("ProtoUL.model.EntityAttributesModel",{text:d,id:f,inputPort:"",datatype:"string",unique:false,pk:b,fk:c,isRequired:false,isNullable:false})},createAjaxRequest:function(b,g,d,c,a,f){Ext.Ajax.request({url:b,method:g,params:d,jsonData:c,success:a,failure:f})},addAttribute:function(c,g,b){var f=this.getEntityEditor();var a=this.getEntityAttributes();a.rowEditing.cancelEdit();var d=this.createEntityAttribute("new attribute"+a.getStore().data.length,draw2d.util.UUID.create(),false,false,"string");a.getStore().insert(a.getStore().data.length,d);f.figure.addAttribute(0,d);f.figure.setDimension(1,1)},deleteAttribute:function(f,h,d){var b=this.getEntityAttributes();var j=b.getSelectionModel();var g=j.getSelection()[0];var a=b.ownerCt.figure;if(g.data.fk){var c=this.getDiagramCanvas().getView();a.getConnections().each(function(l,k){if(g.data.id===k.id){c.removeFigure(k)}})}b.rowEditing.cancelEdit();b.getStore().remove(j.getSelection());if(b.getStore().getCount()>0){j.select(0)}a.getChildren().each(function(l,k){if(g.data.id===k.id){a.removeFigure(k)}})},addOrUpdateJSONDocument:function(c){var a=true;for(var b=0;b<jsonDocument.length;b++){if(jsonDocument[b].id===c.id){jsonDocument[b]=c;a=false}}if(a){jsonDocument.push(c)}},saveTable:function(h,j,k){var f=this.getEntityEditor();var b=f.getComponent("protoProperty").source;var a=this.getEntityAttributes().getStore();if(typeof b.attributes!=="undefined"){var d=this.getEntityAttributes().getSelectionModel();var c=d.getSelection()[0];if(c){if(c.data.fk){f.figure.getConnections().each(function(m,l){if(c.data.id===l.id){var n=l.getPersistentAttributes();n.name=c.data.text;n.userData.isPrimary=c.data.pk;l.setPersistentAttributes(n)}})}}b.attributes.splice(0,b.attributes.length);a.each(function(l){b.attributes.push(l.data)});for(var g=f.figure.attributes.size-1;g>=0;g--){f.figure.removeFigure(f.figure.attributes.get(g))}f.figure.setColor(b.color);f.figure.setAlpha(b.alpha);f.figure.updateHeader(b);f.figure.updateAttributes(b);f.figure.setDimension(1,1)}else{if(typeof b.router!=="undefined"){b.userData.isPrimary=b.isPrimary;var c=this.getAttributeFromTagetTable(f.figure);c.pk=b.isPrimary;c.setText(b.name);c.setBold(c.pk);if(c.pk){c.setCssClass("primary_key")}else{c.setCssClass("draw2d_shape_basic_Label")}f.figure.setPersistentAttributes(b)}}},saveDiagram:function(c,d,b){this.showProgressBar(_SM.__language.Message_Saving_Data,_SM.__language.Text_Submit_Validation_Form);this.updateJsonDocument();var a=this;params={projectID:a.getDiagramMainView().getProjectID(),diagramID:a.getDiagramMainView().getDiagramID()};successFunction=function(f){setTimeout(function(){Ext.MessageBox.close()},1000)};failureFunction=function(f){Ext.MessageBox.close();console.log("Failure: saveDiagram")};this.createAjaxRequest(_SM._PConfig.saveDiagram,"POST",params,Ext.JSON.encode(jsonDocument),successFunction,failureFunction);this.enableToolbarButton("btSyncToDB")},updateJSONFromData:function(a,b){if(b.type==="dbModel.shape.DBTable"){jsonDocument[a].tableName=b.tableName;jsonDocument[a].attributes=b.attributes}},synchronizeJSONDocument:function(b){for(var a=0;a<jsonDocument.length;a++){if(jsonDocument[a].id===b.id){this.updateJSONFromData(a,b)}}},synchDBFromDiagram:function(c,d,b){var a=this;a.showProgressBar(_SM.__language.Message_Creating_Objects,_SM.__language.Text_Submit_Validation_Form);params={projectID:a.getDiagramMainView().getProjectID()};successFunction=function(f){var j=f.responseText;var h=Ext.JSON.decode(j);for(var g=0;g<h.tables.length;g+=1){a.synchronizeJSONDocument(h.tables[g])}a.getDiagramCanvas().reload();a.updateJsonDocument();Ext.MessageBox.close()};failureFunction=function(f){Ext.MessageBox.close();console.log("Failure: synchDBFromDiagram")};this.createAjaxRequest(_SM._PConfig.synchDBFromDiagram,"POST",params,jsonDocument,successFunction,failureFunction);c.setDisabled(true)},runAjaxOpenDiagram:function(c,d,b,a){Ext.Ajax.request({url:d,method:"GET",params:{projectID:b,diagramID:a},success:function(f){var h=f.responseText;var g=Ext.JSON.decode(h);if(g.diagram==="{}"){jsonDocument=[]}else{jsonDocument=Ext.JSON.decode(g.diagram).objects}c.getDiagramMainView().setTitle(_SM.__language.Title_Work_Diagram+g.diagramCode);c.getDiagramMainView().setDiagramID(g.diagramID);c.getDiagramCanvas().reload()},failure:function(f){console.log("Failure: openDiagram")}})},openDiagram:function(f,g,d){var c=this;var b=c.getDiagramMainView().getProjectID();var a=c.getDiagramMainView().getDiagramID();if(a===null){c.runAjaxOpenDiagram(c,_SM._PConfig.getDefaultDiagram,b,null)}else{c.runAjaxOpenDiagram(c,_SM._PConfig.openDiagram,b,a)}},exportDiagramToPNG:function updatePreview(){var b=this.getDiagramCanvas().getView();var l=[],h=[];b.getFigures().each(function(n,o){var m=o.getBoundingBox();l.push(m.x,m.x+m.w);h.push(m.y,m.y+m.h)});var g=0,c=0;var a=Math.max.apply(Math,l)-g;var k=Math.max.apply(Math,h)-c;var f=new draw2d.io.png.Writer();var d=null;f.marshal(b,function(m){d=m},new draw2d.geo.Rectangle(g,c,a,k));var j=window.open("","","width=800,height=600");j.document.write("<html><head>");j.document.write("<title>Print diagram</title>");j.document.write('<link rel="Stylesheet" type="text/css" href="http://dev.sencha.com/deploy/ext-4.0.1/resources/css/ext-all.css" />');j.document.write('<script type="text/javascript" src="http://dev.sencha.com/deploy/ext-4.0.1/bootstrap.js"><\/script>');j.document.write("</head><body>");j.document.write('<img class="shadow" src='+d+' id="preview" style="border-radius:1px;overflow:auto; top:10px; right:10px; border:0px solid gray;"/>');j.document.write("</body></html>");j.print()},hidePropertyGridAttributes:function(a){a.getView().getRowClass=function(c,b){if(c.data.name!=="isPrimary"&&c.data.name!=="name"&&c.data.name!=="tableName"&&c.data.name!=="color"&&c.data.name!=="alpha"){return"hide-this-row"}else{return""}}},onSelectionChanged:function(b){var c=this;if(b!==null){var a=c.getEntityAttributes();var f=c.getEntityEditor();var d=f.getComponent("protoProperty");f.figure=b;var g=b.getPersistentAttributes();if(b.cssClass==="dbModel_shape_DBTable"||b.cssClass==="DBTable"){a.show();if(typeof g!=="undefined"){d.setSource(g);c.hidePropertyGridAttributes(d);a.getStore().loadRawData(g.attributes)}}else{a.hide();g.isPrimary=g.userData.isPrimary;if(typeof g!=="undefined"){d.setSource(g);c.hidePropertyGridAttributes(d)}}}},onDropConnection:function(c,b){var g=this;g.onSelectionChanged(b);if(c!==null){var a=g.getEntityAttributes();var h=g.getEntityEditor();a.rowEditing.cancelEdit();var f=this.createEntityAttribute(c.getConnectionName(),c.getId(),false,true,"string");a.getStore().insert(a.getStore().data.length,f);var d=h.figure.addAttribute(0,f.data);d.setId(f.data.id);d.datatype=f.data.datatype;d.pk=f.data.pk;d.fk=f.data.fk;d.isRequired=f.data.isRequired;d.isNullable=f.data.isNullable;h.figure.setDimension(1,1)}},init:function(a){this.control({"#btUndo":{click:this.undoAction},"#btRedo":{click:this.redoAction},"#btDelete":{click:this.deleteObject},"#btZoomIn":{click:this.zoomIn},"#btZoomNormal":{click:this.zoomNormal},"#btZoomOut":{click:this.zoomOut},"#btSaveDiagram":{click:this.saveDiagram},"#btSyncToDB":{click:this.synchDBFromDiagram},"#btExportDiagram":{click:this.exportDiagramToPNG},"#btAddAttribute":{click:this.addAttribute},"#btDeleteAttribute":{click:this.deleteAttribute},"#btSaveTable":{click:this.saveTable},panel:{opendiagram:this.openDiagram}})}});Ext.define("ProtoUL.controller.DiagramMenuController",{extend:"Ext.app.Controller",stores:["Diagrams"],models:["Diagram"],views:["diagram.base.Form","diagram.base.Grid"],refs:[{ref:"diagramCanvas",selector:"#contentPanel"},{ref:"diagramToolbar",selector:"#diagramtoolbar"},{ref:"diagramMainView",selector:"#diagramMainView"},{ref:"liveGridSearch",selector:"#livesearchgrid"},{ref:"diagramForm",selector:"#diagramform"},{ref:"diagramGrid",selector:"#diagramgrid"}],updateJsonDocument:function(){var a=new draw2d.io.json.Writer();a.marshal(this.getDiagramCanvas().getView(),function(b){jsonDocument=b})},updateJSONFromData:function(a,b){if(b.type==="dbModel.shape.DBTable"){jsonDocument[a].tableName=b.tableName;jsonDocument[a].attributes=b.attributes;jsonDocument[a].tablePorts=b.tablePorts}else{jsonDocument[a].name=b.name;jsonDocument[a].source=b.source;jsonDocument[a].target=b.target}},addOrUpdateJSONDocument:function(j){var d=this.getDiagramCanvas().getView();if(j.type==="dbModel.shape.DBTable"){var h=d.getFigure(j.id);if(h){d.removeFigure(h)}h=new dbModel.shape.DBTable();h.setPersistentAttributes(j);h.addContextMenuListener(this.getDiagramCanvas());h.addOnDropConnectionListener(this.application.controllers.get("DiagramController"));d.addFigure(h)}else{var b=d.getFigure(j.id);if(!b){b=new dbModel.shape.TableConnection();b.setPersistentAttributes(j);var c=d.getFigure(j.source.node);var g=d.getFigure(j.target.node);if(c&&g){var a=c.getPort(j.source.port);if(!a){a=c.createCustomizedPort("draw2d_OutputPort",j.source.port,"right")}var f=g.getPort(j.target.port);if(!f){f=g.createCustomizedPort("draw2d_InputPort",j.target.port,"left")}b.setSource(a);b.setTarget(f);b._routingMetaData.routedByUserInteraction=false;d.addFigure(b)}}}},synchronizeJSONDocument:function(b){for(var a=0;a<jsonDocument.length;a++){if(jsonDocument[a].id===b.id){this.updateJSONFromData(a,b)}}},enableToolbarButton:function(b){var a=this.getDiagramToolbar().getComponent(b);a.setDisabled(false)},getAllTablesFromDB:function(){var b=this;var a=b.getDiagramMainView().getProjectID();Ext.Ajax.request({url:_SM._PConfig.urlGetEntitiesJSONDiagram,params:{projectID:a},success:function(g){var l=g.responseText;var h=Ext.JSON.decode(l);var f=Ext.create("ProtoUL.store.DiagramModelStore",{data:h.tables});var k=h.tables.length+" item(s) found";var j=new Ext.Window({width:540,height:300,layout:"fit",items:{xtype:"livesearchgrid",store:f,selModel:Ext.create("Ext.selection.CheckboxModel"),columns:[{text:"Table",flex:1,dataIndex:"tableName",sortable:true}],width:540,height:200}});var d=j.down("grid");d.getView().getRowClass=function(n,r,q,o){b=ProtoUL.app.getController("DiagramController");var p=b.getDiagramCanvas().getView();var m=p.getFigure(n.internalId);if(m){return"table-in-diagram"}return""};var c=d.query("#bbarDefaultText")[0];j.show();c.setText(k)}})},syncDiagramFromDB:function(){var b=this;var a=b.getDiagramMainView().getProjectID();function c(d){if(d==="yes"){Ext.Ajax.request({url:_SM._PConfig.synchDiagramFromDB,params:{projectID:a},success:function(f){var j=f.responseText;var h=Ext.JSON.decode(j);for(var g=0;g<h.tables.length;g+=1){b.synchronizeJSONDocument(h.tables[g])}for(var g=0;g<h.connectors.length;g+=1){b.synchronizeJSONDocument(h.connectors[g])}b.getDiagramCanvas().reload();b.updateJsonDocument();Ext.Msg.alert("Success",_SM.__language.Message_Diagram_Synchronized)},failure:function(f){Ext.Msg.alert("Failure",_SM.__language.Message_Error_Diagram_Synchronized)}})}}Ext.MessageBox.confirm("Confirmation",_SM.__language.Msg_Confirm_Delete_Operation+" les configurations personnalisées seront perdues!",c)},menuManageDiagram:function(){var b=this;var a=b.getDiagramMainView().getProjectID();var c=new Ext.data.Operation({action:"read",params:{projectID:a}});var f=Ext.create("Ext.window.Window",{width:500,title:_SM.__language.Title_Diagrams,layout:"fit",items:{xtype:"diagramgrid",}});var d=f.down();d.getStore().load(c);f.show()},onSearchMenuClick:function(g,d,f,c){var b=this;var a=b.getDiagramMainView().getProjectID();switch(d.itemId){case"getAllTables":b.getAllTablesFromDB();break;case"syncDiagramFromDB":b.syncDiagramFromDB();break;case"menuManageDiagram":b.menuManageDiagram();break;default:alert("Function to be implementated in future versions!");break}},closeSearchBar:function(b,c,a){Ext.destroy(this.getLiveGridSearch().ownerCt)},addTableFromSearchGrid:function(d,g,h){var f=this;var a=this.getLiveGridSearch();var k=a.getSelectionModel().getSelection();var b=f.application.controllers.get("DiagramController");b.showProgressBar(_SM.__language.Message_Add_Table_Canvas,"Processing...");var j=[];for(var c=0;c<k.length;c+=1){j.push(k[c].data)}Ext.Ajax.request({url:_SM._PConfig.getElementsDiagramFromSelectedTables,jsonData:j,success:function(l){var o=l.responseText;var n=Ext.JSON.decode(o);for(var m=0;m<n.tables.length;m+=1){f.addOrUpdateJSONDocument(n.tables[m])}for(var m=0;m<n.connectors.length;m+=1){f.addOrUpdateJSONDocument(n.connectors[m])}Ext.MessageBox.close()},failure:function(l){Ext.MessageBox.close();Ext.Msg.alert("Failure","Failed to get tables from database, please try again later!")}})},editDiagram:function(b,a){var c=Ext.create("ProtoUL.view.diagram.base.Form").show();if(a.id){c.down("form").loadRecord(a)}},updateDiagram:function(c){var d=this;var l=d.getDiagramMainView().getProjectID();var b=new Ext.data.Operation({action:"read",params:{projectID:l}});var g=c.up("window"),a=g.down("form"),f=a.getRecord(),k=a.getValues();var h=false;if(a.getForm().isValid()){if(k.id>0){f.set(k)}else{f=Ext.create("ProtoUL.model.Diagram");k.projectID=l;f.set(k);d.getDiagramsStore().add(f);h=true}var j=d.getDiagramsStore();j.sync({success:function(n,m){d.getDiagramsStore().load(b);g.close()},failure:function(n,m){Ext.Msg.alert("Error","Failed to create diagram")},scope:this});if(h){d.getDiagramsStore().load(b)}}},deleteDiagram:function(h){var c=this;var b=c.getDiagramMainView().getProjectID();var f=new Ext.data.Operation({action:"read",params:{projectID:b}});var g=c.getDiagramGrid(),a=g.getSelectionModel().getSelection(),d=c.getDiagramsStore();var j=c.getDiagramMainView().getDiagramID();if(j!==a[0].data.id){d.remove(a);d.sync({success:function(l,k){c.getDiagramsStore().load(f)},failure:function(l,k){Ext.Msg.alert("Failed",l.proxy.getReader().jsonData.message)},scope:this});d.load(f)}else{Ext.Msg.alert("Warning",_SM.__language.Warning_Delete_Active_Diagram)}},openSelectedDiagram:function(f,b){var g=this;var k=g.getDiagramMainView().getProjectID();var a=f.up("grid[itemId=diagramgrid]");var h=a.getSelectionModel().getSelection();var j=h[0].data.id;var c=g.getDiagramMainView().getDiagramID();var d=g.application.controllers.get("DiagramController");if(c!==j){d.runAjaxOpenDiagram(g,_SM._PConfig.openDiagram,k,j)}else{Ext.Msg.alert("Warning",_SM.__language.Warning_Diagram_Already_Open)}},init:function(a){this.control({"#DatabaseMenu":{click:this.onSearchMenuClick},"#btCancelSearchBar":{click:this.closeSearchBar},"#btAddTableFromSearchBar":{click:this.addTableFromSearchGrid},"diagramgrid dataview":{itemdblclick:this.editDiagram},"diagramgrid button[action=add]":{click:this.editDiagram},"diagramgrid button[action=delete]":{click:this.deleteDiagram},"diagramgrid button[action=openselecteddiagram]":{click:this.openSelectedDiagram},"diagramform button[action=save]":{click:this.updateDiagram}})}});Ext.define("ProtoUL.controller.DiagramContextMenuController",{extend:"Ext.app.Controller",refs:[{ref:"diagramCanvas",selector:"#contentPanel"},{ref:"tableContextMenu",selector:"#tablecontextmenu"}],getTableFromContextMenu:function(b){var a=b.ownerCt;var c;if(a.figure.getParent().getCssClass()==="draw2d_shape_layout_VerticalLayout"){c=a.figure.getParent().getParent()}else{c=a.figure.getParent()}a.close();return c},createPort:function(d,c){var b=null;switch(d){case"draw2d_InputPort":b=new draw2d.InputPort();break;case"draw2d_OutputPort":b=new draw2d.OutputPort();break;case"draw2d_HybridPort":b=new draw2d.HybridPort();break;default:throw"Unknown type ["+d+"] of port requested"}var a=[];a.push({position:c});b.setUserData(a);return b},addConnectorRecursive:function(d,j,c){var g=this.getTableFromContextMenu(d);if(g.hybridPorts.getSize()===0){var a=this.createPort("draw2d_HybridPort","bottom");a.setName("hybrid"+g.hybridPorts.getSize());g.addPort(a,new draw2d.layout.locator.BottomLocator(g));var b=this.createPort("draw2d_InputPort","left");b.setName("input"+g.inputPorts.getSize());g.addPort(b,new dbModel.locator.PortLeftLocator(g));g.layoutPorts();var f=new dbModel.shape.TableConnection();f.setSource(a);f.setTarget(b);var h=this.application.controllers.get("DiagramController");h.onDropConnection(f,g);g.getCanvas().addFigure(f);this.application.controllers.get("DiagramController").enableToolbarButton("btSaveDiagram")}},addInputPort:function(d,h,c){var f=this.getTableFromContextMenu(d);var g=this.application.controllers.get("DiagramController");var a=Ext.create("ProtoUL.store.PortPositions");var b={label:"Position du port",store:a,userData:{controller:g,table:f}};_SM.ComboBoxPrompt.prompt("Nouveau port",b,function(k,l,j){if(k=="ok"){controller=j.userData.controller;f=j.userData.table;name="input"+f.inputPorts.getSize();f.createCustomizedPort("draw2d_InputPort",name,l);controller.enableToolbarButton("btSaveDiagram")}})},addOutputPort:function(d,h,c){var f=this.getTableFromContextMenu(d);var g=this.application.controllers.get("DiagramController");var a=Ext.create("ProtoUL.store.PortPositions");var b={label:"Position du port",store:a,userData:{controller:g,table:f}};_SM.ComboBoxPrompt.prompt("Nouveau port",b,function(k,l,j){if(k=="ok"){controller=j.userData.controller;f=j.userData.table;name="output"+f.outputPorts.getSize();f.createCustomizedPort("draw2d_OutputPort",name,l);controller.enableToolbarButton("btSaveDiagram")}})},removeUnusedPorts:function(b,d,a){var c=this.getTableFromContextMenu(b);c.getPorts().each(function(g,f){if(f.getConnections().size<1){c.removePort(f)}});c.layoutPorts();c.cachedPorts=null;this.application.controllers.get("DiagramController").enableToolbarButton("btSaveDiagram")},init:function(a){this.control({"#btAddConnectorRecursive":{click:this.addConnectorRecursive},"#btAddInputPort":{click:this.addInputPort},"#btAddOutputPort":{click:this.addOutputPort},"#btRemoveUnusedPorts":{click:this.removeUnusedPorts}})}});Ext.define("ProtoUL.Application",{name:"ProtoUL",extend:"Ext.app.Application",paths:{ProtoUL:"static/js"},requires:["Ext.window.MessageBox","Ext.toolbar.Paging","Ext.layout.container.Border","Ext.util.Cookies","Ext.Ajax","ProtoUL.view.MenuTree","ProtoUL.view.ProtoTabContainer","ProtoUL.view.Viewport","ProtoUL.view.password.PasswordReset","ProtoUL.ux.Printer","ProtoUL.ux.GridHeaderToolTip","ProtoUL.ux.CheckColumn"],models:["EntityAttributesModel"],stores:["EntityAttributeStore","DBTypesStore","DiagramModelStore"],views:["diagram.DiagramMainView","diagram.DiagramMenu","diagram.DiagramCanvas","diagram.DiagramToolbar","diagram.EntityEditor","diagram.EntityAttributes","diagram.TableContextMenu","diagram.DatabaseMenu","searchmodel.LiveSearchGridPanel","searchmodel.SearchBottomBar","ComboBoxPrompt"],controllers:["PasswordManager","DiagramController","DiagramMenuController","DiagramContextMenuController"],});Ext.Loader.setConfig({enabled:true,paths:{ProtoUL:"static/js"}});Ext.application({name:"ProtoUL",appFolder:"static/js",paths:{ProtoUL:"static/js"},extend:"ProtoUL.Application",launch:function(){Ext.QuickTips.init();if(window.isPasswordReseted==="True"){this.showResetPasswordForm()}else{this.showLogin()}},showLogin:function(){var b=this;var a={scope:b,success:function(g,d,f){c.hide();Ext.grid.RowEditor.prototype.saveBtnText=_SM.__language.Text_Save_Button;Ext.grid.RowEditor.prototype.cancelBtnText=_SM.__language.Text_Cancel_Button;var h=new ProtoUL.view.Viewport();Ext.destroy(Ext.ComponentQuery.query("protoLogin"))}};var c=Ext.widget("window",{constrain:true,iconCls:"st-user-who",title:_SM.loginTitle,layout:"fit",width:450,height:135,modal:true,items:[{xtype:"protoLogin",options:a}]});c.show()},showResetPasswordForm:function(){var a=Ext.create("ProtoUL.view.password.PasswordReset");a.show()}});Ext.Ajax.on("beforerequest",function(b,a){if(typeof(a.headers)=="undefined"){a.headers={"X-CSRFToken":Ext.util.Cookies.get("csrftoken")}}else{a.headers.extend({"X-CSRFToken":Ext.util.Cookies.get("csrftoken")})}},this);